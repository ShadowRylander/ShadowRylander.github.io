<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://alhassy.github.io/rss.xml"
      title="RSS feed for https://alhassy.github.io/"/>
<title>Life and Computing Science</title>
<meta name="author" content="Musa Al-hassy">
<meta name="referrer" content="no-referrer">
<link href="usual-org-front-matter.css" rel="stylesheet" type="text/css" />
<link href="https://alhassy.github.io/next-700-module-systems/prototype/org-notes-style.css" rel="stylesheet" type="text/css" />
<link rel="icon" href="images/favicon.png">


<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>

</head>
<body>
<div id="preamble" class="status"><div class="header">
  <a href="https://alhassy.github.io/">Life and Computing Science</a>
</div>
</div>
<div id="content">
<h1 class="title">Posts tagged "program-proving":</h1>
<div class="post-date">21 Aug 2019</div><h1 class="post-title"><div class="title"><a href="https://alhassy.github.io/TypedLisp.html">Typed Lisp, A Primer</a></h1></div>
<center> <img src="images/emacs-birthday-present.png" alt="Article image" width="350" height="350" align="top" /> </center><br><center><strong>Abstract</strong></center>
<nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#inconsistent-love">“Loving Haskell &amp; Lisp is Inconsistent”</a></li>
<li><a href="#terse-types-tutorial">Why Bother with Types? A Terse Tutorial on Type Systems</a>
<ul>
<li><a href="#type-checking">Obtaining &amp; Checking Types</a></li>
<li><a href="#lisp-is-eval">Statics &amp; Dynamics of Lisp</a></li>
<li><a href="#lisp-is-dynamic">Variable Scope</a></li>
<li><a href="#lisp-is-strong">Casts &amp; Coercions</a></li>
<li><a href="#type-annotations">Type Annotations</a></li>
<li><a href="#typecase">Type-directed Computations</a></li>
<li><a href="#type-specifiers">Type Specifiers: On the nature of types in Lisp</a></li>
<li><a href="#deftype">Making New Types with <code>deftype</code></a></li>
<li><a href="#adts">Algebraic Data Types a la Haskell</a></li>
</ul>
</li>
<li><a href="#why-dynamic">In Defence of Being Dynamically Checked</a></li>
<li><a href="#lisp-funny-history">With its hierarchy of types, why isn't Lisp statically typed?</a></li>
<li><a href="#lisp-is-typed">Lisp Actually Admits Static Typing!</a></li>
<li><a href="#elisp-types">ELisp's Type Hierarchy</a>
<ul>
<li><a href="#Number">Number</a></li>
<li><a href="#Character">Character</a></li>
<li><a href="#Symbol">Symbol</a></li>
<li><a href="#Sequence">Sequence</a></li>
<li><a href="#Function">Function</a></li>
<li><a href="#Macro">Macro</a></li>
<li><a href="#Record">Record</a></li>
</ul>
</li>
<li><a href="#typing-via-macros">Typing via Macros &amp; Advice</a></li>
<li><a href="#Closing">Closing</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>
</nav>

<p>
Let's explore Lisp's fine-grained type hierarchy!
</p>

<p>
We begin with a shallow comparison to Haskell, a rapid tour of type theory,
try in vain to defend dynamic approaches, give a somewhat humorous account of history,
note that you've been bamboozled &#x2014;type's have always been there&#x2014;,
then go into technical details of some Lisp types, and finally conclude by showing
how <i>macros permit typing</i>.
</p>

<p>
Goals for this article:
</p>

<ol class="org-ol">
<li>Multiple examples of type constructions in Lisp.</li>
<li>Comparing Lisp type systems with modern languages, such as Haskell.</li>
<li>Show how algebraic <a href="#org895d364">polymorphic</a> types like <code>Pair</code> and <code>Maybe</code> can be defined in Lisp.
Including heterogeneously typed lists!</li>
<li>Convey a passion for an elegant language.</li>
<li>Augment Lisp with functional Haskell-like type declarations ;-)</li>
</ol>

<p>
Unless suggested otherwise, the phrase “Lisp” refers to
<a href="https://www.gnu.org/software/emacs/manual/html_mono/cl.html#index-cl_002ddeftype-14">Common Lisp as supported by Emacs Lisp</a>. As such, the resulting discussion
is applicable to a number of Lisp dialects
&#x2014;I'm ignoring editing types such as buffers and keymaps, for now.
</p>

<small> <center>
<p>
( Original print by Baneen Al-hassy as a birthday present to me. )
</p>
</center> </small>
<style>

.figure-number {
    display: none;
}

.table-number {
    display: none;
}

/* Using source blocks “math” as aliaas for haskell */
pre.src-math:before { content: 'Mathematical! Algebraic! Axiomatic!'; }
/* Execute this for alias: (add-to-list 'org-src-lang-modes '("math" . haskell)) */

</style>

<div id="outline-container-orgf1b689e" class="outline-2">
<h2 id="inconsistent-love">“Loving Haskell &amp; Lisp is Inconsistent”</h2>
<div class="outline-text-2" id="text-inconsistent-love">
<p>
I have convinced a number of my peers to use Emacs/Spacemacs/Doom-emacs,
but my efforts to get them to even consider trying Lisp have been met with
staunch rejection. These peers are familiar with Haskell, and almost all know Agda,
so you'd think they'd be willing to try Lisp &#x2014;it's there, part of their editor&#x2014;
but the superficial chasm in terms of syntax and types is more than enough apparently.
In this article, I aim to explore the type system of (Emacs) Lisp and occasionally
make comparisons to Haskell. Perhaps in the end some of my Haskell peers would be
willing to try it out.
</p>


<figure>
<img src="https://imgs.xkcd.com/comics/lisp_cycles.png" alt="lisp_cycles.png">

<figcaption><span class="figure-number">Figure 1: </span>xkcd - Lisp is a language of timeless elegance</figcaption>
</figure>

<ul class="org-ul">
<li><p>
↯ I almost never use Haskell for any day-to-day dealings.
</p>

<p>
✓ The ideas expressed by its community are why I try
       to keep updated on the language.
</p></li>

<li><p>
↯ No one around me knows anything about Lisp,
but they dislike it due to the parens.
</p>

<p>
✓ I love it and use it for Emacs configuration and recently
       to prototype my PhD research.
</p></li>
<li>⇅ I love that I can express a complicated procedure compactly in both
by using zips, unzips, filters, and maps <code>(งಠ_ಠ)ง</code>
<ul class="org-ul">
<li><p>
Lately, in Lisp, I'll write a nested loop (gasp!)
then, for fun, try to make it a one-liner!
Sometimes, I actually think the loop formulation is clearer
and I leave it as a loop &#x2014;Breaking news: Two Haskell readers just died.
</p>


<figure>
<img src="https://i.stack.imgur.com/jvSOG.png" alt="jvSOG.png">

<figcaption><span class="figure-number">Figure 2: </span>From the awesome “Land of Lisp” book</figcaption>
</figure></li>
</ul></li>
</ul>

<ul class="org-ul">
<li><p>
<b>What I like and why:</b>
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Haskell</td>
<td class="org-left">⇒</td>
<td class="org-left">Executable category theory; compact &amp; eloquent</td>
</tr>

<tr>
<td class="org-left">Lisp</td>
<td class="org-left">⇒</td>
<td class="org-left">Extensible language; malleable, uniform, beautiful</td>
</tr>
</tbody>
</table></li>

<li><p>
<b>Documentation?</b>
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Haskell</td>
<td class="org-left">⇒</td>
<td class="org-left">Hoogle; can search by type alone!</td>
</tr>

<tr>
<td class="org-left">Emacs Lisp</td>
<td class="org-left">⇒</td>
<td class="org-left">Self-documenting; <code>M-x apropos</code></td>
</tr>
</tbody>
</table></li>

<li><p>
<b>How has using the language affected me?</b>
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Haskell</td>
<td class="org-left">I almost always think in-terms compoistionality, functors, &amp; currying</td>
</tr>

<tr>
<td class="org-left">Lisp</td>
<td class="org-left">Documentation strings, units tests, and metaprogramming are second nature</td>
</tr>
</tbody>
</table></li>
</ul>

<p>
It may not be entirely accurate to say that
Lisp's type system is more expressive than Haskell's
as it's orthogonal in many respects; although it is closer to that of <a href="https://liquid.kosmikus.org/01-intro.html#/what-is-liquid-haskell">Liquid Haskell</a>.
</p>
</div>
</div>

<div id="outline-container-org899fbbf" class="outline-2">
<h2 id="terse-types-tutorial">Why Bother with Types? A Terse Tutorial on Type Systems</h2>
<div class="outline-text-2" id="text-terse-types-tutorial">
<p>
<i>Types allow us to treat objects according a similar structure
or interface.</i>
Unlike Haskell and other statically typed systems, in Lisp we have
that types can overlap.
As such, here's our working definition.
</p>
<div class="org-center">
<p>
A <b>type</b> is a collection of possible objects.
</p>

<p>
To say “\(e\) has type \(τ\)” one writes \(e : τ\), or in Lisp: <code>(typep e 'τ)</code>.
</p>
</div>

<p>
Haskellers and others may append to this definition the following,
which we will not bother with:
<i>Type membership is determined by inspecting
syntactic structure and so is decidable.</i>
</p>

<blockquote>
<p>
✓ Typing is one of the simplest forms of “assertion-comments”:
Documenting a property of your code in a way that the machine can verify.
</p>

<p>
If you're gonna comment on what kind of thing you're working with, why not have the
comment checked by the machine.
</p>
</blockquote>

<table>
<caption class="t-above"><span class="table-number">Table 1:</span> Lisp's type hierarchy is a “complemented lattice” ♥‿♥</caption>

<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">Common types</td>
<td class="org-left"><code>integer, number, string, keyword, array, cons, list, vector, macro, function, atom</code></td>
</tr>

<tr>
<td class="org-left">Top</td>
<td class="org-left"><code>t</code> has everything as an element</td>
</tr>

<tr>
<td class="org-left">Unit</td>
<td class="org-left"><code>null</code> has one element named <code>nil</code></td>
</tr>

<tr>
<td class="org-left">Bottom</td>
<td class="org-left"><code>nil</code> has no elements at all</td>
</tr>

<tr>
<td class="org-left">Union</td>
<td class="org-left"><code>(or τ₀ τ₁ … τₙ)</code>  has elements any element in any type <code>τᵢ</code></td>
</tr>

<tr>
<td class="org-left">Intersection</td>
<td class="org-left"><code>(and τ₀ τ₁ … τₙ)</code> has elements that are in all the types <code>τᵢ</code></td>
</tr>

<tr>
<td class="org-left">Complement</td>
<td class="org-left"><code>(not τ)</code> has elements that are <i>not</i> of type <code>τ</code></td>
</tr>

<tr>
<td class="org-left">Enumeration</td>
<td class="org-left"><code>(member x₀ … xₙ)</code> is the type consisting of only the elements <code>xᵢ</code></td>
</tr>

<tr>
<td class="org-left">Singleton</td>
<td class="org-left"><code>(eql x)</code> is the type with only the element <code>x</code></td>
</tr>

<tr>
<td class="org-left">Comprehension</td>
<td class="org-left"><code>(satisfies p)</code> is the type of values that satisfy predicate <code>p</code></td>
</tr>
</tbody>
</table>

<p>
Let's see some examples:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">The universal type &#8220;t&#8221;, has everything as its value.</span>
(<span style="color: #b58900;">typep</span> 'x '<span style="color: #268bd2;">t</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> 12 '<span style="color: #268bd2;">t</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">The empty type: nil</span>
(<span style="color: #b58900;">typep</span> 'x 'nil) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false; nil has no values.</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">The type &#8220;null&#8221; contains the one value &#8220;nil&#8221;.</span>
(<span style="color: #b58900;">typep</span> nil '<span style="color: #b58900;">null</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> () '<span style="color: #b58900;">null</span>)  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8220;(eql x)&#8221; is the singelton type consisting of only x.</span>
(<span style="color: #b58900;">typep</span> 3 '(<span style="color: #b58900;">eql</span> 3)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> 4 '(<span style="color: #b58900;">eql</span> 3)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8220;(member x&#8320; &#8230; x&#8345;)&#8221; denotes the enumerated type consisting of only the x&#7522;.</span>
(<span style="color: #b58900;">typep</span> 3 '(<span style="color: #b58900;">member</span> 3 x <span style="color: #2aa198;">"c"</span>))  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> 'x '(<span style="color: #b58900;">member</span> 3 x <span style="color: #2aa198;">"c"</span>)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> 'y '(<span style="color: #b58900;">member</span> 3 x <span style="color: #2aa198;">"c"</span>)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8220;(satisfies p)&#8221; is the type of values that satisfy predicate p.</span>
(<span style="color: #b58900;">typep</span> 12 '(satisfies (<span style="color: #859900; font-weight: bold;">lambda</span> (x) (<span style="color: #b58900;">oddp</span> x)))) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
(<span style="color: #b58900;">typep</span> 12 '(satisfies <span style="color: #b58900;">evenp</span>) )                <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Computation rule for comprehension types.</span>
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">(typep x '(satisfies p)) &#8776; (if (p x) t nil)</span>
</pre>
</div>

<p>
Here's a convenient one: <code>(booleanp x) ≈ (typep x '(member t nil))</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">booleanp</span> 2)   <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
(<span style="color: #b58900;">booleanp</span> nil) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
</pre>
</div>

<p>
Strongly typed languages like Haskell allow only a number of the type formers listed
above. For example, Haskell does not allow unions but instead offers so-called sum
types. Moreover, unlike Haskell, Lisp is non-parametric:
We may pick a branch of computation according to the type of a value.
Such case analysis is available in languages such as C# &#x2014;c.f.,
<a href="https://blogs.msdn.microsoft.com/ericlippert/2010/09/16/is-is-as-or-is-as-is/">is is as or is as is</a>. Finally, it is important to realise that <code>cons</code> is a monomorphic
type
&#x2014;it just means an (arbitrary) element consisting of two parts called <code>car</code> and <code>cdr</code>&#x2014;
we show how to form a <a href="#org895d364">polymorphic</a> product type below.
</p>

<p>
We may ask for <i>the</i> ‘primitive type’ of an object;
which is the simplest built-in type that it belongs to,
such as integer, string, cons, symbol, record, subr, and a few others.
As such, <i>Lisp objects come with an intrinsic primitive type</i>;
e.g., <code>'(1 "2" 'three)</code> is a list and can only be treated as a value of
another type if an explicit coercion is used.
In Lisp, rather than variables, it is values that are associated with a type.
One may optionally declare the types of variables, like in OCaml.
</p>
<div class="org-center">
<p>
<i>Lisp (primitive) types are inferred!</i>
</p>

<p>
“Values have types, not variables.” &#x2014;Paul Graham, ANSI Common Lisp
</p>
</div>

<p>
Let's review some important features of type systems and how they manifest themselves
in Lisp.
</p>
</div>

<div id="outline-container-orge90e3e5" class="outline-3">
<h3 id="type-checking">Obtaining &amp; Checking Types</h3>
<div class="outline-text-3" id="text-type-checking">
<p>
The typing relationship “:” is usually deterministic in its second argument for
static languages: <code>e : τ  ∧  e : τ′  ⇒  τ ≈ τ′</code>. However this is not the case with
Lisp's <code>typep</code>.
</p>

<table>
<caption class="t-above"><span class="table-number">Table 2:</span> Where are the types &amp; <i>when</i> are they checked?</caption>

<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Style</th>
<th scope="col" class="org-left">Definition</th>
<th scope="col" class="org-left">Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Static</td>
<td class="org-left">Variables have a fixed type; compile time</td>
<td class="org-left">Haskell &amp; C#</td>
</tr>

<tr>
<td class="org-left">Dynamic</td>
<td class="org-left">Values have a fixed type; runtime</td>
<td class="org-left">Lisp &amp; Smalltalk</td>
</tr>
</tbody>
</table>

<p>
In some sense, dynamic languages make it easy to produce <a href="#org895d364">polymorphic</a> functions.
Ironically, the previous sentences is only meaningful if you acknowledge the importance
of types and type variables.
</p>

<p>
In Lisp, types are inferred and needn't be declared.
However, the declaration serves as a nice documentation to further readers ;-)
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">setq</span> ellew 314)
(<span style="color: #b58900;">type-of</span> ellew) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; integer</span>

(<span style="color: #859900; font-weight: bold;">setq</span> ellew <span style="color: #2aa198;">"oh my"</span>)
(<span style="color: #b58900;">type-of</span> ellew) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; string</span>
</pre>
</div>
<ul class="org-ul">
<li>The <code>type-of</code> function returns the type of a given object.</li>
<li>Re variables: Static ⇒ only values can change; dynamic ⇒ both values and types change.</li>
</ul>

<p>
We may check the type of an item using <code>typep</code>, whose second argument
is a “type specifiers”
 &#x2014;an expressions whose value denotes a type; e.g., the <code>or</code> expression below
 forms a ‘union type’.
</p>

<p>
There's also <code>check-type</code>: It's like <code>typep</code> but instead of yielding true or
false, it stays quiet in the former and signals a type error in the latter.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">check-type</span> 12 integer)               <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil, i.e., no error</span>
(<span style="color: #859900; font-weight: bold;">check-type</span> 12   (<span style="color: #859900; font-weight: bold;">or</span> symbol integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">nil; i.e., no error</span>
(<span style="color: #859900; font-weight: bold;">check-type</span> <span style="color: #2aa198;">"12"</span> (<span style="color: #859900; font-weight: bold;">or</span> symbol integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Crash: Type error!</span>
</pre>
</div>

<p>
In summary:
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>(equal τ (type-of e))</code></td>
<td class="org-left"><code>≈</code></td>
<td class="org-left"><code>(typep e τ)</code></td>
</tr>

<tr>
<td class="org-left"><code>(check-type e τ)</code></td>
<td class="org-left"><code>≈</code></td>
<td class="org-left"><code>(unless (typep e 'τ) (error "⋯"))</code></td>
</tr>
</tbody>
</table>

<p>
( Note: (<code>unless x y) ≈ (when (not x) y)</code> .)
</p>
</div>
</div>
<div id="outline-container-orga1c50a7" class="outline-3">
<h3 id="lisp-is-eval">Statics &amp; Dynamics of Lisp</h3>
<div class="outline-text-3" id="text-lisp-is-eval">
<blockquote>
<p>
Types are the central organising principle of the theory of programming languages.
Language features are manifestations of type structure.
The syntax of a language is governed by the constructs that define its types, and
its semantics is determined by the interactions among those constructs.
</p>

<p>
&#x2014; Robert Harper, Practical Foundations for Programming Languages
</p>
</blockquote>

<p>
Besides atoms like numbers and strings,
the only way to form new terms in Lisp is using “modus ponens”,
or “function application”. Here's a first approximation:
</p>
<div class="org-src-container">
<pre class="src src-math">f : τ₁ → ⋯ → τₙ → τ   e₁ : τ₁  …  eₙ : τₙ
-----------------------------------------------------------------------------------------
           (f e₁ … eₙ) : τ
</pre>
</div>
<p>
One reads such a fraction as follows: If each part of the numerator &#x2014;the ‘hypothesises’&#x2014; is true, then so is the denominator &#x2014;the ‘conclusion’.
</p>

<p>
An <i>abstract syntax tree</i>, or ‘AST’, is a tree with operators for branches
and arguments for children. A tree is of kind τ if the topmost branching operator has τ as its resulting type. Here's an improved rule:
</p>
<div class="org-src-container">
<pre class="src src-math">f : τ₁ → ⋯ → τₙ → τ   e₁ : AST τ₁  …  eₙ : AST τₙ
-----------------------------------------------------------------------------------------
              (f e₁ … eₙ) : AST τ
</pre>
</div>

<p>
A Lisp top-level then may execute or interpret such a form to obtain a value:
When we write <code>e</code> at a top-level, it is essentially <code>(eval e)</code> that is invoked.
</p>
<div class="org-src-container">
<pre class="src src-math">   e : AST τ
-----------------------------------------------------------------------------------------
  (eval e) : τ
</pre>
</div>

<p>
However, we may also protect against evaluation.
</p>
<div class="org-src-container">
<pre class="src src-math">     e : AST τ
-----------------------------------------------------------------------------------------
  (quote e) : AST τ
</pre>
</div>

<p>
We have the following execution rules, where ‘⟿’ denotes “reduces to”.
</p>
<div class="org-src-container">
<pre class="src src-math">(eval a)         ⟿ a                        ;; for atom ‘a’
(eval (quote e))   ⟿ e
(eval (f e₁ … eₙ)) ⟿ (f (eval e₁) ⋯ (eval eₙ)) ;; Actually invoke ‘f’
</pre>
</div>

<div class="org-center">
<p>
<i>A conceptual model of Lisp is <code>eval</code>.</i>
</p>
</div>
</div>
</div>

<div id="outline-container-org9c415a4" class="outline-3">
<h3 id="lisp-is-dynamic">Variable Scope</h3>
<div class="outline-text-3" id="text-lisp-is-dynamic">
<p>
There's also the matter of “scope”, or ‘life time’, of a variable.
</p>

<table>
<caption class="t-above"><span class="table-number">Table 3:</span> Local variables temporarily mask global names …</caption>

<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Style</th>
<th scope="col" class="org-left">Definition</th>
<th scope="col" class="org-left">Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Lexical</td>
<td class="org-left">… only in visible code</td>
<td class="org-left">Nearly every language!</td>
</tr>

<tr>
<td class="org-left">Dynamic</td>
<td class="org-left">… every place imaginable</td>
<td class="org-left">Bash, Perl, &amp; allowable in some Lisps</td>
</tr>
</tbody>
</table>

<p>
That is, dynamic scope means a local variable not only acts as a global variable
for the rest of the scope but it does so even in the definitions of pre-defined methods
being invoked in the scope.
</p>
<div class="org-src-container">
<pre class="src src-elisp">(<span style="color: #859900; font-weight: bold;">setq</span> it <span style="color: #2aa198;">"bye"</span>)
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">go</span> () it)
(<span style="color: #859900; font-weight: bold;">let</span> ((it 3)) (go)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 3; even though &#8220;it&#8221; does not occur textually!</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Temporarily enable lexical binding in Emacs Lisp</span>
(<span style="color: #859900; font-weight: bold;">setq</span> <span style="color: #268bd2;">lexical-binding</span> <span style="color: #268bd2;">t</span>)
(<span style="color: #859900; font-weight: bold;">let</span> ((it 3)) (go)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; bye; as most languages would act</span>
</pre>
</div>

<div class="org-center">
<p>
<i>Dynamic scope lets bindings leak down into all constituents in its wake.</i>
</p>
</div>

<p>
That is fantastic when we want to do <a href="https://nullprogram.com/blog/2012/08/15/">unit tests</a> involving utilities with side-effects:
We simply locally re-define the side-effect component to, say, do nothing. (─‿‿─)
</p>
</div>
</div>

<div id="outline-container-org23f407b" class="outline-3">
<h3 id="lisp-is-strong">Casts &amp; Coercions</h3>
<div class="outline-text-3" id="text-lisp-is-strong">
<table>
<caption class="t-above"><span class="table-number">Table 4:</span> The frequency of implicit type coercions</caption>

<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Style</th>
<th scope="col" class="org-left">Definition</th>
<th scope="col" class="org-left">Examples</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Strong</td>
<td class="org-left">Almost never</td>
<td class="org-left">Lisp &amp; Haskell</td>
</tr>

<tr>
<td class="org-left">Weak</td>
<td class="org-left">Try as best as possible</td>
<td class="org-left">JavaScript &amp; C</td>
</tr>
</tbody>
</table>

<p>
<i>Strong systems will not accidentally coerce terms.</i>
</p>

<p>
Lisp has a <a href="http://www.lispworks.com/documentation/lw51/CLHS/Body/f_coerce.htm#coerce">coerce</a> form; but coercion semantics is generally unsound
in any language and so should be used with tremendous caution.
( Though Haskell has some sensible coercions as well as unsafe one. )
</p>
<div class="org-src-container">
<pre class="src src-math">     e : α
----------------------------------------------------------------------------------------
(coerce e β) : β
</pre>
</div>
<p>
We have a magical way to turn elements of type α to elements of type β.
Some languages call this <i>type casting</i>.
</p>

<p>
Here's a cute example.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">coerce</span> '(76 105 115 112) '<span style="color: #b58900;">string</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; Lisp</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb1d0c7f" class="outline-3">
<h3 id="type-annotations">Type Annotations</h3>
<div class="outline-text-3" id="text-type-annotations">
<p>
We may perform type annotations using the form <code>the</code>; e.g.,
the Haskell expression <code>(1 :: Int) + 2</code> checks the type annotation,
and, if it passes, yields the value and the expression is computed.
Likewise, <code>(the type name)</code> yields <code>name</code> provided it has type <code>type</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">+</span> (<span style="color: #859900; font-weight: bold;">the</span> integer 1)
   (<span style="color: #859900; font-weight: bold;">the</span> integer 2)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 3</span>

(<span style="color: #b58900;">+</span> (<span style="color: #859900; font-weight: bold;">the</span> integer 1)
   (<span style="color: #859900; font-weight: bold;">the</span> integer <span style="color: #2aa198;">"2"</span>)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; Type error.</span>
</pre>
</div>

<p>
Computationally, using <code>or</code> as a control structure for lazy sequencing with left-unit <code>nil</code>:
</p>
<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>(the τ e) ≈ (or (check-type e τ) e)</code></td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orge74a6e4" class="outline-3">
<h3 id="typecase">Type-directed Computations</h3>
<div class="outline-text-3" id="text-typecase">
<p>
Sometimes a value can be one of several types.
This is specified using union types; nested unions are essentially flattened
&#x2014;which is a property of ‘or’, as we shall come to see.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">typep</span> 12 'integer)  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
(<span style="color: #b58900;">typep</span> 'a 'symbol)   <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>

(<span style="color: #859900; font-weight: bold;">setq</span> woah 12)
(<span style="color: #b58900;">typep</span> woah '(<span style="color: #859900; font-weight: bold;">or</span> integer symbol)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>

(<span style="color: #859900; font-weight: bold;">setq</span> woah 'nice)
(<span style="color: #b58900;">typep</span> woah '(<span style="color: #859900; font-weight: bold;">or</span> integer symbol)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
</pre>
</div>

<p>
When given a union type, we may want to <i>compute according to the type of a value.</i>
</p>
<ul class="org-ul">
<li>Case along the possible types using <code>typecase</code>.</li>
<li>This returns a <code>nil</code> when no case fits; use <code>etypecase</code> to have an error instead of <code>nil</code>.</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">typecase</span> woah
  (integer  (+1 woah))
  (symbol  'cool)
  (<span style="color: #268bd2;">t</span>       <span style="color: #2aa198;">"yikes"</span>))
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f12661" class="outline-3">
<h3 id="type-specifiers">Type Specifiers: On the nature of types in Lisp</h3>
<div class="outline-text-3" id="text-type-specifiers">
<blockquote>
<p>
Types are not objects in Common Lisp. There is no object that corresponds to the type
<code>integer</code>, for example. What we get from a function like <code>type-of</code>, and give as an argument
to a function like <code>typep</code>, is not a type, but a type specifier.
A type specifier is the name of a type. &#x2014;Paul Graham, ANSI Common Lisp
</p>
</blockquote>

<p>
Type specifiers are essentially transformed into predicates as follows.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">typep</span> x '&#964;)                &#8776; (&#964;p x)  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">E.g., &#964; &#8776; integer</span>
(<span style="color: #b58900;">typep</span> x '(<span style="color: #859900; font-weight: bold;">and</span> &#964;&#8321; &#8230; &#964;&#8345;))    &#8776; (<span style="color: #859900; font-weight: bold;">and</span> (<span style="color: #b58900;">typep</span> x &#964;&#8321;) &#8230; (<span style="color: #b58900;">typep</span> x &#964;&#8345;))
(<span style="color: #b58900;">typep</span> x '(<span style="color: #859900; font-weight: bold;">or</span> &#964;&#8321; &#8230; &#964;&#8345;))     &#8776; (<span style="color: #859900; font-weight: bold;">or</span> (<span style="color: #b58900;">typep</span> x &#964;&#8321;) &#8230; (<span style="color: #b58900;">typep</span> x &#964;&#8345;))
(<span style="color: #b58900;">typep</span> x '(<span style="color: #b58900;">not</span> &#964;))          &#8776; (<span style="color: #b58900;">not</span> (<span style="color: #b58900;">typep</span> x &#964;))
(<span style="color: #b58900;">typep</span> x '(<span style="color: #b58900;">member</span> e&#8321; &#8230; e&#8345;)) &#8776; (<span style="color: #859900; font-weight: bold;">or</span> (<span style="color: #b58900;">eql</span> x e&#8321;) &#8230; (<span style="color: #b58900;">eql</span> x e&#8345;))
(<span style="color: #b58900;">typep</span> x '(satisfies p))    &#8776; (p x)
</pre>
</div>

<p>
Type specifiers are thus essentially ‘characteristic functions’ from mathematics.
</p>
</div>
</div>

<div id="outline-container-org8c57536" class="outline-3">
<h3 id="deftype">Making New Types with <code>deftype</code></h3>
<div class="outline-text-3" id="text-deftype">
<p>
If we use a type specifier often, we may wish to abbreviate it using
the <a href="https://www.gnu.org/software/emacs/manual/html_mono/cl.html#index-cl_002ddeftype-14">deftype</a> macro &#x2014;it is like <code>defmacro</code> but expands into a type specifier
instead of an expression.
</p>

<p>
We can define new types that will then work with <code>typecase</code> and friends
as follows:
</p>
<ol class="org-ol">
<li>Define a predicate <code>my-type-p</code>.</li>
<li>Test it out to ensure only the elements you want satisfy it.</li>
<li><p>
Register it using <a href="https://www.gnu.org/software/emacs/manual/html_mono/cl.html#index-cl_002ddeftype-14">deftype</a>.
</p>

<p>
You could just do number 3 directly, but it's useful to have the
predicate form of a <a href="#org21898a7">type descriptor</a>.
</p></li>
</ol>

<p>
<a href="https://lispcookbook.github.io/cl-cookbook/type.html">For example,</a> here's the three steps for a type of lists of numbers drawn from <code>(-∞..9]</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Make the predicate</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">small-number-seq-p</span> (thing)
  (<span style="color: #859900; font-weight: bold;">and</span> (<span style="color: #b58900;">sequencep</span> thing)
       (<span style="color: #b58900;">every</span> #'<span style="color: #b58900;">numberp</span> thing)
       (<span style="color: #b58900;">every</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (x) (<span style="color: #b58900;">&lt;</span> x 10)) thing)))

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Test it</span>
(<span style="color: #859900; font-weight: bold;">setq</span> yes '(1 2  4))
(<span style="color: #859900; font-weight: bold;">setq</span> no  '(1 20 4))
(small-number-seq-p yes) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Register it</span>
(<span style="color: #859900; font-weight: bold;">deftype</span> small-number-seq ()
  '(satisfies small-number-seq-p))

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Use it</span>
(<span style="color: #b58900;">typep</span> yes 'small-number-seq) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> no 'small-number-seq)  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
</pre>
</div>

<p>
Arguments are processed the same as for <code>defmacro</code> except that optional
arguments without explicit defaults use <code>*</code> instead of <code>nil</code> as the default value.
<a href="https://www.gnu.org/software/emacs/manual/html_mono/cl.html#index-cl_002ddeftype-14">From the deftype docs, here are some examples:</a>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">cl-deftype</span> <span style="color: #b58900; font-style: italic;">null</span> () '(satisfies <span style="color: #b58900;">null</span>))    <span style="color: #96A7A9; font-style: italic;">; </span><span style="color: #96A7A9; font-style: italic;">predefined</span>
(<span style="color: #859900; font-weight: bold;">cl-deftype</span> <span style="color: #b58900; font-style: italic;">list</span> () '(<span style="color: #859900; font-weight: bold;">or</span> <span style="color: #b58900;">null</span> <span style="color: #b58900;">cons</span>))      <span style="color: #96A7A9; font-style: italic;">; </span><span style="color: #96A7A9; font-style: italic;">predefined</span>

(<span style="color: #859900; font-weight: bold;">cl-deftype</span> <span style="color: #b58900; font-style: italic;">unsigned-byte</span> (<span style="color: #b58900; font-style: italic;">&amp;optional</span> bits)
  (<span style="color: #b58900;">list</span> 'integer 0 (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #b58900;">eq</span> bits '<span style="color: #b58900;">*</span>) bits (<span style="color: #b58900;">1-</span> (<span style="color: #b58900;">lsh</span> 1 bits)))))

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Some equivalences</span>
(unsigned-byte 8)  &#8801;  (integer 0 255)
(unsigned-byte)    &#8801;  (integer 0 <span style="color: #b58900;">*</span>)
unsigned-byte      &#8801;  (integer 0 <span style="color: #b58900;">*</span>)
</pre>
</div>

<ul class="org-ul">
<li>Notice that type specifiers essentially live in their own namespace; e.g., <code>null</code> is the
predicate that checks if a list is empty yet <code>null</code> is the type specifying such lists.</li>
</ul>

<p>
Let's form a type of pairs directly &#x2014;which is not ideal!
This is a <a id="org895d364">polymorphic</a> datatype: It takes two type arguments, called <code>a</code> and <code>b</code> below.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">deftype</span> pair (a b <span style="color: #b58900; font-style: italic;">&amp;optional</span> type)
  `(satisfies (<span style="color: #859900; font-weight: bold;">lambda</span> (x) (<span style="color: #859900; font-weight: bold;">and</span>
      (<span style="color: #b58900;">consp</span> x)
      (<span style="color: #b58900;">typep</span> (<span style="color: #b58900;">car</span> x) (<span style="color: #859900; font-weight: bold;">quote</span> ,a))
      (<span style="color: #b58900;">typep</span> (<span style="color: #b58900;">cdr</span> x) (<span style="color: #859900; font-weight: bold;">quote</span> ,b))))))

(<span style="color: #b58900;">typep</span> '(<span style="color: #2aa198;">"x"</span> . 2) '(pair <span style="color: #b58900;">string</span> integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> '(<span style="color: #2aa198;">"x"</span> . 2) '(pair symbol integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
(<span style="color: #b58900;">typep</span> nil '(pair integer integer))       <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
(<span style="color: #b58900;">typep</span> 23 '(pair integer integer))        <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>

(<span style="color: #859900; font-weight: bold;">setq</span> ss <span style="color: #2aa198;">"nice"</span> nn 114)
(<span style="color: #b58900;">typep</span> `(,ss . ,nn) '(pair <span style="color: #b58900;">string</span> integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> (<span style="color: #b58900;">cons</span> ss nn) '(pair <span style="color: #b58900;">string</span> integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">The following are false since ss and nn are quoted symbols!</span>
(<span style="color: #b58900;">typep</span> '(ss . nn)    '(pair <span style="color: #b58900;">string</span> integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
(<span style="color: #b58900;">typep</span> `(<span style="color: #b58900;">cons</span> ss nn) '(pair <span style="color: #b58900;">string</span> integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
</pre>
</div>

<p>
<b>Exercise:</b> Define the <a href="#org895d364">polymorphic</a> <code>maybe</code> type
such that <code>(maybe τ)</code> has elements being either <code>nil</code> or a value of <code>τ</code>.
</p>
<p>
Let's define type <code>list-of</code> such that <code>(list-of τ)</code> is the type of lists
whose elements are all values of type <code>τ</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Make the predicate</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">list-of-p</span> (&#964; thing)
  (<span style="color: #859900; font-weight: bold;">and</span> (<span style="color: #b58900;">listp</span> thing) (<span style="color: #b58900;">every</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (x) (<span style="color: #b58900;">typep</span> x &#964;)) thing)))

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Test it</span>
(list-of-p 'integer '(1 2   3)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(list-of-p 'integer '(1 two 3)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
(list-of-p '<span style="color: #b58900;">string</span> '())         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(list-of-p '<span style="color: #b58900;">string</span> '(no))       <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Register it</span>
(<span style="color: #859900; font-weight: bold;">deftype</span> list-of (&#964;)
  `(satisfies (<span style="color: #859900; font-weight: bold;">lambda</span> (thing) (list-of-p (<span style="color: #859900; font-weight: bold;">quote</span> ,&#964;) thing))))

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Use it</span>

(<span style="color: #b58900;">typep</span> '(1 2  ) '<span style="color: #b58900;">list</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> '(1 two) '<span style="color: #b58900;">list</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>

(<span style="color: #b58900;">typep</span> '(1 2)   '(list-of integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> '(1 <span style="color: #2aa198;">"2"</span>) '(list-of <span style="color: #b58900;">string</span>))  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
(<span style="color: #b58900;">typep</span> '(1 <span style="color: #2aa198;">"2"</span>) '(list-of (<span style="color: #859900; font-weight: bold;">or</span> integer <span style="color: #b58900;">string</span>)))  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
</pre>
</div>

<p>
Notice that by the last example we can <b>control the degree of heterogeneity</b> in our lists!
So cool!
</p>

<p>
Here's some more exercises. The first should be nearly trivial, the second a bit more
work, and the last two have made me #sad.
</p>

<ol class="org-ol">
<li>Define a type <code>(rose τ)</code> whose elements are either τ values or rose trees of type τ.</li>

<li>Define a type <code>record</code> so that <code>(record τ₁ … τₙ)</code> denotes a record type whose iᵗʰ
component has type <code>τᵢ</code>.</li>

<li><p>
Define a type constructor <code>∃</code> such that, for example, <code>(∃ τ (pair integer τ)</code>
denotes the type of pairs where the first components are integers and the second
components all have the same type <code>τ</code>, but we do not know which one.
</p>

<p>
My idea was to let <code>τ</code> denote the type of the first occurrence of a value
at that location, then all subsequent checks now refer to this value of <code>τ</code>.
</p>

<p>
Sadly, I could not define this type :'(
</p>

<p>
Upon further reading, this may be doable using a <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Watching-Variables.html#Watching-Variables">variable watcher</a>.
</p></li>

<li><p>
Produce a record for monoids and keep-track of the monoid instances produced.
Define a the predicate <code>(monoid τ)</code> to check if any of the monoid instances
has <code>τ</code> as its carrier type. In this way we could simulate Haskell typeclasses.
</p></li>
</ol>

<p>
Let me know if you do cool things!
</p>
</div>
</div>
<div id="outline-container-orgb7f16e4" class="outline-3">
<h3 id="adts">Algebraic Data Types a la Haskell</h3>
<div class="outline-text-3" id="text-adts">
<p>
Consider the Haskell expression type, example, and integer evaluator.
</p>
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #859900; font-weight: bold;">data</span> <span style="color: #b58900; font-style: italic;">Expr</span> a <span style="color: #268bd2;">=</span> <span style="color: #b58900; font-style: italic;">Var</span> a <span style="color: #268bd2;">|</span> <span style="color: #b58900; font-style: italic;">Expr</span> a <span style="color: #b58900; font-style: italic;">:+:</span> <span style="color: #b58900; font-style: italic;">Expr</span> a <span style="color: #268bd2;">|</span> <span style="color: #b58900; font-style: italic;">Neg</span> (<span style="color: #b58900; font-style: italic;">Expr</span> a) <span style="color: #859900; font-weight: bold;">deriving</span> <span style="color: #b58900; font-style: italic;">Show</span>

<span style="color: #b58900;">ex</span> <span style="color: #268bd2;">::</span> <span style="color: #b58900; font-style: italic;">Expr</span> <span style="color: #b58900; font-style: italic;">Int</span>
<span style="color: #b58900;">ex</span> <span style="color: #268bd2;">=</span> <span style="color: #b58900; font-style: italic;">Var</span> 5 <span style="color: #b58900; font-style: italic;">:+:</span> (<span style="color: #b58900; font-style: italic;">Var</span> 6 <span style="color: #b58900; font-style: italic;">:+:</span> <span style="color: #b58900; font-style: italic;">Neg</span> (<span style="color: #b58900; font-style: italic;">Var</span> 7))

<span style="color: #b58900;">int</span> <span style="color: #268bd2;">::</span> <span style="color: #b58900; font-style: italic;">Expr</span> <span style="color: #b58900; font-style: italic;">Int</span> <span style="color: #268bd2;">-&gt;</span> <span style="color: #b58900; font-style: italic;">Int</span>
<span style="color: #b58900;">int</span> (<span style="color: #b58900; font-style: italic;">Var</span> n)    <span style="color: #268bd2;">=</span> n
<span style="color: #b58900;">int</span> (l <span style="color: #b58900; font-style: italic;">:+:</span> r)  <span style="color: #268bd2;">=</span> int l <span style="color: #268bd2;">+</span> int r
<span style="color: #b58900;">int</span> (<span style="color: #b58900; font-style: italic;">Neg</span> e)    <span style="color: #268bd2;">=</span> <span style="color: #268bd2;">-</span> (int e)

<span style="color: #96A7A9; font-style: italic;">{- </span><span style="color: #96A7A9; font-style: italic;">int ex &#8658; 4 -}</span>
</pre>
</div>

<p>
If we view a constructor declaration <code>C a₁ … aₙ</code> with superfluous parenthesis
as <code>(C a₁ … aₙ)</code>, then a translation to Lisp immediately suggests itself:
</p>
<div class="org-center">
<p>
<i>Haskell constructors ≅ Lisp lists whose <code>car</code> are constructor names</i>
</p>
</div>

<p>
A nearly direct translation follows.
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">exprp</span> (&#964; thing)
    (pcase thing
       (`(var ,n)    (typep n &#964;))
       (`(add ,l ,r) (and (exprp &#964; l) (exprp &#964; r)))
       (`(neg ,e)    (exprp &#964; e))))

(setq ex '(add (var 5) (add (var 6) (neg (var 7)))))
(exprp 'integer ex) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>

<span style="color: #96A7A9; font-style: italic;">; </span><span style="color: #96A7A9; font-style: italic;">This declarion &#8220;declare-type&#8221; is defined near the end of this article.</span>
(declare-type int : (expr-of integer) integer)
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">int</span> (thing)
    (pcase thing
       (`(var ,n)    n)
       (`(add ,l ,r) (+ (int l) (int r)))
       (`(neg ,e)    (- (int e)))))

(int ex) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 4</span>
</pre>
</div>

<p>
There are of-course much better ways to do this in Lisp; e.g.,
use <code>identity, +, -</code> in-place of the <code>var, add, neg</code> tags
to produce “syntax that carries its semantics”
or express the interpreter <code>int</code> as a one liner
by replacing the formal tags with their interpretations then
invoking Lisps <code>eval</code>. I doubt either of these are new ideas,
but the merit of the former seems neat &#x2014;at a first glance, at least.
</p>

<p>
Support for ADTs in Common Lisp along with seemingly less clunky pattern matching
can be found <a href="https://github.com/stylewarning/cl-algebraic-data-type">here</a> &#x2014;which I have only briefly looked at.
</p>

<p>
The Haskell presentation has type-checking baked into it, yet our
Lisp interpreter <code>int</code> does not! This seems terribly worrying, but
that <a href="#orgad7ed90"><code>declare-type</code></a> declaration actually handles type checking for us!
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Register the type</span>
(<span style="color: #859900; font-weight: bold;">deftype</span> <span style="color: #b58900; font-style: italic;">expr-of</span> (&#964;)
  `(satisfies (<span style="color: #859900; font-weight: bold;">lambda</span> (thing) (exprp (quote ,&#964;) thing))))

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Try it out</span>
(typep '(1 2)   '(expr-of integer)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil</span>
(typep ex   '(expr-of integer))     <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">This invocation, for example, now yields a helpful error message.</span>
(int '(var 6 4))
<span style="color: #96A7A9; font-style: italic;">;;</span>
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; int: Type mismatch! Expected (expr-of integer) for argument 0 &#8800; Given cons (var 6 4).</span>
<span style="color: #96A7A9; font-style: italic;">;;</span>
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Which is reasonable since the &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">var</span><span style="color: #96A7A9; font-style: italic;">&#8217; constructor only takes a single argument.</span>
</pre>
</div>
<p>
Notice that invalid cases yield a helpful (run-time) error message!
</p>
</div>
</div>
</div>

<div id="outline-container-org334a87c" class="outline-2">
<h2 id="why-dynamic">In Defence of Being Dynamically Checked</h2>
<div class="outline-text-2" id="text-why-dynamic">
<div class="org-center">
<p>
<i>Lisp gets a bad rap for being untyped; let's clarify this issue further!</i>
</p>
</div>

<p>
It is important to realise that nearly every language is typed &#x2014;albeit the checking
may happen at different stages&#x2014; and so, as <a href="http://www.cis.upenn.edu/~bcpierce/tapl/index.html">Benjamin Pierce</a> says:
<i>Terms like “dynamically typed” are arguably misnomers and should probably be replaced by “dynamically checked,” but the usage is standard.</i>
</p>

<p>
In particular, dynamically typed is <i>not</i> synonymous with untyped, though some people use
it that way since nearly <a href="https://www.williamjbowman.com/blog/2018/01/19/untyped-programs-don-t-exist/#related">every language is typed</a> &#x2014;possibly with a single anonymous
type.
</p>

<p>
Some people in the Haskell community, which I love, say things like
<i>“if it typechecks, ship it”</i> which is true more often than not, but it leads some
people to avoid producing unit tests. For example, the following type checks but
should be unit tested.
</p>
<div class="org-src-container">
<pre class="src src-haskell"><span style="color: #b58900;">mcbride</span> <span style="color: #268bd2;">::</span> [<span style="color: #b58900; font-style: italic;">Int</span>] <span style="color: #268bd2;">-&gt;</span> <span style="color: #b58900; font-style: italic;">Int</span>
<span style="color: #b58900;">mcbride</span> xs <span style="color: #268bd2;">=</span> <span style="color: #859900; font-weight: bold;">if</span> null xs <span style="color: #859900; font-weight: bold;">then</span> head xs <span style="color: #859900; font-weight: bold;">else</span> 666
</pre>
</div>

<p>
Regardless, I love static type checking and static analysis in general.
However, the shift to a dynamically checked setting has resulted in greater
interest in unit testing. For example, Haskell's solution to effectful computation
is delimited by types, as any Haskeller will proudly say (myself included);
but ask how are such computations unit tested and the room is
silent (myself included).
</p>

<p>
Interestingly some unit tests check the typing of inputs and output, which is
a mechanical process with no unknowns and so it should be possible to produce a syntax
for it using Lisp macros. This is one of the goals of this article and we'll return to
it later.
</p>

<p>
Even though I like Lisp, I'm not sure why dynamic typing is the way to go
&#x2014;c.f. <a href="https://existentialtype.wordpress.com/2011/03/19/dynamic-languages-are-static-languages/">Dynamic Languages are Static Languages</a> which mentions the unjust tyranny of
unityped systems.
Below are two reasons why people may dislike static types.
</p>

<p>
<b>First</b>: The de-facto typing rule do binary choice is usually:
</p>
<div class="org-src-container">
<pre class="src src-math">     T : 𝔹     E : α     B : α -----------------------------------------------------------------------------------------
     if T then E else B : α
</pre>
</div>

<p>
That means valid programs such as <code>if True then 1 else "two"</code> are rejected;
even though the resulting type will always be an integer there is no way to know
that statically &#x2014;the choice needs to be rewritten, evaluated at run time.
</p>

<p>
Indeed, in Haskell, we would write
<code>if True then Left 1 else Right "two"</code> which has type <code>Either Int String</code>,
and to use the resulting value means we need to pattern match or use
the eliminator <code>(|||</code>) &#x2014;from Haskell's <code>Control.Arrow</code>.
</p>

<p>
<b>Second:</b>
Some statically typed languages have super weak type systems and ruin the rep
for everyone else.
For example, <code>C</code> is great and we all love it of-course, but it's a shame that we can only
express the <a href="#org895d364">polymorphic</a> identity function \(id : ∀{α}. α → α \;=\; λ x → x\),
by using the C-preprocessor &#x2014;or dismiss the types by casting pointers around.
</p>

<p>
Maybe this video is helpful, maybe not:
<a href="https://games.greggman.com/game/dynamic-typing-static-typing/">The Unreasonable Effectiveness of Dynamic Typing for Practical Programs</a>
</p>

<blockquote>
<p>
( For the algebraist: Dynamic typing is like working in a monoid whose
composition operation is partial and may abruptly crash; whereas static typing
is working in a category whose composition is proudly typed. )
</p>
</blockquote>

<p>
Overall I haven't presented a good defence for being dynamically checked, but you
should ignore my blunder and consider trying Lisp yourself to see how awesome it is.
</p>
</div>
</div>

<div id="outline-container-org7abc5e5" class="outline-2">
<h2 id="lisp-funny-history">With its hierarchy of types, why isn't Lisp statically typed?</h2>
<div class="outline-text-2" id="text-lisp-funny-history">
<div class="org-center">
<p>
<i>I haven't a clue. Here are two conjectures.</i>
</p>
</div>

<p>
<b>First</b>: Code that manipulates code is difficult to type.
</p>

<p>
Is the type of <code>'(+ x 2)</code> a numeric code expression?
Or just an arbitrary code expression? Am I allowed to “look inside”
to inspect its structure or is it a black box? What about the nature of
its constituents? If I'm allowed to look at them, can I ask if they're even defined?
</p>

<p>
What if <code>c</code> is a code element that introduces an identifier, say <code>it</code>.
What is type of <code>c</code>? What if it doesn't introduce and thus avoids accidentally
capturing identifiers? Are we allowed only one form or both? Which do we select
and why?
</p>

<p>
I may be completely wrong, but below I mention a <a href="#org440f6ea">bunch of papers</a> that suggest
it's kind hard to type this stuff.
</p>

<p>
<b>Second</b>: The type theory just wasn't in place at the time Lisp was created.
</p>

<p>
Here's a probably wrong account of how it went down.
</p>

<dl class="org-dl">
<dt>1913ish</dt><dd>Bertrand Russel introduces a hierarchy of types to avoid barber trouble;
e.g., <code>Typeᵢ : Typeᵢ₊₁</code>.</dd>
<dt>1920s</dt><dd>A Polish guy &amp; British guy think that's dumb and collapse the hierarchy.</dd>
<dt>1940s</dt><dd>Alonzo Church says arrows are cool.</dd>
<dt>1958 </dt><dd><p>
With his awesome hairdo, John McCarthy gifts the world an elegant
piece of art: Lisp (•̀ᴗ•́)و
</p>
<ul class="org-ul">
<li>Lisp is currently the 2ⁿᵈ oldest high-level language still
in use after Fortran.</li>
<li>Maxwell's equations <a href="https://queue.acm.org/detail.cfm?id=1039523">get</a> <a href="http://www.michaelnielsen.org/ddi/lisp-as-the-maxwells-equations-of-software/">jealous</a>.</li>
</ul>

<p>
Lisp introduces a bunch of zany ideas to CS:
</p>
<ul class="org-ul">
<li>Introduced if-then-else “McCarthy's Conditional”; 1ˢᵗ class functions &amp; recursion</li>
<li>macros ≈ compiler plugins</li>
<li>symbols ≈ raw names which needn't have values</li>
<li>variables ≈ pointers</li>
<li>code ≈ data; statements ≈ expressions</li>
<li><code>read, eval, load, compile, print</code> are all functions!</li>
</ul></dd>

<dt>1959</dt><dd>My man JM thinks manual memory is lame &#x2014;invents garbage collection!
<ul class="org-ul">
<li>Later, 2001, he writes <a href="https://web.archive.org/web/20130814213421/http://www-formal.stanford.edu/jmc/robotandbaby/robotandbaby.html">The Robot &amp; The Baby</a>.</li>
</ul></dd>
<dt>1960s</dt><dd>Simula says OOPs!</dd>
<dt>1970s</dt><dd>Smalltalk popularises the phrase “oop”. ( B has a child named C. )</dd>
<dt>1970s</dt><dd>Simple λ-calculus is a fashion model for sets and functions.</dd>
<dt>1970s</dt><dd>Milner and friends demand
<i>variables are for types too, not just terms!</i></dd>
<dt>1970s</dt><dd>Per Martin-Löf tells us it's okay to depend on one another; <code>Π, Σ</code> types.</dd>
<dt>1982 </dt><dd>A Lisp <a href="https://en.wikipedia.org/wiki/Ummah">ummah</a> is formed: <a href="http://www.cs.cmu.edu/Groups/AI/html/cltl/clm/node1.html">“Common Lisp the Language”</a> ♥‿♥
<ul class="org-ul">
<li>In order to be hip &amp; modern, it's got <a href="https://extravagaria.com/Files/LASC-Overview.pdf">class</a> with <a href="https://en.wikipedia.org/wiki/Common_Lisp_Object_System">CLOS</a>.</li>
<li>Other shenanigans: Scheme 1975, Elisp 1985, Racket 1995, Clojure 2007</li>
</ul></dd>
<dt>1984</dt><dd>A script of sorcerous schemes lords lisp over mere mortals</dd>
<dt>1990s</dt><dd>A committee makes a sexy <a href="https://en.wiktionary.org/wiki/a_camel_is_a_horse_designed_by_a_committee">camel</a> named Haskell; Professor X's school make their own camel.
<ul class="org-ul">
<li>Their kids get on steroids and fight to this day; Agda ↯↯↯ Coq.</li>
</ul></dd>
<dt>2000s</dt><dd><p>
X's camel .&lt;becomes .~(self .&lt;aware&gt;.)&gt;.
&#x2014;the other camel [does| the same].
</p>
<ul class="org-ul">
<li>In 2015, the cam ls married Lisp and <a href="https://luxlang.gitbooks.io/the-lux-programming-language/content/">Lux</a> was born.</li>
<li>In 2016, Haskell &amp; Lisp get involved with Prolog; <a href="https://shen-language.github.io/">Shen</a> is born.</li>
</ul>

<p>
2019: Coq is <a href="https://github.com/MetaCoq/metacoq">self-aware</a>; Agda is <a href="https://github.com/alhassy/gentle-intro-to-reflection">playing</a> <a href="https://alhassy.github.io/next-700-module-systems-proposal/prototype/PackageFormer.html">catch-up</a>.
</p></dd>
</dl>

<p>
A more informative historical account of Lisp &amp; its universal reverence can be read at:
<a href="https://twobithistory.org/2018/10/14/lisp.html">How Lisp Became God's Own Programming Language</a>.
</p>

<figure>
<img src="https://imgs.xkcd.com/comics/lisp.jpg" alt="lisp.jpg">

<figcaption><span class="figure-number">Figure 3: </span>xkcd</figcaption>
</figure>
</div>
</div>

<div id="outline-container-org6ba754f" class="outline-2">
<h2 id="lisp-is-typed">Lisp Actually Admits Static Typing!</h2>
<div class="outline-text-2" id="text-lisp-is-typed">
<p>
Besides Common Lisp, “Typed Lisps” include <a href="https://github.com/clojure/core.typed">an optional type system for Clojure</a>
&#x2014;see also <a href="https://circleci.com/blog/why-were-no-longer-using-core-typed/">Why we're no longer using Core.typed</a>&#x2014;
<a href="https://docs.racket-lang.org/ts-guide/">Typed Racket</a>, and, more recently, <a href="https://github.com/LuxLang/lux">Lux</a> ≈ Haskell + ML + Lisp
and  <a href="https://shen-language.github.io/">Shen</a> ≈ Haskell + Prolog + Lisp.
</p>

<p>
<a href="https://news.ycombinator.com/item?id=8593261">For example,</a> Common Lisp admits strong static typing, in <a href="http://www.lispforum.com/viewtopic.php?f=2&amp;t=191">SBCL</a>, as follows.
</p>
<div class="org-src-container">
<pre class="src src-common-lisp">  <span style="color: #96A7A9; font-style: italic;">; Type declaration then definition.</span>
  (<span style="color: #859900; font-weight: bold;">declaim</span> (ftype (function (fixnum)) num-id))
  (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">num-id</span> (n) n)

  (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">string-id</span> (s) (<span style="color: #859900; font-weight: bold;">declare</span> (string s)) (num-id s))
  <span style="color: #96A7A9; font-style: italic;">; in: DEFUN STRING-ID</span>
  <span style="color: #96A7A9; font-style: italic;">;     (NUM-ID S)</span>
  <span style="color: #96A7A9; font-style: italic;">;</span>
  <span style="color: #96A7A9; font-style: italic;">; caught WARNING:</span>
  <span style="color: #96A7A9; font-style: italic;">;   Derived type of S is</span>
  <span style="color: #96A7A9; font-style: italic;">;     (VALUES STRING &amp;OPTIONAL),</span>
  <span style="color: #96A7A9; font-style: italic;">;   conflicting with its asserted type</span>
  <span style="color: #96A7A9; font-style: italic;">;     FIXNUM.</span>
</pre>
</div>

<p>
Such annotations mostly serve as compiler optimisation annotations and,
unfortunately, Emacs Lisp <a href="https://www.gnu.org/software/emacs/manual/html_node/cl/Declarations.html">silently ignores Common Lisp declarations such as ftype</a>
&#x2014;which provides <a href="http://www.lispworks.com/documentation/lw51/CLHS/Body/d_ftype.htm#ftype">function type</a> declarations.
However,
Emacs Lisp does provide a method of <a href="http://www.p-cos.net/documents/filtered-dispatch.pdf">dispatch</a> filtered by <a href="http://www.gigamonkeys.com/book/object-reorientation-generic-functions.html">classes</a> rather than by
simple types. Interestingly, Lisp methods are more like Haskell typeclass constituents
or C# extensible methods
rather than like Java object methods &#x2014;in that, <i>Lisp methods specialise on classes</i>
whereas Java's approach is <i>classes have methods</i>.
</p>

<p>
Here's an example.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defmethod</span> <span style="color: #b58900;">doit</span> ((n integer)) <span style="color: #35a69c; font-style: italic;">"I'm an integer!"</span>)
(<span style="color: #859900; font-weight: bold;">defmethod</span> <span style="color: #b58900;">doit</span> ((s <span style="color: #b58900;">string</span>)) <span style="color: #35a69c; font-style: italic;">"I'm a string!"</span>)
(<span style="color: #859900; font-weight: bold;">defmethod</span> <span style="color: #b58900;">doit</span> ((type (<span style="color: #b58900;">eql</span> <span style="color: #d33682; font-style: italic;">:hero</span>)) thing) <span style="color: #35a69c; font-style: italic;">"I'm a superhero!"</span>)

(doit 2)             <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; I'm an integer!</span>
(doit <span style="color: #2aa198;">"2"</span>)           <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; I'm a string!</span>
(doit 'x)            <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; Error: No applicable method</span>
(doit <span style="color: #d33682; font-style: italic;">:hero</span> 'bobert) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; I'm a superhero!</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">C-h o cl-defmethod &#8658; see extensible list of specialisers Elisp supports.</span>
</pre>
</div>

<p>
We can of-course make our own classes:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defclass</span> <span style="color: #b58900; font-style: italic;">person</span>  () ((name)))
(<span style="color: #859900; font-weight: bold;">defmethod</span> <span style="color: #b58900;">speak</span> ((x person)) (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"My name is %s."</span> (<span style="color: #b58900;">slot-value</span> x 'name)))
(<span style="color: #859900; font-weight: bold;">setq</span> p (<span style="color: #b58900;">make-instance</span> 'person))
(<span style="color: #859900; font-weight: bold;">setf</span> (<span style="color: #b58900;">slot-value</span> p 'name) <span style="color: #2aa198;">"bobert"</span>)
(speak p) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; My name is bobert.</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Inherits from &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">person</span><span style="color: #96A7A9; font-style: italic;">&#8217; and has accessor &amp; constructor methods for a new slot</span>
(<span style="color: #859900; font-weight: bold;">defclass</span> <span style="color: #b58900; font-style: italic;">teacher</span> (person) ((topic <span style="color: #d33682; font-style: italic;">:accessor</span> teacher-topic <span style="color: #d33682; font-style: italic;">:initarg</span> <span style="color: #d33682; font-style: italic;">:studying</span>)))

(<span style="color: #859900; font-weight: bold;">defmethod</span> <span style="color: #b58900;">speak</span> ((x teacher))
  (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"My name is %s,and I study %s."</span> (<span style="color: #b58900;">slot-value</span> x 'name) (teacher-topic x)))

(<span style="color: #859900; font-weight: bold;">setq</span> ins (<span style="color: #b58900;">make-instance</span> 'teacher <span style="color: #d33682; font-style: italic;">:studying</span> <span style="color: #2aa198;">"mathematics"</span>))
(<span style="color: #859900; font-weight: bold;">setf</span> (<span style="color: #b58900;">slot-value</span> ins 'name) <span style="color: #2aa198;">"Robert"</span>)
(speak ins) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; My name is Robert, and I study mathematics.</span>
</pre>
</div>

<p>
Later in this article, we'll make something like the <code>declaim</code> above
but have it be effectful at run-time. <i>Typing as Macros!</i>
</p>

<blockquote>
<p>
(
If you happen to be interested in looking under the hood to see what compiler generated
code looks like use <code>disassemble</code>. For example, declare <code>(defun go (x) (+ 1 x) 'bye)</code>
then invoke <code>(disassemble 'go)</code> to see something like
<code>varref x⨾ add1⨾ discard ⨾ constant bye⨾ return</code>.
)
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org51ac8f6" class="outline-2">
<h2 id="elisp-types">ELisp's Type Hierarchy</h2>
<div class="outline-text-2" id="text-elisp-types">
<p>
⇨ Each primitive type has a corresponding Lisp function that checks whether an object is a
  member of that type. Usually, these are the type name appended with <code>-p</code>, for multi-word
  names, and <code>p</code> for single word names. E.g., <code>string</code> type has the predicate <code>stringp</code>.
</p>

<dl class="org-dl">
<dt><a id="org21898a7">Type Descriptor</a></dt><dd><p>
Objects holding information about types.
</p>

<p>
This is a <code>record</code>; the <code>type-of</code> function returns the first slot of records.
</p></dd>
</dl>

<p>
This section is based <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Lisp-Data-Types.html#Lisp-Data-Types">GNU Emacs Lisp Reference Manual</a>, §2.3 “Programming Types”.
</p>
</div>

<div id="outline-container-org79ce39b" class="outline-3">
<h3 id="Number">Number</h3>
<div class="outline-text-3" id="text-Number">
<p>
<i>Numbers, including fractional and non-fractional types.</i>
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>integer</code></td>
<td class="org-left"><code>float</code></td>
<td class="org-left"><code>number</code></td>
<td class="org-left"><code>natnum</code></td>
<td class="org-left"><code>zero</code></td>
<td class="org-left"><code>plus</code></td>
<td class="org-left"><code>minus</code></td>
<td class="org-left"><code>odd</code></td>
<td class="org-left"><code>even</code></td>
</tr>
</tbody>
</table>

<p>
The relationships between these types are as follows:
</p>
<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>(numberp x) ≈ (or (integerp x) (floatp x))</code></td>
</tr>

<tr>
<td class="org-left"><code>(natnump x) ≈ (and (integerp x) (≤ 0 x))</code></td>
</tr>

<tr>
<td class="org-left"><code>(zerop   x) ≈ (equal 0 x)</code></td>
</tr>

<tr>
<td class="org-left"><code>(plusp   x) ≈ (&lt; 0 x)</code></td>
</tr>

<tr>
<td class="org-left"><code>(minusp  x) ≈ (&gt; 0 x)</code></td>
</tr>

<tr>
<td class="org-left"><code>(evenp    x) ≈ (zerop (mod x 2))</code></td>
</tr>

<tr>
<td class="org-left"><code>(oddp     x) ≈ (not (oddp x))</code></td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
<b>Integer</b>: Numbers without fractional parts.
</p>

<p>
There is no overflow checking.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">expt</span> 2 60) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 1,152,921,504,606,846,976</span>
(<span style="color: #b58900;">expt</span> 2 61) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; -2,305,843,009,213,693,952</span>
(<span style="color: #b58900;">expt</span> 2 62) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 0</span>
</pre>
</div>

<p>
Numbers are written with an optional sign ‘+’ or ‘-’ at the beginning and
  an optional period at the end.
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>-1 ≈ -1.</code></td>
<td class="org-left"><code>1 ≈ +1 ≈ 1.</code></td>
</tr>
</tbody>
</table>

<p>
They may also take <i>inclusive</i> (and exclusive) ranges:
The type list <code>(integer LOW HIGH)</code> represents all integers between
 <code>LOW</code> and <code>HIGH</code>, inclusive.  Either bound may be a list of a single
 integer to specify an exclusive limit, or a <code>*</code> to specify no
 limit.  The type <code>(integer * *)</code> is thus equivalent to <code>integer</code>.
 Likewise, lists beginning with <code>float</code>, <code>real</code>, or <code>number</code>
 represent numbers of that type falling in a particular range.
 ( <a href="https://www.gnu.org/software/emacs/manual/html_mono/cl.html#Predicates">The Emacs Common Lisp Documentation</a> )
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">    (<span style="color: #b58900;">typep</span> 4 '(integer 1 5)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true since 1 &#8804; 4 &#8804; 5.</span>
    (<span style="color: #b58900;">typep</span> 4 '(integer 1 3)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil  since 1 &#8804; 4 &#8816; 3.</span>

    (<span style="color: #b58900;">typep</span> 12 'integer) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
    (<span style="color: #b58900;">typep</span> 12 'number) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>

    (<span style="color: #b58900;">typep</span> 23 'odd)  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>

    (<span style="color: #b58900;">typep</span> 12 '(integer <span style="color: #b58900;">*</span> 14)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t, since 12 &#8804; 14, but no lower bound.</span>
    (<span style="color: #b58900;">typep</span> 12 '(integer 0 <span style="color: #b58900;">*</span>)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t; the &#8216;*&#8217; denotes a wild-card; anything.</span>

   (<span style="color: #b58900;">typep</span> -1 '(<span style="color: #b58900;">not</span> (integer 0 <span style="color: #b58900;">*</span>))) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
   (<span style="color: #b58900;">typep</span>  1 '(<span style="color: #b58900;">not</span> (integer 0 <span style="color: #b58900;">*</span>))) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil</span>

   (<span style="color: #b58900;">typep</span> 1 '(integer  1 2))   <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t, including lower bound</span>
   (<span style="color: #b58900;">typep</span> 1 '(integer (1) 2))  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil, excluding lower bound</span>

   (<span style="color: #b58900;">typep</span> 1.23 '(<span style="color: #b58900;">float</span> 1.20 1.24)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>

   <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Here's a slighly organised demonstration:</span>

   (<span style="color: #b58900;">typep</span> 1.23 'number) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
   (<span style="color: #b58900;">typep</span> 123  'number) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
   (<span style="color: #b58900;">typep</span> 1.23 'real) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
   (<span style="color: #b58900;">typep</span> 123  'real) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>

   (<span style="color: #b58900;">typep</span> 1.23 'integer) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil</span>
   (<span style="color: #b58900;">typep</span> 123  'integer) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
   (<span style="color: #b58900;">typep</span> 1.23 'fixnum) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil</span>
   (<span style="color: #b58900;">typep</span> 123  'fixnum) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>

   (<span style="color: #b58900;">typep</span> 1.23 '<span style="color: #b58900;">float</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
   (<span style="color: #b58900;">typep</span> 123 '<span style="color: #b58900;">float</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil</span>
   (<span style="color: #b58900;">typep</span> 123.0 '<span style="color: #b58900;">float</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
</pre>
</div></li>

<li><b>Floating-Point</b>: Numbers with fractional parts; expressible using scientific notation.
For example, <code>15.0e+2 ≈ 1500.0</code> and <code>-1.0e+INF</code> for negative infinity.</li>

<li><b>Aliases:</b>
The type symbol <code>real</code> is a synonym for <code>number</code>, <code>fixnum</code> is a
 synonym for <code>integer</code>, and <code>wholenum</code> is a synonym for <code>natnum</code>.</li>

<li><p>
The smallest and largest values <i>representable</i> in a Lisp integer are in the
constants <code>most-negative-fixnum</code> and <code>most-postive-fixnum</code>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Relationship with infinities</span>
(<span style="color: #b58900;">&lt;</span> -1e+INF <span style="color: #268bd2;">most-negative-fixnum</span> <span style="color: #268bd2;">most-positive-fixnum</span> 1e+INF) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org5ccd332" class="outline-3">
<h3 id="Character">Character</h3>
<div class="outline-text-3" id="text-Character">
<p>
<i>Representation of letters, numbers, and control characters.</i>
</p>

<p>
A character is just a small integers, up to 22 bits;
e.g., character <code>A</code> is represented as the integer 65.
</p>

<p>
One writes the character ‘A’ as <code>?A</code>, which is identical to 65.
Punctuations <code>()[]\;"|'`#</code> must be &#x00ad;escaped; e.g.,
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>?\( ≈ 40</code></td>
<td class="org-left"><code>?\\ ≈ 92</code></td>
</tr>
</tbody>
</table>
<p>
Whereas <code>?. ≈ 46</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">characterp</span> ?f) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
(<span style="color: #b58900;">characterp</span> <span style="color: #268bd2;">t</span>)  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil</span>
</pre>
</div>

<p>
Emacs specfic characters control-g <code>C-g</code>, backspace <code>C-h</code>, tab <code>C-i</code>, newline <code>C-j</code>, space,
return, del, and escape are expressed by ?\a, ?\b, ?\t, ?\n, ?\s, ?\r, ?\d, ?\e.
</p>

<p>
Generally, control characters can be expressed as <code>?\^𝓍 ≈ ?\C-𝓍</code>,
and meta characters by <code>?\M-𝓍</code>; e.g., <code>C-M-b</code> is expressed
<code>?\M-\C-b ≈ ?\C-\M-b</code>.
</p>

<p>
Finally, <code>?\S-𝓍</code> denotes shifted-𝓍 characters.
There are also <code>?\H-𝓍, ?\A-𝓍, ?\s-𝓍</code> to denote Hyper- Alt- or Super-modified keys;
note that lower case ‘s’ is for super whereas capital is for shift,
and lower case with no dash is a space character.
</p>
</div>
</div>

<div id="outline-container-orgb95a2b2" class="outline-3">
<h3 id="Symbol">Symbol</h3>
<div class="outline-text-3" id="text-Symbol">
<p>
<i>A multi-use object that refers to functions and variables, and more.</i>
</p>

<p>
A symbol is an object with a name; different objects have different names.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">typep</span> 'yes 'symbol) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">symbolp</span> 'yes)       <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>

(<span style="color: #b58900;">typep</span> 12   'symbol) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
(<span style="color: #b58900;">symbolp</span> 12)         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
</pre>
</div>

<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>symbol</code> ≈ Is it a symbol?</td>
</tr>

<tr>
<td class="org-left"><code>bound</code>  ≈ Does it refer to anything?</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">typep</span> 'xyz 'bound) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil</span>

(<span style="color: #859900; font-weight: bold;">setq</span> xyz 123)
(<span style="color: #b58900;">typep</span> 'xyz 'bound) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
</pre>
</div>
<p>
See this short <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Void-Variables.html#Void-Variables">docs</a> page for more info on when a variable is void.
</p>

<p>
<span class="underline">Names have a tremendously flexible syntax.</span>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">setq</span> +*/-_~!<span style="color: #b58900;">@$%^&amp;</span>:&lt;&gt;{}? 23)
(<span style="color: #859900; font-weight: bold;">setq</span> \+1            23) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Note +1 &#8776; 1, a number.</span>
(<span style="color: #859900; font-weight: bold;">setq</span> \12            23)
(<span style="color: #859900; font-weight: bold;">setq</span> this\ is\ woah 23) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Escaping each space!</span>
(<span style="color: #b58900;">+</span> this\ is\ woah 1)     <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 24</span>
</pre>
</div>

<p>
If the symbbol name starts with a colon ‘:’, it's called a keyword symbol
     and automatically acts as a constant.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">typep</span> <span style="color: #d33682; font-style: italic;">:hello</span> 'keyword) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
</pre>
</div>

<p>
Symbols generally act as names for variables and functions, however there are
some names that have <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Variables-with-Restricted-Values.html#Variables-with-Restricted-Values">fixed values</a> and any attempt to reset their values signals an error.
Most notably, these include <code>t</code> for true or the top-most type,
<code>nil</code> for false or the bottom-most type, and keywords.
These three evaluate to themselves.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #268bd2;">t</span>      <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
nil    <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil</span>
<span style="color: #d33682; font-style: italic;">:hello</span> <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; :hello</span>

(<span style="color: #859900; font-weight: bold;">setq</span> <span style="color: #268bd2;">t</span>   12) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; Error: Attempt to set a constant symbol</span>
(<span style="color: #859900; font-weight: bold;">setq</span> nil 12) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; Error: Attempt to set a constant symbol</span>
(<span style="color: #859900; font-weight: bold;">setq</span> <span style="color: #d33682; font-style: italic;">:x</span>  12) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; Error: Attempt to set a constant symbol</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">:x &#8800; 'x</span>
(<span style="color: #b58900;">set</span> 'x 12) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 12</span>
x           <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 12</span>

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">They're self-evaluating</span>
(<span style="color: #b58900;">equal</span> <span style="color: #268bd2;">t</span>   '<span style="color: #268bd2;">t</span>)   <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
(<span style="color: #b58900;">equal</span> nil 'nil) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
(<span style="color: #b58900;">equal</span> <span style="color: #d33682; font-style: italic;">:x</span>  '<span style="color: #d33682; font-style: italic;">:x</span>)  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>

(<span style="color: #b58900;">equal</span> <span style="color: #d33682; font-style: italic;">:x</span> 'x)  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; nil</span>
</pre>
</div>

<p>
In particular, <code>:x ≠ 'x</code>!
</p>
</div>
</div>

<div id="outline-container-org67edf89" class="outline-3">
<h3 id="Sequence">Sequence</h3>
<div class="outline-text-3" id="text-Sequence">
<p>
<i>The interface for ordered collections</i>; e.g.,
the <code>(elt sequence index)</code> function can be applied to any sequence
to extract an element at the given index.
</p>

<div class="org-center">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>sequence</code></td>
<td class="org-left"><code>seq</code></td>
</tr>
</tbody>
</table>
</div>

<p>
The latter is an extensible variant of the former
&#x2014;for when we declare our own sequential data types.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">typep</span> '(1 2 3) 'sequence) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
</pre>
</div>

<p>
There are two immediate subtypes: <code>array</code> and <code>cons</code>, the latter has <code>list</code>
as a subtype.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">typep</span>  [1 2 3] 'array)       <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
(<span style="color: #b58900;">typep</span> '(1 2 3) '<span style="color: #b58900;">cons</span>)        <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
(<span style="color: #b58900;">typep</span> '(1 <span style="color: #2aa198;">"2"</span> 'three) '<span style="color: #b58900;">list</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
</pre>
</div>

<dl class="org-dl">
<dt>Array</dt><dd><p>
Arrays include strings and vectors.
</p>
<dl class="org-dl">
<dt>Vector</dt><dd>One-dimensional arrays.</dd>
<dt>Char-Table</dt><dd>One-dimensional sparse arrays indexed by characters.</dd>
<dt>Bool-Vector</dt><dd>One-dimensional arrays of <code>t</code> or <code>nil</code>.</dd>
<dt>Hash Table</dt><dd>Super-fast lookup tables.</dd>
</dl>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">typep</span> <span style="color: #2aa198;">"hi"</span> '<span style="color: #b58900;">string</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> 'hi  '<span style="color: #b58900;">string</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
</pre>
</div></dd>

<dt>Cons cell type</dt><dd><p>
Cons cells and lists, which are chains of cons cells.
</p>

<p>
These are objects consisting of two Lisp objects, called <code>car</code> and <code>cdr</code>.
That is they are pairs of Lisp objects.
</p>

<div class="org-src-container">
<pre class="src src-math">      '(x₀ x₁ x₂)
    ≈ '(x₀ . (x₁ . (x₂ . nil)))
    ≠ '(x₀ x₁ . x₂)
    ≈ '(x₀ . (x₁ . x₂))
</pre>
</div>

<p>
Notice that when there is no ‘.’, then a list
is just a nested cons chain ending in ‘nil’.
Note that <code>'(x₀ . x₁ . x₂)</code> is meaningless.
</p>

<p>
Cons cells are central to Lisp and so objects which are not a cons
cell are called <i>atoms</i>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">An atom is not a cons.</span>
(<span style="color: #b58900;">typep</span> 123 '<span style="color: #b58900;">atom</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
(<span style="color: #b58900;">typep</span> 'ni '<span style="color: #b58900;">atom</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
</pre>
</div>

<p>
Computationally:
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>(atom x)</code></td>
</tr>

<tr>
<td class="org-left">≈</td>
<td class="org-left"><code>(typep x 'atom)</code></td>
</tr>

<tr>
<td class="org-left">≈</td>
<td class="org-left"><code>(not (consp x))</code></td>
</tr>

<tr>
<td class="org-left">≈</td>
<td class="org-left"><code>(not (typep x 'cons))</code></td>
</tr>

<tr>
<td class="org-left">≈</td>
<td class="org-left"><code>(typep x '(not cons))</code></td>
</tr>
</tbody>
</table>

<p>
Interestingly, one writes <code>atom</code>, not <code>atomp</code>.
</p></dd>
</dl>
</div>
</div>

<div id="outline-container-org1bb7f0d" class="outline-3">
<h3 id="Function">Function</h3>
<div class="outline-text-3" id="text-Function">
<p>
<i>Piece of executable code.</i>
</p>

<p>
A non-compiled function in Lisp is a lambda expression: A list whose
first element is the symbol <code>lambda</code>.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">consp</span>     (<span style="color: #859900; font-weight: bold;">lambda</span> (x) x))        <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">functionp</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (x) x))        <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>

(<span style="color: #b58900;">functionp</span> (<span style="color: #859900; font-weight: bold;">lambda</span> is <span style="color: #b58900;">the</span> <span style="color: #b58900;">first</span>)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> (<span style="color: #859900; font-weight: bold;">lambda</span> stuff) '<span style="color: #b58900;">function</span>)  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
</pre>
</div>

<p>
It may help to know that a <code>defun</code> just produces an alias for a function:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">  (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">name</span> (args) <span style="color: #35a69c; font-style: italic;">"docs"</span> body)
&#8776; (<span style="color: #859900; font-weight: bold;">defalias</span> (<span style="color: #859900; font-weight: bold;">quote</span> name) (<span style="color: #859900; font-weight: bold;">function</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (args) docs body)))
</pre>
</div>

<p>
Here's some more examples.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">typep</span> #'<span style="color: #b58900;">+</span>   '<span style="color: #b58900;">function</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">typep</span> 'nice '<span style="color: #b58900;">function</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">it</span> (x) (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"%s"</span> (+1 x)))
(<span style="color: #b58900;">typep</span> #'it   '<span style="color: #b58900;">function</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">functionp</span> #'it)         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcdbdfd4" class="outline-3">
<h3 id="Macro">Macro</h3>
<div class="outline-text-3" id="text-Macro">
<p>
<i>A method of expanding an expression into another expression.</i>
</p>

<p>
Like functions, any list that begins with <code>macro</code>, and whose <code>cdr</code>
is a function, is considered a macro as long as Emacs Lisp is concerned.
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">macrop</span> '(macro (<span style="color: #859900; font-weight: bold;">lambda</span> (x) x))) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
</pre>
</div>

<p>
Since <code>defmacro</code> produces an alias, as follows,
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">  (<span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #b58900;">name</span> (args) <span style="color: #35a69c; font-style: italic;">"docs"</span> body)
&#8776; (<span style="color: #859900; font-weight: bold;">defalias</span> (<span style="color: #859900; font-weight: bold;">quote</span> name) (<span style="color: #b58900;">cons</span> (<span style="color: #859900; font-weight: bold;">quote</span> macro) (<span style="color: #859900; font-weight: bold;">function</span> (<span style="color: #859900; font-weight: bold;">lambda</span> (args) docs body))))
</pre>
</div>

<p>
You may be concerned that <code>(macrop x) ≟ (equal 'macro (car x))</code>, and so if a user
gives you a macro you might think its a cons cell of data.
Fortunately this is not the case:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #b58900;">no-op</span> () )

(<span style="color: #b58900;">macrop</span> #'no-op)    <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; true</span>
(<span style="color: #b58900;">consp</span>  #'no-op)    <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false; whence it's also not a list.</span>
(<span style="color: #b58900;">functionp</span> #'no-op) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>

(<span style="color: #b58900;">typep</span> #'no-op '
       (satisfies (<span style="color: #859900; font-weight: bold;">lambda</span> (x) (<span style="color: #859900; font-weight: bold;">and</span> (<span style="color: #b58900;">listp</span> x) (<span style="color: #b58900;">equal</span> 'macro (<span style="color: #b58900;">car</span> x)))))) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; false</span>
</pre>
</div>

<p>
Why not? Well, you could think of a macro as a ‘record’ whose label is <code>macro</code> and
its only element is the associated function.
</p>
</div>
</div>

<div id="outline-container-org729bdf7" class="outline-3">
<h3 id="Record">Record</h3>
<div class="outline-text-3" id="text-Record">
<p>
<i>Compound objects with programmer-defined types.</i>
</p>

<p>
They are the underlying representation of <code>defstruct</code> and <code>defclass</code> instances.
</p>

<p>
For example:
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defstruct</span> person
  name age)
</pre>
</div>

<p>
The <code>type-of</code> operator yields the <code>car</code> of instances of such declartions.
</p>
<table>


<colgroup>
<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>(record τ e₀ … eₙ) ≈ #s(τ e₀ … eₙ)</code></td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">setq</span> bobert (make-person <span style="color: #d33682; font-style: italic;">:name</span> <span style="color: #2aa198;">"bobby"</span> <span style="color: #d33682; font-style: italic;">:age</span> 'too-much))
(<span style="color: #b58900;">type-of</span> bobert) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; person</span>
</pre>
</div>

<p>
Componenets may be indexed with <code>aref</code>.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">aref</span> bobert 1)      <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; bobby</span>
(person-name bobert) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; bobby</span>
</pre>
</div>

<p>
A record is considered a constant for evaulation: Evaluating it yields itself.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">type-of</span> #s(person <span style="color: #2aa198;">"mark"</span> twelve)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; person</span>
(<span style="color: #b58900;">recordp</span> #s(nice))                 <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; t</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd029004" class="outline-2">
<h2 id="typing-via-macros">Typing via Macros &amp; Advice</h2>
<div class="outline-text-2" id="text-typing-via-macros">
<p>
Checking the type of inputs is tedious and so I <a href="https://www.reddit.com/r/emacs/comments/cct5hp/functional_type_declarations_in_elisp/">guessed</a> it could be done using
macros and advice. Looking at <a href="https://docs.racket-lang.org/ts-guide/types.html">Typed Racket</a> for inspiration, the following
fictitious syntax would add advice to <code>f</code> that checks the optional arguments <code>xᵢ</code>
have type <code>σᵢ</code> and the mandatory positional arguments have type <code>τᵢ</code> according
to position, and the result of the computation is of type <code>τ</code>.
To the best of my knowledge, no one had done this for Emacs Lisp &#x2014;I don't know why.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(declare-type 'f ((<span style="color: #d33682; font-style: italic;">:x&#8321;</span> &#963;&#8321;) &#8230; (<span style="color: #d33682; font-style: italic;">:x&#8344;</span> &#963;&#8344;)) (&#964;&#8321; &#8230; &#964;&#8345; &#964;))
</pre>
</div>

<p>
To modify a variable, or function, we may simply redefine it; but a much more elegant and powerful
approach is to <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Advising-Functions.html">“advise”</a> the current entity with some new behaviour. In our case of interest, we will
<i>advise functions to check their arguments before executing their bodies</i>.
</p>

<p>
Below is my attempt: <a id="orgad7ed90"><code>declare-type</code></a>. Before you get scared or think it's horrendous, be charitable and
note that about a third of the following is documentation and a third is local declarations.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">cl-defmacro</span> <span style="color: #b58900;">declare-type</span> (f key-types <span style="color: #b58900; font-style: italic;">&amp;rest</span> types)
  <span style="color: #35a69c; font-style: italic;">"Attach the given list of types to the function &#8216;f&#8217;</span>
<span style="color: #35a69c; font-style: italic;">   by advising the function to check its arguments&#8217; types</span>
<span style="color: #35a69c; font-style: italic;">   are equal to the list of given types.</span>

<span style="color: #35a69c; font-style: italic;">   We name the advice &#8216;&#10218;f&#10219;-typing-advice&#8217; so that further</span>
<span style="color: #35a69c; font-style: italic;">   invocations to this macro overwrite the same advice function</span>
<span style="color: #35a69c; font-style: italic;">   rather than introducing additional, unintended, constraints.</span>

<span style="color: #35a69c; font-style: italic;">   Using type specifiers we accommodate for unions of types</span>
<span style="color: #35a69c; font-style: italic;">   and subtypes, etc &#9829;&#8255;&#9829;.</span>

<span style="color: #35a69c; font-style: italic;">   &#8216;</span><span style="color: #6c71c4; font-weight: bold; font-style: italic;">key-types</span><span style="color: #35a69c; font-style: italic;">&#8217; should be of the shape (:x&#8320; t&#8320; &#8943; :x&#8345; t&#8345;);</span>
<span style="color: #35a69c; font-style: italic;">    when there are no optional types, use symbol &#8220;:&#8221;.</span>

<span style="color: #35a69c; font-style: italic;">    E.g., (declare-type my-func (:z string :w integer) integer symbol string)</span>
<span style="color: #35a69c; font-style: italic;">  "</span>

  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Basic coherency checks. When there aren't optional types, key-types is the &#8220;:&#8221; symbol.</span>
  (should (<span style="color: #859900; font-weight: bold;">and</span> (<span style="color: #b58900;">listp</span> types) (<span style="color: #859900; font-weight: bold;">or</span> (<span style="color: #b58900;">listp</span> key-types) (<span style="color: #b58900;">symbolp</span> key-types))))

  (<span style="color: #859900; font-weight: bold;">letf*</span> ((pairify (<span style="color: #859900; font-weight: bold;">lambda</span> (xs) (<span style="color: #859900; font-weight: bold;">loop</span> for i in xs by #'<span style="color: #b58900;">cddr</span>         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Turn a list of flattenned pairs</span>
                                      for j in (<span style="color: #b58900;">cdr</span> xs) by #'<span style="color: #b58900;">cddr</span>   <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">into a list of explicit pairs.</span>
                                      collect (<span style="color: #b58900;">cons</span> i j))))         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #dc8cc3;">MA</span><span style="color: #96A7A9; font-style: italic;">: No Lisp method for this!?</span>
         (result-type  (<span style="color: #b58900;">car</span> (<span style="color: #b58900;">-take-last</span> 1 types)))
         (types        (<span style="color: #b58900;">-drop-last</span> 1 types))
         (num-of-types (<span style="color: #b58900;">length</span> types))
         (key-types-og (<span style="color: #859900; font-weight: bold;">unless</span> (<span style="color: #b58900;">symbolp</span> key-types) key-types))
         (key-types    (<span style="color: #b58900;">funcall</span> pairify key-types-og))
         (advice-name  (<span style="color: #b58900;">intern</span> (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"%s-typing-advice"</span> f)))
         (notify-user  (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"%s now typed %s &#8594; %s &#8594; %s."</span>
                               `,f key-types-og types result-type)))

      `(<span style="color: #859900; font-weight: bold;">progn</span>
         (<span style="color: #859900; font-weight: bold;">defun</span> ,advice-name (orig-fun <span style="color: #b58900; font-style: italic;">&amp;rest</span> args)

           <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Split into positional and key args; optionals not yet considered.</span>
           (<span style="color: #859900; font-weight: bold;">letf*</span> ((all-args
                     (<span style="color: #b58900;">-split-at</span>
                       (<span style="color: #859900; font-weight: bold;">or</span> (<span style="color: #859900; font-weight: bold;">--find-index</span> (<span style="color: #b58900;">not</span> (<span style="color: #b58900;">s-blank?</span> (<span style="color: #b58900;">s-shared-start</span> <span style="color: #2aa198;">":"</span> (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"%s"</span> it)))) args) ,num-of-types)
                        args)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">The &#8220;or&#8221; is for when there are no keywords provided.</span>
                  (pos-args  (<span style="color: #b58900;">car</span> all-args))
                  (key-args  (<span style="color: #b58900;">funcall</span> ,pairify (<span style="color: #b58900;">cadr</span> all-args)))
                  (fun-result nil)
                  ((<span style="color: #b58900;">symbol-function</span> 'shucks)
                     (<span style="color: #859900; font-weight: bold;">lambda</span> (e&#964; e g)
                       (<span style="color: #859900; font-weight: bold;">unless</span> (<span style="color: #b58900;">typep</span> g e&#964;)
                         (<span style="color: #b58900;">error</span> <span style="color: #2aa198;">"%s: Type mismatch! Expected %s %s &#8800; Given %s %s."</span>
                                (<span style="color: #859900; font-weight: bold;">function</span> ,f) e&#964; e (<span style="color: #b58900;">type-of</span> g) (<span style="color: #b58900;">prin1-to-string</span> g))))))

         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Check the types of positional arguments.</span>
         (<span style="color: #859900; font-weight: bold;">unless</span> (<span style="color: #b58900;">equal</span> ,num-of-types (<span style="color: #b58900;">length</span> pos-args))
           (<span style="color: #b58900;">error</span> <span style="color: #2aa198;">"%s: Insufficient number of arguments; given %s, %s, but %s are needed."</span>
                  (<span style="color: #859900; font-weight: bold;">function</span> ,f) (<span style="color: #b58900;">length</span> pos-args) pos-args ,num-of-types))
         (<span style="color: #859900; font-weight: bold;">loop</span> for (ar ty pos) in (<span style="color: #b58900;">-zip</span> pos-args (<span style="color: #859900; font-weight: bold;">quote</span> ,types) (<span style="color: #b58900;">number-sequence</span> 0 ,num-of-types))
               <span style="color: #b58900;">do</span> (shucks ty (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"for argument %s"</span> pos) ar))

         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Check the types of *present* keys.</span>
         (<span style="color: #859900; font-weight: bold;">loop</span> for (k . v) in key-args
               <span style="color: #b58900;">do</span> (shucks (<span style="color: #b58900;">cdr</span> (<span style="color: #b58900;">assoc</span> k (<span style="color: #859900; font-weight: bold;">quote</span> ,key-types))) k v))

         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Actually execute the orginal function on the provided arguments.</span>
         (<span style="color: #859900; font-weight: bold;">setq</span> fun-result (<span style="color: #b58900;">apply</span> orig-fun args))
         (shucks (<span style="color: #859900; font-weight: bold;">quote</span> ,result-type) <span style="color: #2aa198;">"for the result type (!)"</span> fun-result)

         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Return-value should be given to caller.</span>
         fun-result))

      <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Register the typing advice and notify user of what was added.</span>
      (<span style="color: #b58900;">advice-add</span> (<span style="color: #859900; font-weight: bold;">function</span> ,f) <span style="color: #d33682; font-style: italic;">:around</span> (<span style="color: #859900; font-weight: bold;">function</span> ,advice-name))
      ,notify-user )))
</pre>
</div>

<p>
There are some notable shortcomings: Lack of support for type variables and, for now, no support for
optional arguments. Nonetheless, I like it &#x2014;of course.
( Using <a href="https://www.gnu.org/software/emacs/manual/html_node/elisp/Watching-Variables.html#Watching-Variables">variable watchers</a> we could likely add support for type variables as well as
function-types. )
</p>

<p>
<b>We accidentally forgot to consider an argument.</b>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(declare-type f&#8321; (<span style="color: #d33682; font-style: italic;">:z</span> <span style="color: #b58900;">string</span> <span style="color: #d33682; font-style: italic;">:w</span> <span style="color: #b58900;">list</span>) integer symbol <span style="color: #b58900;">string</span>)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8321; now typed (:z string :w integer) &#8594; (integer symbol) &#8594; string.</span>

(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">f&#8321;</span> (x y <span style="color: #b58900; font-style: italic;">&amp;key</span> z w) (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"%s"</span> x))
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8321; now defined</span>

(f&#8321; 'x) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8321;: Insufficient number of arguments; given 2, (x), but 3 are needed.</span>
</pre>
</div>
<p>
The type declaration said we needed 3 arguments, but we did not consider one of them.
</p>

<p>
<b>We accidentally returned the wrong value.</b>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(declare-type f&#8322; (<span style="color: #d33682; font-style: italic;">:z</span> <span style="color: #b58900;">string</span> <span style="color: #d33682; font-style: italic;">:w</span> <span style="color: #b58900;">list</span>) integer symbol <span style="color: #b58900;">string</span>)
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">f&#8322;</span> (x y <span style="color: #b58900; font-style: italic;">&amp;key</span> z w) x)

(f&#8322; 144 'two)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8322;: Type mismatch! Expected string for the result type (!) &#8800; Given integer 144.</span>
</pre>
</div>

<p>
<b>We accidentally forgot to supply an argument.</b>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(declare-type f&#8323; (<span style="color: #d33682; font-style: italic;">:z</span> <span style="color: #b58900;">string</span> <span style="color: #d33682; font-style: italic;">:w</span> <span style="color: #b58900;">list</span>) integer symbol <span style="color: #b58900;">string</span>)
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">f&#8323;</span> (x y <span style="color: #b58900; font-style: italic;">&amp;key</span> z w) (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"%s"</span> x))

(f&#8323; 144)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8323;: Insufficient number of arguments; given 1, (144), but 2 are needed.</span>
</pre>
</div>

<p>
<b>A positional argument is supplied of the wrong type.</b>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(f&#8323; 'one <span style="color: #2aa198;">"two"</span>)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658;  f&#8323;: Type mismatch! Expected integer for argument 0 &#8800; Given symbol one.</span>

(f&#8323; 144 <span style="color: #2aa198;">"two"</span>)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8323;: Type mismatch! Expected symbol for argument 1 &#8800; Given string "two".</span>
</pre>
</div>
<p>
Notice: When multiple positional arguments have type-errors, the errors are reported one at a time.
</p>

<p>
<b>A keyword argument is supplied of the wrong type.</b>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(f&#8323; 1 'two <span style="color: #d33682; font-style: italic;">:z</span> 'no&#8320; <span style="color: #d33682; font-style: italic;">:w</span> 'no&#8321;)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8323;: Type mismatch! Expected string :z &#8800; Given symbol no&#8320;.</span>

(f&#8323; 1 'two <span style="color: #d33682; font-style: italic;">:z</span> <span style="color: #2aa198;">"ok"</span> <span style="color: #d33682; font-style: italic;">:w</span> 'no&#8321;)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8323;: Type mismatch! Expected string :w &#8800; Given symbol no&#8321;.</span>

(f&#8323; 1 'two <span style="color: #d33682; font-style: italic;">:z</span> <span style="color: #2aa198;">"ok"</span> <span style="color: #d33682; font-style: italic;">:w</span> 23)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8323;: Type mismatch! Expected string :w &#8800; Given integer 23.</span>

(f&#8323; 1 'two <span style="color: #d33682; font-style: italic;">:z</span> <span style="color: #2aa198;">"ok"</span> <span style="color: #d33682; font-style: italic;">:w</span> '(a b 1 2)) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; okay; no type-error.</span>
</pre>
</div>

<p>
<b>We have no optional arguments.</b>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(declare-type f&#8324; : integer symbol <span style="color: #b58900;">string</span>)
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">f&#8324;</span> (x y <span style="color: #b58900; font-style: italic;">&amp;key</span> z w) (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"%s"</span> x))

(f&#8324; 144 'two <span style="color: #d33682; font-style: italic;">:z</span> <span style="color: #2aa198;">"bye"</span>)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658;  f&#8324;: Type mismatch! Expected nil :z &#8800; Given string "bye".</span>
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">( We shouldn't have any keyword :z according to the type declaration! )</span>

(f&#8324; 144 'two) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; "144"</span>
</pre>
</div>

<p>
<b>We can incorporate type specfiers such as unions!</b>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(declare-type f&#8325; : (<span style="color: #859900; font-weight: bold;">or</span> integer <span style="color: #b58900;">string</span>) <span style="color: #b58900;">string</span>)
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">f&#8325;</span> (x) (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"%s"</span> x))

(f&#8325; 144)     <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; "144"</span>
(f&#8325; <span style="color: #2aa198;">"neato"</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; "neato"</span>

(f&#8325; 'shaka-when-the-walls-fell)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8325;: Type mismatch! Expected (or integer string) for argument 0</span>
<span style="color: #96A7A9; font-style: italic;">;;       </span><span style="color: #96A7A9; font-style: italic;">&#8800; Given symbol shaka-when-the-walls-fell.</span>
</pre>
</div>

<p>
<b>No positional arguments but a complex optional argument!</b>
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(declare-type f&#8326; (<span style="color: #d33682; font-style: italic;">:z</span> (satisfies (<span style="color: #859900; font-weight: bold;">lambda</span> (it) (<span style="color: #859900; font-weight: bold;">and</span> (<span style="color: #b58900;">integerp</span> it) (<span style="color: #b58900;">=</span> 0 (<span style="color: #b58900;">mod</span> it 5))))))
                 character)
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">f&#8326;</span> (<span style="color: #b58900; font-style: italic;">&amp;key</span> z) ?A)

(f&#8326; 'hi)     <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658;  Keyword argument 144 not one of (:z)</span>
(f&#8326;)         <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 65; i.e., the character &#8216;A&#8217;</span>
(f&#8326; <span style="color: #d33682; font-style: italic;">:z</span> 6)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658;  f&#8326;: Type mismatch!</span>
<span style="color: #96A7A9; font-style: italic;">;;    </span><span style="color: #96A7A9; font-style: italic;">Expected (satisfies (lambda (it) (and (integerp it) (= 0 (mod it 5))))) :z</span>
<span style="color: #96A7A9; font-style: italic;">;;    </span><span style="color: #96A7A9; font-style: italic;">&#8800; Given integer 6.</span>

(f&#8326; <span style="color: #d33682; font-style: italic;">:z</span> 10) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 65; i.e., the expected output since 10 mod 5 &#8776; 0 &amp; so 10 is valid input.</span>
</pre>
</div>

<p>
<b>Preconditions!</b> The previous example had a complex type on a keyword, but that was
essentially a pre-condition; we can do the same on positional arguments.
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(declare-type f&#8327; : (satisfies (<span style="color: #859900; font-weight: bold;">lambda</span> (it) (<span style="color: #b58900;">=</span> it 5)))
                   integer)
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">f&#8327;</span> (n) n)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">The identity on 5 function; and undefined otherwise.</span>

(f&#8327; 4)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; f&#8327;: Type mismatch! Expected (satisfies (lambda (it) (= it 5))) for argument 0</span>
<span style="color: #96A7A9; font-style: italic;">;;       </span><span style="color: #96A7A9; font-style: italic;">&#8800; Given integer 4.</span>

(f&#8327; 5) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 5</span>
</pre>
</div>

<p>
<b>Postconditions!</b>
Given an integer greater than 5, we present an integer greater than 2; i.e.,
this is a constructive proof that \(∀ n • n > 5 ⇒ n > 2\).
</p>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(declare-type f&#8328; : (satisfies (<span style="color: #859900; font-weight: bold;">lambda</span> (in)  (<span style="color: #b58900;">&gt;</span> in 5)))
                   (satisfies (<span style="color: #859900; font-weight: bold;">lambda</span> (out) (<span style="color: #b58900;">&gt;</span> out 2))))
(<span style="color: #859900; font-weight: bold;">cl-defun</span> <span style="color: #b58900;">f&#8328;</span> (n) n)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">The identity on 5 function; and undefined otherwise.</span>

(f&#8328; 4)
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658;  f&#8328;: Type mismatch! Expected (satisfies (lambda (in) (&gt; in 5))) for argument 0</span>
<span style="color: #96A7A9; font-style: italic;">;;        </span><span style="color: #96A7A9; font-style: italic;">&#8800; Given integer 4.</span>

(f&#8328; 72) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#8658; 72; since indeed 72 &gt; 5 for the input, and clearly 72 &gt; 2 for the output.</span>
</pre>
</div>

<p>
As it currently stands we cannot make any explicit references between the inputs
and the output, but that's an easy fix: Simply add a local function <code>old</code> to the
<a href="#orgad7ed90"><code>declare-type</code></a> macro which is intentionally exposed so that it can be used in the
type declarations to refer to the ‘old’, or initial, values provided to the function.
Additionally, one could also add keyword arguments <code>:requires</code> and <code>:ensures</code>
for a more sophisticated pre- and post-condition framework.
<a href="https://github.com/sellout/quid-pro-quo">Something</a> along these lines is implemented for Common Lisp.
</p>

<p>
Here's a fun exercise: Recast the <a href="https://liquid.kosmikus.org/01-intro.html#/what-is-liquid-haskell">Liquid Haskell</a> examples in Lisp using this
<a href="#orgad7ed90"><code>declare-type</code></a> form.
</p>
</div>
</div>

<div id="outline-container-org9f3c0e2" class="outline-2">
<h2 id="Closing">Closing</h2>
<div class="outline-text-2" id="text-Closing">
<blockquote>
<p>
<i>I have heard more than one LISP advocate state such subjective comments as, "LISP is the most powerful and elegant programming language in the world" and expect such comments to be taken as objective truth. I have never heard a Java, C++, C, Perl, or Python advocate make the same claim about their own language of choice.</i>
</p>

<p>
---<a href="http://www.paulgraham.com/quotes.html">A guy on slashdot</a>
</p>
</blockquote>

<p>
I learned a lot of stuff, hope you did too ^_^
</p>
</div>
</div>

<div id="outline-container-org8f3b129" class="outline-2">
<h2 id="references">References</h2>
<div class="outline-text-2" id="text-references">
<p>
Neato web articles:
</p>
<ul class="org-ul">
<li><a href="http://blogs.perl.org/users/ovid/2010/08/what-to-know-before-debating-type-systems.html">What to know before debating type systems</a>
<ul class="org-ul">
<li>Debunks a number of fallacies such as
“dynamic typing provides no way to find bugs” and
“static types need type declarations”.</li>
</ul></li>
<li><a href="http://steve-yegge.blogspot.com/2008/05/dynamic-languages-strike-back.html">Dynamic Languages Strike Back</a>
<ul class="org-ul">
<li>Everything you might wanna know about dynamically checked languages.</li>
</ul></li>
<li><a href="http://www.ai.sri.com/~delacaze/alu-site/alu/table/contents.htm">The Association of Lisp Users</a>
<ul class="org-ul">
<li>Abundant resource relating to Lisp.</li>
</ul></li>
<li><a href="https://www.williamjbowman.com/blog/2018/01/19/untyped-programs-don-t-exist/#related">Untyped Programs Don’t Exist</a>
<ul class="org-ul">
<li>It's not a matter of typing but of pragmatics.</li>
</ul></li>
<li><a href="http://homes.sice.indiana.edu/jsiek/what-is-gradual-typing/">What is Gradual Typing</a>:
<ul class="org-ul">
<li>Discusses how static and dynamic typing can be used together hamroniously.</li>
</ul></li>
<li><a href="https://www.cliki.net/">CLiki &#x2014; The Common Lisp Wiki</a>
<ul class="org-ul">
<li>Contains resources for learning about
and using the   programming language Common Lisp.</li>
<li>The humour section is delightful.</li>
</ul></li>
<li><a href="http://www.cs.utexas.edu/users/boyer/ftp/diss/akers.pdf">Strong Static Type Checking for Functional Common Lisp</a>
<ul class="org-ul">
<li>PhD thesis regarding strong static type checking in an applicative subset of CL.</li>
</ul></li>
<li><a href="http://www.paulgraham.com/avg.html">Beating the Averages</a>
<ul class="org-ul">
<li>Paul Graham discusses “the most powerful language available” &#x2014;Lisp.</li>
<li>Other articles he's written about Lisp can be found <a href="http://www.paulgraham.com/lisp.html">here</a>.</li>
</ul></li>
<li><a href="http://www.marktarver.com/bipolar.html">The Bipolar Lisp Programmer</a>
<ul class="org-ul">
<li>“Lisp is, like life, what you make of it.”
Lisps attract a certain kind of personality.</li>
</ul></li>

<li>A <a id="org440f6ea">bunch of papers</a> on <a href="#org895d364">polymorphic</a> (modal) type systems
for Lisp-like multi-staged languages:
<a href="http://ropas.snu.ac.kr/lib/dock/KiYiCa2005.pdf">This</a> is generic, <a href="https://www.iro.umontreal.ca/~monnier/typer-jfla2019.pdf">this</a> is ML + Scheme, <a href="https://link.springer.com/chapter/10.1007/978-1-4615-2836-4_8">this</a> for compile-time typing,
and <a href="https://hal.archives-ouvertes.fr/hal-01380792/document">this</a> one “allows the programmer to declaratively express the types of
 heterogeneous sequences in a way which is natural in the Common Lisp language.”</li>

<li><a href="http://lambda-the-ultimate.org/node/5426">Type Systems as Macros</a>
<ul class="org-ul">
<li><p>
After defining <a href="#orgad7ed90"><code>declare-type</code></a> I thought the slogan “types by macros” sounded nifty;
Googling it led me to this paper where the Racket is endowed with types.
</p>

<p>
Lisp is great lol.
</p></li>
</ul></li>

<li><a href="https://twobithistory.org/2018/10/14/lisp.html">How Lisp Became God's Own Programming Language</a>
<ul class="org-ul">
<li>History and venerance of Lisp.</li>
</ul></li>

<li><a href="http://www.lispworks.com/documentation/lw51/CLHS/Body/04_bc.htm">Common Lisp HyperSpec</a> &#x2013; Type Specifiers</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://alhassy.github.io/tags.html">Tags</a>: <a href="https://alhassy.github.io/tag-types.html">types</a> <a href="https://alhassy.github.io/tag-lisp.html">lisp</a> <a href="https://alhassy.github.io/tag-program-proving.html">program-proving</a> <a href="https://alhassy.github.io/tag-emacs.html">emacs</a> </div>
<div class="post-date">12 Jan 2019</div><h1 class="post-title"><div class="title"><a href="https://alhassy.github.io/InteractiveWayToC.html">An Interactive Way To C</a></h1></div>
<center> <img src="images/interactive_way_to_c.png" alt="Article image" width="350" height="350" align="top" /> </center><br><center><strong>Abstract</strong></center>

<p>
Do you know what the above program accomplishes?
If you do, did you also spot a special edge case?
</p>

<p>
We aim to present an approach to program proving in C using a minimal Emacs setup
so that one may produce literate C programs and be able to prove them correct
&#x2013;or execute them&#x2013; using a single button press; moreover the output is again in Emacs.
</p>

<p>
The goal is to learn program proving using the Frama-C tool
&#x2013;without necessarily invoking its gui&#x2013; by loading the source of this file into
Emacs then editing, executing, &amp; proving as you read along.
One provides for the formal specification of properties of C programs &#x2013;e.g., using ACSL&#x2013;
 which can then be verified for the implementations using tools that interpret such annotation
&#x2013;e.g., Frama-C invoked from within our Emacs setup.
</p>

<p>
Read on, and perhaps you'll figure out how to solve the missing <code>FixMe</code> pieces 😉
</p>

<p>
The intent is for rapid editing and checking.
Indeed, the Frama-c gui does not permit editing in the gui, so one must switch between
their text editor and the gui.
<a href="https://orgmode.org/worg/org-tutorials/org4beginners.html">Org mode beginning at the basics</a> is a brief tutorial that covers a lot of Org and,
from the get-go, covers “the absolute minimum you need to know about Emacs!”
</p>

<p>
If anything, this effort can be construed as a gateway into interactive theorem proving
such as with Isabelle, Coq, or Agda.
</p>

<p>
The article <i>aims</i> to be self-contained &#x2013;not even assuming familiarity with any C!
</p>


<blockquote>
<p>
The presentation and examples are largely inspired by
</p>

<ul class="org-ul">
<li>Gilles Dowek's exquisite text <a href="https://www.springer.com/gp/book/9781848820319">Principles of Programming Languages</a>.
<ul class="org-ul">
<li>It is tremendously accessible!</li>
</ul></li>

<li>Allan Blanchard's excellent tutorial
<a href="https://allan-blanchard.fr/publis/frama-c-wp-tutorial-en.pdf">Introduction to C Program Proof using Frama-C and its WP Plugin</a>.</li>
</ul>

<p>
Another excellent and succinct tutorial is Virgile Prevosto's <a href="https://frama-c.com/download/acsl-tutorial.pdf">ACSL Mini-Tutorial</a>.
In contrast, the tutorial <a href="https://www.cs.umd.edu/class/spring2016/cmsc838G/frama-c/ACSL-by-Example-12.1.0.pdf">ACSL By Example</a> aims to provide a variety of algorithms
rendered in ACSL.
</p>
</blockquote>

<p>
There are no solutions since it's too easy to give up and look at the solutions that're
nearby. Moreover, I intend to use some of the exercises for a class I'm teaching ;-)
</p>

<div id="outline-container-orgdacd010" class="outline-2">
<h2 id="orgdacd010">Introduction</h2>
<div class="outline-text-2" id="text-orgdacd010">
<p>
Despite its age, C is a widely used language and so is available on many platforms.
Moreover, many systems rely on code historically written in C that needs to be maintained.
</p>

<p>
The traditional way to obtain confidence that a program correctly works is to provide
inputs we believe to be representative of the actual use of the program and
verify the results we get are correct. Incidentally, the unexpected cases are often not
considered whereas they are generally the most dangerous ones.
Since we cannot test everything, we need to employ great care in selecting good tests.
</p>

<p>
Since it is hard to answer “Is our software tested enough?”, we consider mathematically
proving that there cannot be problems at runtime. That is, a specification of the expected
behaviour is provided, which is satisfied by the <i>resulting</i> program
&#x2013;note the order: Specify <i>then obtain</i> code! This two-stage process can produce errors
in either stage, yet whereas testing ensures “the program avoids the bugs we tested against”
this approach is a big step ensuring “the program doesn't contain bugs that don't exist in
the specification.”
</p>

<p>
The goal here is to use a tool to learn the basics of C program proof
&#x2013;Frama-C: FRAmework for Modular Analysis of C code.
In particular, to demonstrate the ability to write programs without any error
by emphasising the simple notions needed to write programs more confidently.
</p>

<p>
Testing is ‘dynamic analysis’ since it requires the actual execution of programs,
whereas our program proof approach is ‘static’ since no execution is performed but instead
we reason on a semantic model of the reachable states.
The semantics associated with the C language control structures and statements we will
use is known as Hoare Logic. One writes a “Hoare Triple” <i>{G} S {R}</i> to express that
“Starting in a given state (satisfying) <i>G</i>, the execution of <i>S</i> terminates such that the
resulting state (satisfies) R”.
</p>

<p>
How does one <i>prove</i> such a triple? Programs are constructed from a variety of pieces,
so it suffices to look at each of those. That is, <i>{G} S {R}</i> has the code <i>S</i> transform
the required predicate <i>R</i> to the given <i>G</i> &#x2013;since we usually know what is required
and it is the goal of the program. In general, we find the <i>weakest</i> precondition that
works since then it allows the largest possible number of inputs;
if <i>G</i> is at least as strong as the weakest precondition, then our program is correct but
may allow less then the largest amount of possible inputs.
</p>

<p>
For example, <i>{5 ≤ x ≤ 10} x ≔ x + 1 { 3 ≤ x ≤ 11}</i> is a correct program that ends in state
<i>3 ≤ x ≤ 11</i>, however its precondition could be weakened to <i>2 ≤ x ≤ 10</i> thereby allowing
many more  valid inputs.
</p>

<p>
In Frama-C, we do not use curly braces like this for such assertions but instead
express our properties as code annotations using the ANSI C Specification Language
&#x2013;ACSL or “axel”. The weakest precondition plugin uses the annotation and the code to
automatically ensure the program is correct according to the Hoare Logic fashion
mentioned earlier.
</p>
</div>

<div id="outline-container-orgc498e68" class="outline-3">
<h3 id="orgc498e68">Getting Started</h3>
<div class="outline-text-3" id="text-orgc498e68">
<p>
The aim of this section is to introduce the Emacs controls that bring C to life within
literate code.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><span class="underline">Key Press</span></td>
<td class="org-left"><span class="underline">Elisp Command</span></td>
<td class="org-left"><span class="underline">Description</span></td>
</tr>

<tr>
<td class="org-left">Enter <code>&lt;s</code> then <code>TAB</code></td>
<td class="org-left">─</td>
<td class="org-left">Produces a “Hello World” C template program.</td>
</tr>

<tr>
<td class="org-left"><code>F6</code></td>
<td class="org-left"><code>(interpret)</code></td>
<td class="org-left">Execute currently focused code blocks in a new buffer.</td>
</tr>

<tr>
<td class="org-left"><code>F7</code></td>
<td class="org-left"><code>(show-code)</code></td>
<td class="org-left">Shows currently focused code blocks in a new buffer.</td>
</tr>

<tr>
<td class="org-left"><code>F8</code></td>
<td class="org-left"><code>(frama-c)</code></td>
<td class="org-left">Open the Frama-C gui on the currently focused code blocks.</td>
</tr>

<tr>
<td class="org-left"><code>F9</code></td>
<td class="org-left"><code>(frama-c-no-gui)</code></td>
<td class="org-left">Invoke Frama-C on the currently focused code blocks in a new buffer.</td>
</tr>
</tbody>
</table>

<p>
Which code blocks are currently under focus is controlled by the command
<code>(currently-working-with "nameHere")</code>, which produces a file <code>nameHere.c</code> that is used
for the utility functions. If multiple blocks use the same filename, then the file is
appended to.
While reading this tutorial, bring/take code blocks in/out of focus by
toggling between <code>(currently-working-with "nameHere")</code> and
<code>(not-currently-working-with "nameHere")</code> &#x2014;that is, simply prepend <code>not-</code>.
Remember to undo such a toggle when you're done with a code block.
</p>

<p>
When no name is provided to <code>[not-]currently-working-with</code>, the name of the buffer is used.
</p>
</div>

<div id="outline-container-orgc47f485" class="outline-4">
<h4 id="orgc47f485">Exercise: Hello World</h4>
<div class="outline-text-4" id="text-orgc47f485">
<ol class="org-ol">
<li>Insert the text <code>&lt;s</code> then press the <code>TAB</code> key.</li>
<li>A new C program template has appeared.</li>
<li>Press <code>F6</code> to execute the code in another buffer.</li>
<li>Press <code>F7</code> to inspect the code in another buffer.</li>
<li>Alter the program to output your name, press <code>F6</code>.</li>
</ol>

<p>
Now toggle that code block so that you are <code>not</code> currently working with it.
</p>
<ul class="org-ul">
<li>Make a change to the code block, such as printing 42. Notice that <code>F6</code> refers
to the old file on disk since there is no currently focused block.</li>
</ul>
</div>
</div>

<div id="outline-container-org4f2d9cd" class="outline-4">
<h4 id="org4f2d9cd">Exercise: Verifying Swap</h4>
<div class="outline-text-4" id="text-org4f2d9cd">
<p>
Consider the fully annotated <code>swap</code> algorithm, i.e., remove the <code>not-</code> prefix,
</p>
<div class="org-src-container">
<pre class="src src-c" id="orgdf00bd4"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">#include&lt;stdio.h&gt; // for IO</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@</span>
<span style="color: #96A7A9; font-style: italic;">requires \valid(a) &amp;&amp; \valid(b);</span>
<span style="color: #96A7A9; font-style: italic;">assigns *a, *b;</span>
<span style="color: #96A7A9; font-style: italic;">ensures *a == \old(*b);</span>
<span style="color: #96A7A9; font-style: italic;">ensures *b == \old(*a);</span>
<span style="color: #96A7A9; font-style: italic;">*/</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">swap</span>(<span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">a</span>, <span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">b</span>)
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">tmp</span> = *a;
  *a = *b;
  *b = tmp;
}

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">printf("Hello World!\n");</span>

  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span> = 42;
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">b</span> = 37;

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert Before_Swap</span><span style="color: #96A7A9; font-style: italic;">: a == 442 &amp;&amp; b == 37;</span>
  swap(&amp;a, &amp;b);
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert After_Swap</span><span style="color: #96A7A9; font-style: italic;">: a == 37 &amp;&amp; b == 42;</span>

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
We can see that Frama-C proves these assertions by obtaining “green bullets”
beside them if we execute
</p>
<pre class="example">
frama-c-gui -wp -rte myfile.c
</pre>
<p>
Or check-boxes beside them if we instead execute
</p>
<pre class="example">
frama-c-gui -gui-theme colorblind -wp -rte myfile.c
</pre>
<p>
The best way to know which options are available is to use
</p>
<pre class="example">
frama-c -wp-help
</pre>

<p>
We will however use the special Emacs calls defined at the bottom of this file,
<code>frama-c</code> and <code>frama-c-no-gui</code>, to avoid having to switch between a terminal and a
text editor. Thank-you extensible editor Emacs ⌣̈ ♥
</p>

<ul class="org-ul">
<li>Press <code>F8</code> to invoke the Frama-C gui.</li>
<li>Press <code>F9</code> to invoke Frama-C within Emacs and obtain status about the program proof.</li>
</ul>

<p>
If you uncomment the IO matter, Frama-C may yield an error.
<b>Separate your IO into its own driver file!</b>
Invoke Frama-C only on programs you want to prove &#x2013;without any IO.
</p>

<p>
Go back to the above example, and change the first assertion in <code>main,
~a == 42</code>, to assert that <code>a</code> equals <code>432</code>. Now invoke <code>M-x framac-no-gui</code>, or press <code>F9</code>,
to obtain the message,
</p>
<pre class="example">
Frama-C: 90﹪ of proof complete!
</pre>
<p>
Moreover, another buffer will be open and in red will be highlighted,
</p>
<pre class="example">
[wp] [Alt-Ergo] Goal typed_main_assert_Before_Swap : Unknown (Qed:0.63ms) (57ms)
</pre>
<p>
This indicates that, in method <code>main</code>, the named assertion <code>Before_Swap</code> could not be proven.
</p>

<p>
Now revert all alterations and in the specification of <code>swap</code>, alter
<code>ensures *a ==== \old(*b);</code> to become <code>ensures *a == \old(*a);</code>, thereby expressing
that the value of <code>a</code> is unaltered by the program. Checking this yields a false
assertion! Neato.
</p>

<p>
As such, I suggest the following literate process:
</p>
<ol class="org-ol">
<li>Write your code in Org-mode code blocks,</li>
<li>Check it works with <code>frama-c-no-gui</code> (F9) or <code>frama-c</code> (F8).
<ul class="org-ul">
<li>If we open the gui, we may right-click on a function name and select
<code>Prove function annotations by WP</code> to have our assertions checked.</li>
<li>Remember that the frama-c gui does not allow source code edition.</li>
</ul></li>
<li>Investigate output, then make changes in source file and re-check.</li>
</ol>

<p>
Observe
</p>
<ul class="org-ul">
<li>Program proof is a way to ensure that our programs only have correct behaviours,
described by our specification;</li>
<li>It is still our work to ensure that this specification is correct.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgce18f2d" class="outline-3">
<h3 id="orgce18f2d">A Prelude</h3>
<div class="outline-text-3" id="text-orgce18f2d">
<p>
Since C's <code>#include</code> is essentially a copy-paste, we can re-export other libraries
from a make-shift ‘Prelude’.
</p>

<div class="org-src-container">
<pre class="src src-c" id="org4e9f32d">
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Artefacts so that exercises let the system progress as much as possible.</span>
<span style="color: #96A7A9; font-style: italic;">//</span>
<span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ predicate Exercise = \false;</span>
<span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ predicate FixMe = \false;</span>
<span style="color: #268bd2; font-weight: bold;">#define</span> <span style="color: #268bd2;">FixMeCode</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Tendency to require this header file to specfiy avoidance of overflow.</span>
<span style="color: #96A7A9; font-style: italic;">//</span>
<span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;limits.h&gt;</span>
</pre>
</div>

<p>
We will continue to be <code>(currently-working-with "Prelude")</code> in the future to add more
content. For now, we put the artefacts needed to let the exercises pass.
</p>

<blockquote>
<p>
The use of <code>\false</code> is not the most appropriate, since its occurrence in a precondition
  vacuously makes everything true! This is something that should change.
</p>

<p>
The current setup produces only <code>.c</code> files, whence we use the prelude by declaring
<code>#include "Prelude.c".</code> Forgive my use of a <code>.c</code> file in-place of a header file.
The alternative is to force all code block names to end in a <code>.c</code>.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-org6e55571" class="outline-2">
<h2 id="org6e55571">Basic Constructs</h2>
<div class="outline-text-2" id="text-org6e55571">
<p>
Recall that a Hoare Triple <i>{G} S {R}</i> expresses that if execution of program <code>S</code> is begun
in a state satisfying proposition <i>G</i> then it terminates in a state satisfying proposition <i>R</i>.
We usually know <i>R</i> &#x2013;it is the required behaviour on <code>S</code> after all&#x2013; but otherwise we usually
only have a vague idea of what <i>G</i> could possible be.
Dijkstra's <i>weakest precondition</i> operator ‘wp’ tells us how to <b>compute</b> <i>G</i> from <i>R</i>
&#x2013;in the process we usually <b>discover</b> <code>S</code>.
</p>

<p>
Hence, all in all, programming begins with the required goal from which code is then derived.
</p>

<details>
<p>
Post-conditions <i>R</i> are expressed using the <code>ensures</code> clause, and dually pre-conditions <i>G</i>
are expressed using <code>requires</code> clauses. These <i>G</i> are properties assumed for the input
and it is the callers responsibility to ensure that they are true
&#x2013;recall that when a contract is breached, the implementation may behave arbitrarily.
</p>
</details>

<p>
Since ‘wp’ is intended to <b>compute</b> the weakest precondition establishing a given
postcondition <i>R</i> for a statement <code>S</code>, it necessarily satisfies
</p>
<pre class="example">
    { G } S { R }   ≡   G ⇒ wp S R
</pre>

<p>
The left side may be rendered using ACSL,
</p>
<pre class="example">
// @ assert G;
S;
// @ assert R;
</pre>

<p>
The WP plugin for Frama-C essentially works by computing <code>wp S R</code> then attempts to obtain
a proof for <code>G ⇒ wp S R</code>.
In particular, by the reflexivity of implication, ‘wp’ guarantees to produce a
precondition so that the following Hoare triple is valid.
</p>
<pre class="example">
   { wp S R } S { R }
</pre>

<p>
Most programming languages have, among others, five constructs:
Assignment, variable declaration, sequence, test, and loop.
These constructs from the <i>imperative core</i> of the language.
Since programs are built using such primitive control structures, it suffices to define
wp “by induction” on the shape of <code>S</code>.
</p>

<p>
One reasonable property we impose on wp from the outset is: <br>
If <i>S</i> establishes <i>R</i> which implies <i>R′</i>, then <i>S</i> also establishes <i>R′</i>.
</p>
<pre class="example">
Monotonicity: R ⇒ R′   implies  wp S R ⇒ wp S R′
                       That is, {wp S R} S {R′}
</pre>
<p>
Whence for each definitional clause of wp, we must ensure this desirable property is held.
</p>

<details>
<p>

</p>

<p>
Imperative programs alter state, as such a statement <code>S</code> is essentially a function
that transforms the memory state of the computer.
Expressing in English what happens when a statement is executed is possible
for simple examples, but such explanations quickly become complicated and imprecise.
Therefore, one introduces a theoretical framework reifying statements as state transformers.
</p>

<p>
The two popular notions are the “forwards” <code>⟦S⟧</code> moves current state to a new state,
whereas we are working with “backwards” <code>wp S</code> which takes a desired state and yields
a necessary previous state. The forward notion ‘executes’ a program by starting in
the empty state and stepping through each command to result in some final state.
Whereas the backwards notion takes an end goal and suggests which programming constructs
are needed to obtain it.
Hence, ‘forwards’ is verification whereas ‘backwards’ is correct-by-construction
programming.
</p>

<p>
Suppose there is an infinite set <code>Var</code> of variables and an infinite set <code>Val</code> of values,
which are integers, booleans, etc. In the ‘forwards’ notion, a <i>state</i> is a partial
function from variables to values &#x2013;`partial' since it may be undefined at some
variables, since we usually use only finitely many
in our programs anyways. E.g., state <code>{x ↦ 5, y ↦ 6}</code> associates the value 5 to variable <code>x</code>
but is undefined for variable <code>z</code>. Dually, in the ‘backwards’ notion, a <i>state</i> is a predicate of the
variables and their values that satisfy the predicate; e.g., the previous example state
corresponds to the predicate <code>x = 5 ∧ y = 6</code>, where <code>z</code> can have <i>any</i> value.
Hence the predicate formulation is more relaxed and we shall refer to it instead.
</p>
</details>
</div>

<div id="outline-container-orgd99ca08" class="outline-3">
<h3 id="orgd99ca08">Assignment</h3>
<div class="outline-text-3" id="text-orgd99ca08">
<p>
The <i>assignment</i> construct allows the creation of a statement with a variable
<code>x</code> and an expression <code>E</code>. The assignment statement is written <code>x = E;</code>.
</p>
<ul class="org-ul">
<li>Variables are identifiers which are written with one or more letters.</li>
<li>Expressions are composed of variables, constants, and operator calls.</li>
<li>Sometimes one <i>notates</i> assignment by <code>x ≔ E</code> even though it is invalid C code.</li>
</ul>

<p>
To understand the execution of an assignment, suppose that within the
recesses of your computer's memory, there is a compartment labelled <code>x</code>.
Obtain the <i>value</i> of <code>E</code> &#x2013;possibly having to look up values of variables
that <code>E</code> mentions&#x2013; then erase the contents of <code>x</code> and fill the compartment
with the newly obtained value.
</p>

<p>
The whole of the contents of the computer's memory is called a <i>state</i>.
We also say “predicate <i>R</i> is the current state” as shorthand for:
The current state is (non-deterministically) <i>any</i> variable-value assignment
such that predicate <i>R</i> is true.
</p>

<p>
All in all, executing <code>x ≔ E</code> loads memory location <code>x</code> with the value of expression <code>E</code>;
hence state <i>R</i> is satisfied after an assignment precisely when it is satisfied
with variable <code>x</code> replaced by expression <code>E</code>. For example, <code>wp (x ≔ x+1) (x = 5)  ≡  (x+1 = 5)</code>.
</p>
<pre class="example">
wp (x ≔ E) R  ≡  R[x ≔ E]
</pre>

<p>
Before being able to assign values to a variable <code>x</code>, it must be <i>declared</i>,
which associates the name <code>x</code> to a location in the computer's memory.
<i>Variable declaration</i> is a construct that allows the creation of a statement
composed of a variable, an expression, and a statement. This is written
<code>{T x = e; p}</code>, then variable <code>x</code> can be used in statement <code>p</code>, which is called
the <i>scope</i> of variable <code>x</code>.
( When <code>p</code> has no assignments, functional programmers would call this statement
  a <i>let statement</i> since it lets <code>x</code> take on the value <code>e</code> in <code>p</code>. )
</p>

<details>
<ul class="org-ul">
<li>Division:
If both arguments are integers, then the operation rounds down; write, e.g., <code>5 / 2.0</code>
to mark the result as floating point.</li>

<li>Modulo: The number <code>a % b</code> is <code>a - b * (a / b).</code></li>

<li>Ternary Conditional: For all types, the expression <code>(c) ? t : f</code>
yields <code>t</code> if boolean <code>c</code> holds and is <code>f</code> otherwise.</li>

<li>A useful inclusion: <i>2*10<sup>9</sup> &lt;= 2<sup>32</sup> &lt;= 2*10<sup>10</sup></i></li>
</ul>
</details>
</div>

<div id="outline-container-org1cfeebb" class="outline-4">
<h4 id="org1cfeebb">Overshadowing &amp; Explicit Scope Delimitation</h4>
<div class="outline-text-4" id="text-org1cfeebb">
<p>
Imperative languages generally do not allow the declaration of the same variable multiple
times, e.g., the following program crashes with <code>error: redefinition of ‘x’</code>.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = 3;
  printf(<span style="color: #2aa198;">"x has value: %d"</span>, x);

  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = 4;
  printf(<span style="color: #2aa198;">"x has value: %d"</span>, x);

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
<p>
However, if we <i>explicitly delimit the scope</i> of a variable by using braces, then we can
obtain multiple declarations:
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = 3;
  printf(<span style="color: #2aa198;">" x has value: %d"</span>, x);  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">3</span>

  { <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = 4;
    printf(<span style="color: #2aa198;">"\n x has value: %d"</span>, x); <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">4</span>
  }
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
When explicitly delimiting scope, it is the most recent declarations
that are used. We say that earlier declarations are <i>hidden</i>, or <i>overshadowed</i>,
by the later declarations.
</p>

<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = 3;

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert x == 3;</span>

  { <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Begun new scope</span>

    <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Old facts are still true.</span>
    <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert x == 3;</span>

    <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Now overshadowing &#8216;x&#8217;</span>
    <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = 4;

    <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">This new &#8216;x&#8217; is equal to 4.</span>
    <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert x == 4;</span>
  }

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Back to the parent scope.</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">In this scope, &#8216;x&#8217; still has its orignal value.</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert x == 3;</span>

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-org4160c1e" class="outline-4">
<h4 id="org4160c1e">Constant Variables</h4>
<div class="outline-text-4" id="text-org4160c1e">
<p>
<i>Constant variables</i> are variables which may have only one initial value that
can never be changed. A non-constant variable is called <i>mutable</i>, which is
the default in imperative languages. For example, the following
crashes with <code>error: assignment of read-only variable ‘x’</code>.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = 3;
  x = 4;
  printf(<span style="color: #2aa198;">"x has value: %d"</span>, x);

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3924ef4" class="outline-3">
<h3 id="org3924ef4">Sequence</h3>
<div class="outline-text-3" id="text-org3924ef4">
<p>
A <i>sequence</i> is a construct that allows a single statement to be created out of
two statements <code>p</code> and <code>q</code>; it is written <code>{p q}</code>.
The sequence is executed in state <code>s</code> by first executing <code>p</code> in state <code>s</code> thereby
producing a new state <code>s'</code> in which statement <code>q</code> is then executed.
</p>
<ul class="org-ul">
<li>The statement <code>{p₁ {p₂ { ... pₙ } ...}}</code> can also be written <code>{p₁ p₂ ... pₙ}</code>.</li>
</ul>

<p>
Usually a ‘;’ symbol is used in favour of a space, with braces, to yield,
</p>
<pre class="example">
wp (S₁;S₂) R  ≡  wp S₁ (wp S₂ R)
</pre>
<p>
The pre-condition of the second statement becomes the post-condition of the first
statement. Hence, we “push” along the post-condition into a sequence:
In the upcoming swapping example, we read the proof steps from bottom to top!
</p>

<p>
Rendered pointfree, i.e., ignoring <i>R</i>, this rule becomes: <i>wp (S₁;S₂)  = wp S₁ ∘ wp S₂</i>.
</p>

<p>
Recall that we need to ensure monotonicity is satisfied, and indeed: If <i>R ⇒ R′</i>, then
</p>
<pre class="example">
  wp (S₁;S₂) R
≡ wp S₁ (wp S₂ R)    -- Definition of wp on sequence
⇒ wp S₁ (wp S₂ R′)   -- Monotoncity for Sᵢ, twice; with assumption R ⇒ R′
≡ wp (S₁;S₂) R      -- Definition of wp on sequence
</pre>
<p>
Neato!
</p>

<p>
Moreover, notice we have the useful ‘transitivity’ property for Hoare triples:
</p>
<pre class="example">
   {G} S₁ {R′}  ∧  {R′} S₂ {R}
≡  (G ⇒ wp S₁ R′)  ∧  (R′ ⇒ wp S₂ R)              -- Characterisation of wp
⇒ (G ⇒ wp S₁ R′)  ∧  (wp S₁ R′ ⇒ wp S₁ (wp S₂ R)) -- Monotonicity of wp
⇒ (G ⇒ wp S₁ (wp S₂ R))                           -- Transitivity of implication
≡  G ⇒ wp (S₁;S₂) R                               -- Definition of wp on sequence
≡  {G} S₁;S₂ {R}                                  -- Characterisation of wp
</pre>

<p>
Exercise: Show that <code>wp (x ≔ E; S) R  ≡  (wp S R)[x ≔ E]</code>.
</p>
</div>
</div>

<div id="outline-container-org47d57d3" class="outline-3">
<h3 id="org47d57d3">Skip</h3>
<div class="outline-text-3" id="text-org47d57d3">
<p>
The “empty sequence” is denoted <code>{}</code> or just <code>;</code> in the C language.
It is also commonly known as the <code>skip</code> construct and its importance is akin to that
of zero to addition.
</p>

<pre class="example">
wp skip R  ≡  R
</pre>
<p>
The “do nothing” program <code>skip</code> is rendered as simple <code>;</code> or as whitespace in the C language.
This program does not alter the state at all, thus it truthifies <i>R</i> precisely when <i>R</i>
was true to begin with.
</p>

<p>
Most often this appears in a weakening/strengthening form,
</p>
<pre class="example">
...code here...
//@ assert P;
//@ assert Q;
...code here...
</pre>
<p>
Where <i>P ⇒ Q</i> is provable.
</p>

<p>
More concretely,
</p>
<div class="org-src-container">
<pre class="src src-c" id="org06aaeb0"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires 3 &lt; a &lt; 9;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures  -20 &lt;= \result &lt;= 99;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">using_skip</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span>)
{
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert our_strong_pre</span><span style="color: #96A7A9; font-style: italic;">:         3 &lt; a &lt; 9;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert weakened_intermediary</span><span style="color: #96A7A9; font-style: italic;">: -7 &lt;= a &lt;= 14;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert weakening_futher</span><span style="color: #96A7A9; font-style: italic;">:     -20 &lt;= a &lt;= 99;</span>
  <span style="color: #859900; font-weight: bold;">return</span> a;
}
</pre>
</div>
<p>
Woah! It looks like the identity function somehow transforms input satisfying
<i>3 &lt; x &lt; 9</i> to input satisfying <i>-20 ≤ x ≤ 99</i>.
Wait, the former implies the latter and that's just the definition of <i>wp</i> on <code>skip</code>.
</p>

<p>
The above example suggests the following calculation,
</p>
<pre class="example">
   (G′ ⇒ G)  ∧  {G} S {R}  ∧  (R ⇒ R′)
≡  (G′ ⇒ G)  ∧  (G ⇒ wp S R)  ∧  (R ⇒ R′) -- Characterisation of wp
⇒ (G′ ⇒ wp S R)  ∧  (R ⇒ R′)              -- Transitivity of implication
⇒ (G′ ⇒ wp S R)  ∧  (wp S R ⇒ wp S R′)    -- Monotonicity of wp
⇒ (G′ ⇒ wp S R′)                          -- Transitivity of implication
≡  {G′} S {R′}                            -- Characterisation of wp
</pre>
<p>
That is, strengthening the precondition or weakening the post-condition leaves
a Hoare triple valid. In some industry circles &#x2013;e.g., C#&#x2013;, this is referred to as
contravariance (antitone) in the input and covariance (monotone) in the output.
</p>

<p>
For example, if <code>G′, G, R, R′</code> were classes such that <code>G′</code> is a subclass of <code>G</code>
and <code>R</code> is a subclass of <code>R′</code>, then the program <code>S</code> takes an input of type <code>G</code> yielding an
output of type <code>R′</code>. However, any input of type <code>G′</code> can be cast into the parent-class
type <code>G</code> and, likewise, <code>R</code> objects can be cast into the parent-type <code>R′</code>.
Thus, program <code>S</code> can also take the type of <code>G′</code> to <code>R′</code>.
</p>

<p>
Writing <code>&lt;:</code> for ‘sub-type’, or ‘sub-class’, we have argued,
</p>
<pre class="example">
Provided    G′ &lt;: G  and R &lt;: R′
Then
       G → R  &lt;:  G′ → R′
</pre>
<p>
It is now easier to see that the second argument of function-type former ‘→’ stays
on the same side of the <code>&lt;:</code> symbol, whereas it is flipped for the first argument.
</p>

<p>
Completely unrelated &#x2013;or not&#x2013; a nearly identical property holds for implication:
If <i>G′ ⇒ G</i> and <i>R ⇒ R′</i> then (G ⇒ R) ⇒ (G′ ⇒ R′). How coincidental &#x2026; or not!
\\ ( Foreshadowing: Curry-Howard Correspondence! )
</p>

<p>
Anyhow, this strengthening-weakening law will be useful when computing the <i>wp</i> of a
statement directly is difficult &#x2013;and possibly unhelpful&#x2013; but we have a stronger
precondition and so it suffices to use that.
( Foreshadowing: Loops! )
</p>

<p>
Before we close, here is an <b>exercise</b> to the reader: An alternate proof of the above law.
</p>
<pre class="example">
   (G′ ⇒ G)  ∧  {G} S {R}  ∧  (R ⇒ R′)
≡  {G′} skip {G} ∧ {G} S {R} ∧ {R} skip {R′}    -- ???
⇒ {G′} skip; S {R} ∧ {R} skip {R′}             -- ???
⇒ {G′} skip; S; skip {R′}                      -- ???
≡  {G′} S {R′}                                  -- skip is no-op &amp; can be removed.
</pre>

<p>
The last hint in the above calculation deserves some attention.
</p>
<ol class="org-ol">
<li>Rendered pointfree, i.e., ignoring <i>R</i>, the skip rule becomes: <i>wp skip  = id</i>.
<ul class="org-ul">
<li>Where <i>id</i> is the identity function: <i>id(x) = x</i>.</li>
</ul></li>
<li>“Program Equality”: Say <code>S ≈ T</code> precisely when <code>wp S = wp T</code>.
<ul class="org-ul">
<li>Two programs are considered equal precisely when they have the same
<i>observational</i> behaviour &#x2013;i.e., can satisfy the same set of post-conditions <i>R</i>.</li>
</ul></li>
<li>Identity of Sequence Theorem: <code>S ; skip  ≈  S  ≈  skip ; S</code>.</li>
<li>Likewise, define <i>wp abort R ≡ false</i>  &#x2013; i.e., <code>abort</code> is a program that crashes on
any input.</li>
<li>Zero of Sequence Theorem: <code>S ; abort  ≈  abort  ≈  abort ; S</code>.</li>
</ol>
</div>
</div>

<div id="outline-container-org40812e0" class="outline-3">
<h3 id="org40812e0">Examples Using the Assignment, Sequence, Skip Rules</h3>
<div class="outline-text-3" id="text-org40812e0">
<p>
To avoid having to write the verbose <code>\at(x, Pre)</code> to refer to the value of a variable <code>x</code>
before method execution, we may use a <i>ghost variable</i>: A variable whose purpose is only
to make the assertions provable, and otherwise is not an execution-relevant variable.
</p>

<div class="org-src-container">
<pre class="src src-c" id="org70d3eec"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;limits.h&gt;</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires \valid(x) &amp;&amp; \valid(y);</span>
<span style="color: #96A7A9; font-style: italic;">  @ requires INT_MIN &lt; *x + *y &lt; INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ requires \separated(x, y); // Exercise</span><span style="color: #96A7A9; font-style: italic;">: It's a swap, why is this needed?</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns *x, *y;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">swap</span>(<span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">x</span>, <span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">y</span>)
{
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ ghost int X = *x;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ ghost int Y = *y;</span>

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert  *y == Y  &amp;&amp; *x == X;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert  *y == Y  &amp;&amp; (*x + *y) - *y == X;</span>
  *x = *x + *y;
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert  *y == Y  &amp;&amp; *x - *y == X;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert  *x - (*x - *y) == Y  &amp;&amp; *x - *y == X;</span>
  *y = *x - *y;
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert  *x - *y == Y  &amp;&amp; *y == X;</span>
  *x = *x - *y;
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert  *x == Y  &amp;&amp; *y == X;</span>

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&#120034;&#120061;&#120042;&#120059;&#120061; upwards reading from here;</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">each assertion is obtained by the assigment, skip, and sequence rules.</span>
}
</pre>
</div>

<p>
Here is a more complicated exercise that also makes use of external functions&#x2026;
</p>

<details>
<p>

</p>

<div class="org-src-container">
<pre class="src src-c" id="org3d0cd9d"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>

<span style="color: #268bd2; font-weight: bold;">#define</span> <span style="color: #268bd2;">RAND_MAX</span> 32767

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns \nothing;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures 0 &lt;= \result &lt;= RAND_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">*/</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">rand</span>();

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires min &lt;= max;</span>
<span style="color: #96A7A9; font-style: italic;">  @ requires min + RAND_MAX &lt; INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">  @ requires max - min &lt; INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns \nothing;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures min &lt;= \result &lt;= max;</span>
<span style="color: #96A7A9; font-style: italic;">*/</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">random_between</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">min</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">max</span>)
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">it</span> = rand();
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert weakening</span><span style="color: #96A7A9; font-style: italic;">: 0 &lt;= it &lt;= RAND_MAX;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert assignment_rule_again</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
  it = it % (max - min + 1);
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #b58900;">@ assert simplify</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #b58900;">@ assert assignment_rule</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
  it = it + min;
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">@ assert min &lt;= it;</span>

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Start at the bottom, and push assertion upwards!</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">The assertion names are also intended to be read upwards;</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Each justifies how it was obtained.</span>

  <span style="color: #859900; font-weight: bold;">return</span> it;

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">That is,</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">return (rand() % (max - min + 1)) + min;</span>
}
</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-orgecf5d94" class="outline-3">
<h3 id="orgecf5d94">Test; Conditional</h3>
<div class="outline-text-3" id="text-orgecf5d94">
<p>
A <i>test</i> is a statement formed from a Boolean expression and two statements; it is
written \\ <code>if (b) p else q</code> &#x2013;sometimes a ‘then’ keyword is used for readability, but
such is not valid C code.
This is executed in a state by evaluating the Boolean
then deciding which branch to execute in the same state.
</p>

<pre class="example">
wp (if B then S₁ else S₂) R  ≣  if B then wp S₁ R else wp S₂ R
                             ≡ (B ⇒ wp S₁ R) ∧ (¬ B ⇒ wp S₂ R)
</pre>
<p>
A conditional ensures <i>R</i> precisely when its branches each ensure <i>R</i>.
</p>

<p>
Observe the following calculation,
</p>
<pre class="example">
   { G } if B then S₁ else S₂ { R }
≡  G ⇒ wp (if B then S₁ else S₂) R         -- Characterisation of wp
≡  G ⇒ (B ⇒ wp S₁ R) ∧ (¬ B ⇒ wp S₂ R)     -- Definition of wp on conditional
≡  (G ⇒ B ⇒ wp S₁ R) ∧ (G ⇒ ¬ B ⇒ wp S₂ R) -- Characterisation of meets
≡  (G ∧ B ⇒ wp S₁ R) ∧ (G ∧ ¬ B ⇒ wp S₂ R) -- Shunting
≡  {G ∧ B} S₁ {R}  ∧  {G ∧ ¬ B} S₂ {R}     -- Characterisation of wp
</pre>
<p>
That is, Hoare triples on a conditional ‘distribute’ into the branches
with each branch precondition obtaining the branch guard.
</p>
</div>
</div>

<div id="outline-container-org58f6553" class="outline-3">
<h3 id="org58f6553">Loop</h3>
<div class="outline-text-3" id="text-org58f6553">
<p>
A <i>loop</i> is a construct formed from a Boolean expression and a statement; it is
written <code>while (b) p</code>.
A loop is one of the ways in which we can express an infinite object &#x2013;which may
fail to terminate&#x2013; using a finite expression. Indeed, its executional behaviour
can be understood by realising it as a shorthand for the expression
</p>
<pre class="example">
if (b) {p if (b) {p if (b) ...
                    else skip}
          else skip}
else skip
</pre>
<p>
Where <code>skip</code> is the fictional statement that performs no action when executed.
</p>

<p>
To understand the semantics of the loop:
</p>
<ol class="org-ol">
<li>Let <code>giveup, terminate</code> be aliases for <code>abort</code> and <code>skip</code>.</li>
<li><p>
Recalling that a loop is a shorthand for an infinite nesting of conditionals,
we try to approach it as a limit of finite approximations.
</p>
<pre class="example">
     while (b) q  ≈  limₙ pₙ

  Where:
  p₀ = if (b) giveup else terminate
  p₁ = if (b) {q ; if b giveup else terminate} else terminate
  ⋯
  pₙ₊₁ = if (b) {q; pₙ} else terminate;
</pre></li>

<li>The statement <code>pₙ</code> tries to execute the statement <code>while (b) q</code> by completing
a maximum of <code>n</code> trips through the loop. If, after <code>n</code> loops, it has not
terminated on its own, it gives up.</li>

<li><p>
If the loop terminates in <i>m</i> trips, it also terminates in <i>n ≥ m</i> trips.
</p>
<ul class="org-ul">
<li><i>∀ m. pₘ defined ⇒ ∀ n ≥ m. pₙ defined</i></li>
<li><i>∀ m. pₘ defined ⇒ ∀ n ≥ m. pₙ ≈ pₘ</i></li>
</ul>

<p>
Where ‘defined’ means it terminates without aborting.
</p></li>
<li>Hence, by these two claims, we know that the sequence <i>pₙ</i> either never defined
or it is defined beyond a certain point, and in this case, it is constant over its domain.</li>
<li>Hence: <code>while(b) q ≈ limₙ pₙ</code>.</li>
</ol>

<p>
The definition of ‘wp’ for loops is complicated and generally unhelpful, however
from it we can prove the so called “Invariance Theorem”:
If a property is maintained by the body of the loop
and there is an integral value expressed using the body's variables
that starts out non-negative and is decreased by each loop pass,
then the loop will terminate and the property it maintained will be true.
</p>

<pre class="example">
   {Inv ∧ B ∧ bf = c} S {Inv ∧ bf &lt; c}
⇒
   {Inv ∧ bf ≥ 0}  while(B) S  {¬B ∧ Inv}
</pre>
<p>
A property that is maintained to be true throughout the loop is referred to as an
<i>invariant</i>. In contrast, a value that changes through every pass
&#x2013;such as the number of passes remaining, the <code>bf</code>&#x2013; is known as a <i>variant</i>.
</p>

<p>
In Frama-C rendition,
</p>
<pre class="example">
/*@ loop invariant ⋯  // property that is maintained by the loop body
  @ loop assigns ⋯    // variables that are altered by the loop body
  @ loop variant ⋯    // a bound on the total number of loops
  */
while(B) S;
</pre>

<p>
Incidentally the primary function of the <code>assigns</code> clause is that variables its does
not mention essentially have the invariant property of being equal to their value
before the loop. That is, the <code>assigns</code> clause reduces clutter regarding constants
from the invariant!
</p>
<details>
<div class="org-src-container">
<pre class="src src-c" id="org8028e1a"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;limits.h&gt;</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires N &gt;= 0;</span>
<span style="color: #96A7A9; font-style: italic;">  @ requires N * (N + 1) /2 &lt; INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns \nothing;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures \result == N * (N + 1) / 2;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">euclid</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">N</span>)
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">sum</span> = 0; <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">n</span> = 0;
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert invariant_intially_estabished</span><span style="color: #96A7A9; font-style: italic;">: 2 * sum == 0 * (0 + 1);</span>

  <span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #b58900;">@ loop invariant main_item</span><span style="color: #96A7A9; font-style: italic;">: sum == n * (n + 1) / 2;</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop invariant always_in_range</span><span style="color: #96A7A9; font-style: italic;">: 0 &lt;= n &lt;= N;</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop invariant range_for_sum</span><span style="color: #96A7A9; font-style: italic;">: 0 &lt;= sum;</span>
<span style="color: #96A7A9; font-style: italic;">    // Exercise: Why can we comment out the following two lines?</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop invariant no_overflow1</span><span style="color: #96A7A9; font-style: italic;">: n &lt; INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop invariant no_overflow2</span><span style="color: #96A7A9; font-style: italic;">: sum &lt;= INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">    @ loop assigns n, sum;</span>
<span style="color: #96A7A9; font-style: italic;">    @ loop variant N - n;</span>
<span style="color: #96A7A9; font-style: italic;">   */</span>
  <span style="color: #859900; font-weight: bold;">while</span>(n != N)
  {
    <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert sum + n &lt; INT_MAX;</span>
    n   = n + 1;
    <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert sum + n &lt;= INT_MAX;</span>
    sum = sum + n;
    <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert sum &lt;= INT_MAX;</span>
  }
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert invariant_and_not_guard</span><span style="color: #96A7A9; font-style: italic;">: n == N  &amp;&amp;  sum == n * (n + 1) / 2;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert post_condition</span><span style="color: #96A7A9; font-style: italic;">:    sum == N * (N + 1) / 2;</span>
  <span style="color: #96A7A9; font-style: italic;">//         </span><span style="color: #96A7A9; font-style: italic;">rewrite_post:  2 * sum == N * (N + 1);  // Not true, due to &#8216;rounding&#8217;!</span>

  <span style="color: #859900; font-weight: bold;">return</span> sum;
}
</pre>
</div>
<p>
<b>Exercise:</b> Why is <code>sum ≤ INT_MAX</code> true at the end of the loop body? Fill in the proof:
</p>
<pre class="example">
   sum ≤ INT_MAX
≡  n * (n + 1) / 2 ≤ INT_MAX                     --  ???
⇐ n * (n + 1) / 2 ≤ N * (N + 1) / 2 ≤ INT_MAX   --  Transtivitity of ≤
≡  N * (N + 1) / 2 ≤ INT_MAX                     --  ???
≡  true                                          --  ???
</pre>
</details>
<p>
Here's a simple exercise,
</p>
<details>
<div class="org-src-container">
<pre class="src src-c" id="orgaca79f1"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;limits.h&gt;</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires a + 10 &lt; INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures \result == \old(a) + 10;</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">look_ma_no_new_locals</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span>)
{
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ ghost const int A = a;</span>

  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">i</span>;                   <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">So we can refer to this &#8216;i&#8217; *after* the loop.</span>
  <span style="color: #96A7A9; font-style: italic;">/* </span><span style="color: #96A7A9; font-style: italic;">// @ loop assigns ???;         // Fix me.</span>
<span style="color: #96A7A9; font-style: italic;">    @ loop invariant a == 666;      // Fix me.</span>
<span style="color: #96A7A9; font-style: italic;">    @ loop invariant 0 &lt;= i &lt;= 10;</span>
<span style="color: #96A7A9; font-style: italic;">    @ loop variant   666;           // Fix me.</span>
<span style="color: #96A7A9; font-style: italic;">    @</span><span style="color: #96A7A9; font-style: italic;">*/</span>
  <span style="color: #859900; font-weight: bold;">for</span>(i = 0; i != 10; i++) a++;
<span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert after_loop_guarantees</span><span style="color: #96A7A9; font-style: italic;">: i == 10  &amp;&amp; a == A + i;</span>
<span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert weakening_previous_gives</span><span style="color: #96A7A9; font-style: italic;">: a == A + 10;</span>
  <span style="color: #859900; font-weight: bold;">return</span> a;
}
</pre>
</div>
</details>

<p>
<b>Warning</b> Without the <code>loop assigns</code>, you are more likely to have trouble proving a loop
is correct!
</p>
<p>
Now a bit harder&#x2026;
</p>

<details>
<p>

</p>

<div class="org-src-container">
<pre class="src src-c" id="orgda1145f"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;limits.h&gt;</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ assigns \nothing;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures 0 &lt;= \result &lt;= 1;</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">random_bool</span>(); <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">{ return random_between(0, 1); }</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires \valid(it);</span>
<span style="color: #96A7A9; font-style: italic;">  @ requires *it + max &lt;= INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">  // @ requires FixMe -- a property on `max`;</span>
<span style="color: #96A7A9; font-style: italic;">  // @ assigns FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures  \old(it) &lt;= it &lt;= it + max;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">increment_randomly</span>(<span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">it</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">max</span>)
{
   <span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ loop assigns i, *it;</span>
<span style="color: #96A7A9; font-style: italic;">     @ loop invariant *it == \at(*it, Pre) + i;</span>
<span style="color: #96A7A9; font-style: italic;">     // </span><span style="color: #b58900;">@ loop invariant range_of_i</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">     // @ loop variant FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">    */</span>
   <span style="color: #859900; font-weight: bold;">for</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">i</span> = 0; i != max &amp;&amp; random_bool(); i++) (*it)++;
}
</pre>
</div>
</details>
</div>
</div>
</div>

<div id="outline-container-org5982ac6" class="outline-2">
<h2 id="org5982ac6">ACSL Properties</h2>
<div class="outline-text-2" id="text-org5982ac6">
</div>

<div id="outline-container-org85af38a" class="outline-3">
<h3 id="org85af38a">Predicates</h3>
<div class="outline-text-3" id="text-org85af38a">
<p>
Our invaraints were getting out of hand, the trouble can be mitigated by defining our own
predicates rather than just using the built in ones. However, such definitions must be
<i>functional</i> in nature: They do not produce side-effects, such as altering state.
Moreover, they are generally parameterised by a <i>label</i> that refers to the C memory state
in which they would be invoked &#x2013;within the definition we cannot however reference the
special labels <code>Here, Pre, Post</code>. Otherwise parameter passing is by value as in C.
</p>

<p>
The <code>predicate</code> keyword declares Boolean values functions:
</p>
<pre class="example">
/*@ predicate name_here {Label₀, …, Labelₖ} (type₀ arg₀, …, typeₘ argₘ) =
  @ // A Boolean valued relationship between all these things.
  */
</pre>

<div class="org-src-container">
<pre class="src src-c" id="orga9e12d5"><span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">An integer memory location remains unaltered between given program points.</span>
<span style="color: #96A7A9; font-style: italic;">//</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ predicate unchanged{L0, L1} (int *i)   =  \at(*i, L0) == \at(*i, L1);</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">i</span> = 13, <span style="color: #268bd2;">j</span> = 12;

  <span style="color: #6c71c4; font-weight: bold;">DoSomeWork</span>:
  j = 32;

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert unchanged{DoSomeWork, Here}(&amp;i);</span>

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
More usefully, there is the need to ensure a given integer is indeed a non-negative
length of an array.
</p>
<div class="org-src-container">
<pre class="src src-c" id="org95b4f64"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ predicate valid_array(int* arr, integer len) =</span>
<span style="color: #96A7A9; font-style: italic;">  @ 0 &lt;= len &amp;&amp; \valid(arr + (0 .. len - 1));</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
</pre>
</div>
<p>
Notice that we did not specify a memory label.
That's okay, one is provided for us and the entire definition is considered to transpire
at that memory location. In particular, unlike the previous example, we cannot refer to
distinct memory locations &#x2013;after all we haven't named any!
At the call site, the implicit memory location would be <code>Here</code> thereby referring to the
current memory state &#x2013;however we may still explicitly provide a different label at the
call site.
</p>
</div>
</div>

<div id="outline-container-orgec7f9d7" class="outline-3">
<h3 id="orgec7f9d7">Logic Functions</h3>
<div class="outline-text-3" id="text-orgec7f9d7">
<p>
Predicates must be either true or false, but <code>logic</code> functions are methods that
can be invoked in our specifications &#x2013;you may have noticed that C methods <b>cannot</b>
be called in a specification, which is reasonably since they may produce side-effects!
Since assignment, sequence, and loops rely on side effects they now suddenly become
useless and our definitions must rely on recursion.
Such logical functions generally need not worry about runtime issues such as overflow
&#x2013;which however must be handled at the call site, if need be.
</p>

<pre class="example">
/*@ logic return_type function_name {Label₀, …, Labelₖ} (type₀ arg₀, …, typeₘ argₘ) =
  @  // A formula using the arguments argᵢ, possibly at labels Labelᵢ
 */

//@ logic integer factorial(integer n)  =  (n &lt;= 0) ? 1 : n * factorial(n-1);
</pre>

<p>
If we wrote a program that contained many occurrences to <code>factorial</code> then the definition
would need to be invoked each time. If the occurrences all happened, for example, on the
same input, say 12 &#x2013;any larger would be an <code>unsigned int</code> overflow&#x2013; then it might
make matters faster if we simply had that as a <i>lemma</i> that is proven once and used many
times by the underlying provers. Indeed this can be accomplished by using the <code>lemma</code>
phrase, and this can be done for any property.
</p>

<pre class="example">
//@ lemma name_of_property {Label₀, …, Label₀}:  property_here ;
</pre>

<p>
For example,
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ lemma lt_plus_lt</span><span style="color: #96A7A9; font-style: italic;">: \forall integer i,j; i &lt; j ==&gt; i + 1 &lt; j + 1;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga8162bf" class="outline-3">
<h3 id="orga8162bf">Axiomatic Definitions</h3>
<div class="outline-text-3" id="text-orga8162bf">
<p>
Sometimes a proof may take too long to be proven, or it cannot be proven with the
back-end provers, and, moreover, we do not wish to bother with its proof directly.
In such cases, we may tell Frama-C to trust our judgement and take our word for it
&#x2013;if we're not careful, our ‘word’ may lead us to conclude <i>false = true</i>!
</p>

<div class="org-src-container">
<pre class="src src-c" id="org78b067b"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ axiomatic my_axioms {</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ axiom antisymmetry</span><span style="color: #96A7A9; font-style: italic;">: \forall integer i, j; i &lt;= j &lt;= i  ==&gt;  i == j;</span>
<span style="color: #96A7A9; font-style: italic;">  @ }</span>
<span style="color: #96A7A9; font-style: italic;">*/</span>
</pre>
</div>

<p>
Unlike lemmas, which require a proof, axioms are simply assumed to be true.
It is the responsibility of the user to ensure no inconsistencies arise, as in:
</p>
<div class="org-src-container">
<pre class="src src-c" id="org123c4ff"><span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ axiomatic UhOh{ axiom false_is_true</span><span style="color: #96A7A9; font-style: italic;">: \false; }</span>

<span style="color: #b58900; font-style: italic;">int</span> main()
{
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Examples of proven properties</span>

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert \false;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert \forall integer x; x == 31;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert \false == \true;</span>
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
However, <code>axiomatic</code> definitions of recursive functions are useful since the underlying
provers do not unroll the recursion when possible
&#x2013;after all, we are simply declaring the type of a function and some properties about
it, which incidentally, happen to be its defining equations.
</p>

<div class="org-src-container">
<pre class="src src-c" id="org7f356a1"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ axiomatic Factorial</span>
<span style="color: #96A7A9; font-style: italic;">  {</span>
<span style="color: #96A7A9; font-style: italic;">     logic integer factorial(integer n);</span>

<span style="color: #96A7A9; font-style: italic;">     axiom factorial_base: \forall integer i;  i &lt;= 0  ==&gt;  factorial(i) == 0;</span>
<span style="color: #96A7A9; font-style: italic;">     axiom factorial_inductive:</span>
<span style="color: #96A7A9; font-style: italic;">          \forall integer i; i &gt;  0  ==&gt;  factorial(i) == i * factorial(i - 1);</span>
<span style="color: #96A7A9; font-style: italic;">  }</span>
<span style="color: #96A7A9; font-style: italic;">*/</span>
</pre>
</div>

<p>
A small subtlety is that access to memory locations must be specified in the function
headers, for example:
</p>
<div class="org-src-container">
<pre class="src src-c" id="org194cf79"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ axiomatic is_constant</span>
<span style="color: #96A7A9; font-style: italic;">  {</span>
<span style="color: #96A7A9; font-style: italic;">     predicate constant{L}(int * a, integer b, integer e, integer val) reads a[b .. e-1];</span>

<span style="color: #96A7A9; font-style: italic;">     axiom constant_empty{L}:</span>
<span style="color: #96A7A9; font-style: italic;">       \forall int * a, integer b, e, val; b &gt;= e  ==&gt; constant{L}(a, b, e, val);</span>

<span style="color: #96A7A9; font-style: italic;">     axiom constant_non_empty{L}:</span>
<span style="color: #96A7A9; font-style: italic;">       \forall int * a, integer b, e, val; b &lt; e ==&gt;</span>
<span style="color: #96A7A9; font-style: italic;">          ( constant{L}(a,b,e, val)  &lt;==&gt;  constant{L}(a,b,e-1, val) &amp;&amp; a[e-1] == val );</span>
<span style="color: #96A7A9; font-style: italic;">  }</span>
<span style="color: #96A7A9; font-style: italic;">*/</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org99b721b" class="outline-2">
<h2 id="org99b721b">Functions</h2>
<div class="outline-text-2" id="text-org99b721b">
<p>
We will be proving code blocks satisfy Hoare triples, but code blocks are essentially
methods with the given predicate acting as a pre-condition and the required predicate
acting as post-condition. As such, we investigate Hoare triples by using methods.
</p>

<p>
A contract stipulates under what conditions a method will behave
&#x2013;if those conditions are not met, then it's behaviour may be arbitrary.
For example, a method may behave in a manner ensuring \\ <code>x &gt; 1/y</code> under the condition <code>y &gt; 0</code>,
and it may do anything it wants &#x2013;such as aborting the system or setting <code>x = -1</code>&#x2013;
when that condition is not met.
</p>

<p>
All in all, a function call establishes property <i>R</i> precisely when evaluating its
arguments then executing the function body together establish the property.
</p>
<pre class="example">
wp ℱ(t₁, …, tₙ) R  ≡  wp (x₁ ≔ t₁; ⋯ ; xₙ ≔ tₙ; ℬ) R

where ℱ(x₁, …, xₙ) = ℬ  -- Definition of ℱ
</pre>
</div>

<div id="outline-container-org4dd5d57" class="outline-3">
<h3 id="org4dd5d57">What are Functions?</h3>
<div class="outline-text-3" id="text-org4dd5d57">
<p>
Functions permit abstraction over program design since parts may
be constructed independently and also promotes avoidance of repetition.
</p>

<p>
Unlike functional languages where the result of a function is the final
term in its body, imperative languages signal result values by the <code>return</code> keyword;
which immediately stops execution of the function regardless of the keyword's position.
</p>

<p>
Functions which return no value but instead perform some effectful action, i.e., are <i>procedures</i>,
are marked with the <code>void</code> keyword in-place of a return type &#x2013;surprisingly, this ‘return type’
is not a type at all! One cannot declare a variable of type <code>void</code>.
</p>

<p>
Function calls that yield a value are terms whereas those that do not constitute statements.
</p>
<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #b58900; font-style: italic;">int</span>  <span style="color: #b58900;">f</span>(){ <span style="color: #859900; font-weight: bold;">return</span> 3;}
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">g</span>(){ printf(<span style="color: #2aa198;">"g(): Hello There!"</span>); }

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Valid invocations</span>
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = f();
  f();           <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Bad form! Result is discarded.</span>
  g();

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">T y = g(); // Type error! No possible type T!</span>
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</details>

<p>
A <i>program</i> is an sequence of global variables, function declarations, then a special
function called <code>main</code>. Since sequences are ordered, all names are declared before use!
In C, <code>main</code> usually exits with <code>return 0</code>. Global variables tend to pollute
the namespace and are more trouble than they're worth, so we shall ignore them
&#x2013;however they are already included by default since assignment is a top-level construct.
Incidentally, function declarations with no arguments may be used to simulate global
constants.
</p>

<p>
Note that C does not permit function overloading.
Moreover, C uses the same namespace for methods as well as simple variables
&#x2013;which in is not the case in, say, Java which permits naming a method <code>f</code> and a
variable <code>f</code> to obtain the valid invocation <code>f(f)</code>!
</p>

<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">it</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span>){ <span style="color: #859900; font-weight: bold;">return</span> x; }
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">it</span> = 5;
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">maybe</span> = it(it);
</pre>
</div>
</details>
</div>

<div id="outline-container-orgf5d2004" class="outline-4">
<h4 id="orgf5d2004">Effectful Expressions</h4>
<div class="outline-text-4" id="text-orgf5d2004">
<p>
In C, any expression followed by a semicolon is a statement:
The value of the expression is simply ignored when it is used as a statement.
</p>

<p>
Conversely, statements may be regarded as an effectful expression.
For example, assignment <code>x ≔ E</code> assigns the value of <code>E</code> to <code>x</code> and <i>returns</i> the value of <code>E</code>.
Whence, the notion of
</p>
<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">continued_assgns</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = 1, <span style="color: #268bd2;">y</span> = 2, <span style="color: #268bd2;">z</span> = 4;

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert x == 1  &amp;&amp;  y == 2  &amp;&amp; z == 4;</span>

  x -= y += z;         <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Assignments are right-associative!</span>

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert z == 4  &amp;&amp;  y == 2+4  &amp;&amp; x == 1-(2+4);</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert z == 4  &amp;&amp;  y == 6    &amp;&amp; x == -5;</span>
}
</pre>
</div>
</details>
</div>
</div>
</div>

<div id="outline-container-org034b60b" class="outline-3">
<h3 id="org034b60b">An Example Functional Contract</h3>
<div class="outline-text-3" id="text-org034b60b">
<p>
Look at the definition of <code>abs</code> below and notice:
</p>

<ul class="org-ul">
<li>Frama-C contracts are comments beginning with an <code>@</code> symbol and concluded with a <code>;</code> symbol.</li>
<li>The post-condition is introduced with the <code>ensures</code> clause; which may contain the
<code>\result</code> keyword to refer to the returned value of the method.</li>
<li>We may combine multiple <code>ensures</code> clauses by using conjunction <code>&amp;&amp;</code>, or have them on
separate lines. We may also use implication <code>==&gt;</code>, disjunction <code>||</code>, negation <code>!</code>,
value equality <code>==</code>, and Boolean equivalence <code>&lt;==&gt;</code>.
<ul class="org-ul">
<li>Notice that implication:  <code>A ==&gt; B</code> informs that when <code>A</code> is true then so is <code>B</code>,
and if <code>A</code> is false then we don't care and consider the whole thing to be true.</li>
</ul></li>
<li>Notice that we may <i>name</i> our conditions, which is helpful to remind us of their purpose
as well as being helpful in the frama-c output.</li>
</ul>

<div class="org-src-container">
<pre class="src src-c" id="org8d0629c"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #b58900;">@ ensures always_nonnegative</span><span style="color: #96A7A9; font-style: italic;">: \result &gt;= 0;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures val &gt; 0  ==&gt;  \result == val;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures val &lt; 0  ==&gt;  \result == -val;</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">int</span> abs(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">val</span>)
{
  <span style="color: #859900; font-weight: bold;">return</span> (val &lt; 0) ? -val : val;
}
</pre>
</div>

<p>
Pressing <code>F9</code>, you will notice that we are also checking for runtime errors by using the RTE plugin
whose goal is to ensure the program cannot create runtime errors such as integer overflow,
invalid pointer dereferencing, division by 0, etc.
</p>

<p>
In our case, we have runtime problems that do not crash but instead produce logical errors:
The return value of <code>abs</code> is not positive! Indeed, in addition to the above block, add focus
to the following block by removing the prefix <code>-not</code>, then run the code with <code>F6</code> to see the output.
&#x2013;Remember to undo this alteration when you're done, otherwise the next invocation to frama-c
will take a while dealing with <code>printf</code>!
</p>
<div class="org-src-container">
<pre class="src src-c" id="org5996835"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span>   <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>
<span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;limits.h&gt;</span>  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">bounds on integers</span>
<span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;math.h&gt;</span>

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Our implementation is faulty..</span>
  printf(<span style="color: #2aa198;">"    INT_MIN      = %d\n"</span>, INT_MIN);
  printf(<span style="color: #2aa198;">"abs(INT_MIN)     = %d\n\n"</span>, abs(INT_MIN));

  printf(<span style="color: #2aa198;">"    INT_MIN + 1  = %d\n"</span>, INT_MIN+1);
  printf(<span style="color: #2aa198;">"abs(INT_MIN + 1) = %d\n\n"</span>, abs(INT_MIN+1));

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Using standard library works..</span>
  printf(<span style="color: #2aa198;">"fabs(INT_MIN)    = %.0f"</span>, fabs(INT_MIN));

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
The WP plugin forms the necessary proof obligations to ensure the program meets its
specification, simplifies them using a module called <code>Qed</code>, then asks a prover such as
<code>Alt-Ergo</code> whether the obligation is provable or not. Sometimes a property is not
verified for two possible reasons:
</p>
<ol class="org-ol">
<li>There is not enough information &#x2013;e.g., given assumptions&#x2013; for the proof to go through.</li>
<li>The proof search timed-out &#x2013;which can be configured.</li>
</ol>
</div>

<div id="outline-container-org8d9665f" class="outline-4">
<h4 id="org8d9665f">Exercise: Fixing <code>abs</code></h4>
<div class="outline-text-4" id="text-org8d9665f">
<ol class="org-ol">
<li>Remove focus from the <code>main()</code> code block.</li>
<li>Go back to the Incomplete Absolute Value code block.</li>
<li>Include the limits header file.</li>
<li>Add <code>@ requires INT_MIN &lt; val;</code> to the top of the function contract.</li>
<li>Check that the contract passes by pressing <code>F9</code>.</li>
<li>What bound conditions can you place on the result?</li>
<li>Experiment by altering the conditions or method body.</li>
</ol>
</div>
</div>

<div id="outline-container-orge1da38a" class="outline-4">
<h4 id="orge1da38a">Behaviours</h4>
<div class="outline-text-4" id="text-orge1da38a">
<p>
Notice that our absolute value function has two disjoint behaviours
&#x2013;depending on whether the input is positive or negative.
Each behaviour has some assumptions and some conclusions.
Moreover, our behaviours are
</p>
<ul class="org-ul">
<li><code>disjoint</code>: Every input can only satisfy the assumptions of <i>at most</i> one of the behaviours.
As such, the program is ‘deterministic’: At most one of the behaviours is possible.
&#x2013;The program is really a relation and this ensures it is <i>univalent</i>; i.e., a <i>partial function</i>&#x2013;</li>
<li><code>complete</code>: Every input satisfies the assumptions of <i>at least</i> one of the behaviours.
As such, the program is ‘total’: At least one behaviour is possible.
&#x2013;The program is really a relation and this ensures it is <i>total</i>; i.e., defined on all
inputs&#x2013;</li>
</ul>

<p>
We expressed our behaviours in the forms <code>ensures ⟨assumptions⟩  ==&gt;  ⟨consequences⟩</code>.
However this can get unruly when there are many assumptions and many consequences.
Moreover, expressing disjointness is tedious and error-prone even in our little
example, below, where it becomes the assertion: (<code>val &lt; 0 &amp;&amp; val &gt;= 0) &lt;==&gt; \false</code>.
As such there is the alternative <code>behavior</code> syntax &#x2013;note the American spelling!
Using this syntax, we can ask WP to verify that the behaviours are complete or disjoint,
or both.
</p>

<div class="org-src-container">
<pre class="src src-c" id="orga438c9b"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;limits.h&gt;</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires INT_MIN &lt; val;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures always_nonnegative</span><span style="color: #96A7A9; font-style: italic;">: \result &gt;= 0;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior positive_input</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  @    assumes val &gt; 0;</span>
<span style="color: #96A7A9; font-style: italic;">  @    ensures \result == val;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior negative_input</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  @    assumes val &lt;= 0;</span>
<span style="color: #96A7A9; font-style: italic;">  @    ensures \result == -val;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  @ complete behaviors;</span>
<span style="color: #96A7A9; font-style: italic;">  @ disjoint behaviors;</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">abs</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">val</span>)
{
  <span style="color: #859900; font-weight: bold;">return</span> (val &lt; 0) ? -val : val;
}
</pre>
</div>

<details>
<p>

</p>

<p>
<b>Exercise</b>
Replace each FixMe so that the program is proven correct.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires INT_MIN &lt; val;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures always_nonnegative</span><span style="color: #96A7A9; font-style: italic;">: \result &gt;= 0;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures Exercise</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  @      FixMe                             // Positive case</span>
<span style="color: #96A7A9; font-style: italic;">  @   &amp;&amp; (val &lt;= 0  ==&gt; \result == -val)   // Negative or 0 case</span>
<span style="color: #96A7A9; font-style: italic;">  @   &amp;&amp; !(val &gt; 0 &amp;&amp; val &lt;= 0)            // Disjointness condition</span>
<span style="color: #96A7A9; font-style: italic;">  @   &amp;&amp; FixMe                             // Completeness condition</span>
<span style="color: #96A7A9; font-style: italic;">  @   ;</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">abs</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">val</span>)
{
  <span style="color: #859900; font-weight: bold;">return</span> (val &lt; 0) ? -val : val;
}
</pre>
</div>

<p>
<b>Exercise</b>
Replace each FixMe with the weakest proposition so that the program is proven correct.
</p>

<div class="org-src-container">
<pre class="src src-c" id="orgb52cdae"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires INT_MIN &lt; val;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures always_nonnegative</span><span style="color: #96A7A9; font-style: italic;">: \result &gt;= 0;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior positive_input</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    assumes Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  @    ensures \result == val;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior negative_input</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    assumes Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  @    ensures \result == -val;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  @ complete behaviors;    // Frama-C complain here, but please fix the &#8220;Exercises&#8221;!</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">abs</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">val</span>)
{
  <span style="color: #859900; font-weight: bold;">return</span> (val &lt; 0) ? -val : val;
}
</pre>
</div>

<p>
<b>Exercise</b>
Replace each FixMe with the strongest proposition so that the program is proven correct.
</p>

<div class="org-src-container">
<pre class="src src-c" id="orgc277876"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires INT_MIN &lt; val;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures always_nonnegative</span><span style="color: #96A7A9; font-style: italic;">: \result &gt;= 0;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior positive_input</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    assumes Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  @    ensures \result == val;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior negative_input</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    assumes Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  @    ensures \result == -val;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  @ disjoint behaviors;</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">abs</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">val</span>)
{
  <span style="color: #859900; font-weight: bold;">return</span> (val &lt; 0) ? -val : val;
}

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">This program passes 100%, but that is because it assumes false, the &#8220;FixMe&#8221;.</span>
</pre>
</div>
</details>
</div>
</div>
</div>
<div id="outline-container-orgbc86c9d" class="outline-3">
<h3 id="orgbc86c9d">Proving is Programming</h3>
<div class="outline-text-3" id="text-orgbc86c9d">
<p>
In this section we step back a little to get more comfortable with <code>requires</code>
preconditions and <code>ensures</code> postconditions. Moreover, we use this time to remind
ourselves of some elementary logic. After all, we use logic to express properties
and hope Frama-C can verify them.
</p>

<p>
In some sense <i>false, true</i> behave for the 𝔹ooleans as <i>-∞, +∞</i> behave for the ℕumbers.
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><span class="underline">𝔹ooleans</span></td>
<td class="org-left"><span class="underline">ℕumbers</span></td>
</tr>

<tr>
<td class="org-left">p ⇒ true</td>
<td class="org-left">n ≤ +∞</td>
</tr>

<tr>
<td class="org-left">false ⇒ p</td>
<td class="org-left">-∞ ≤ n</td>
</tr>

<tr>
<td class="org-left">Implication ⇒</td>
<td class="org-left">Inclusion ≤</td>
</tr>

<tr>
<td class="org-left">Conjunction ∧</td>
<td class="org-left">Minimum ↓</td>
</tr>

<tr>
<td class="org-left">Disjunction ∨</td>
<td class="org-left">Maximum ↑</td>
</tr>
</tbody>
</table>

<p>
Using this correspondence we can rephrase the “Golden Rule” <i>p ∧ q ≡ p ≡ q ≡ p ∨ q</i>
as the following trivial property <i>x ↓ y = x  ≡  y = x ↑ y</i>
&#x2013;“The minimum of two numbers is the first precisely when the second is their maximum.”
Neat Stuff!
</p>

<details>
<p>

</p>

<p>
<b>Ex falso quodlibet</b> From <i>false</i>, anything follows: <i>false ⇒ p,</i> for any <i>p</i>.
Edit <code>FixMe</code> in the following snippet so that it ensures the result is equal to 42.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #b58900;">@ requires uhOh</span><span style="color: #96A7A9; font-style: italic;">: a &lt; 0 &amp;&amp; a &gt; 0;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures  what: Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">id</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span>){ <span style="color: #859900; font-weight: bold;">return</span> a;}
</pre>
</div>

<p>
<b>Right Identity of Implication</b> Everything implies <i>true</i>; that is <i>p ⇒ true,</i> for any <i>p</i>.
Edit <code>FixMe</code> in the following snippet so that it there are no errors.
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #b58900;">@ requires Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;   // &lt;-- Change this false positive.</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures \true;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">id</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span>){ <span style="color: #859900; font-weight: bold;">return</span> a; }
</pre>
</div>

<p>
<b>Exercise</b>
Replace each <code>FixMe</code> with the weakest possible predicate so that it passes.
</p>
<div class="org-src-container">
<pre class="src src-c" id="org0651a9e"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires \true;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures UpperBound</span><span style="color: #96A7A9; font-style: italic;">: a &lt;= \result  &amp;&amp;  b &lt;= \result;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures Exercise: Selection1</span><span style="color: #96A7A9; font-style: italic;">: FixMe  ==&gt; \result == b;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures Exercise: Selection2</span><span style="color: #96A7A9; font-style: italic;">: FixMe  ==&gt; \result == a;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span><span style="color: #96A7A9; font-style: italic;">*/</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">max</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">b</span>)
{
  <span style="color: #859900; font-weight: bold;">return</span> a &lt; b ? b : a;
}
</pre>
</div>

<p>
Conversely, that maximum is the least upper bound,
<i>x ≤ z  ∧  y ≤ z  ≡  x ↑ y ≤ z</i>, corresponds to the
characterisation of disjunction <i>(p ⇒ r) ∧ (q ⇒ r)  ≡  (p ∨ q) ⇒ r</i>
&#x2013;incidentally this is also known as “case analysis” since one proves
<i>p ∨ q ⇒ r</i> by providing a proofs that if <i>p ∨ q</i> is true due to <i>p</i> then
with <i>p</i> in hand we need to show <i>r</i>, and likewise if <i>p ∨ q</i> is true due to <i>q</i>.
</p>

<p>
<b>Exercise</b>
Replace <code>FixMeCode</code> with the least amount of code so that the following passes.
</p>
<div class="org-src-container">
<pre class="src src-c" id="org637d66b"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>
<span style="color: #268bd2; font-weight: bold;">#define</span> <span style="color: #b58900;">max</span>(<span style="color: #268bd2;">a</span>,<span style="color: #268bd2;">b</span>) (a &lt; b ? b : a)   <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Ignore me.</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires max(a, b) &lt;= c;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures a &lt;= c  &amp;&amp;  b &lt;= c;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span><span style="color: #96A7A9; font-style: italic;">*/</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">case_analysis</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">b</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">c</span>)
{
  FixMeCode;
}
</pre>
</div>
</details>
</div>
</div>

<div id="outline-container-orgd5dc811" class="outline-3">
<h3 id="orgd5dc811">Maintaining The Sequence Rule</h3>
<div class="outline-text-3" id="text-orgd5dc811">
<p>
Since function calls may alter memory state, the computation of a term may now
not only produce a value, as before, but also alter the state altogether.
( Foreshadowing: The <code>assigns</code> ACSL keyword! )
</p>

<p>
Since a <code>return</code> interrupts executation, the sequence computation rule
<code>wp (S₁;S₂) = wp S₁ ∘ wp S₂</code> is no longer valid when the execution of <code>S₁</code> causes the
execution of a <code>return</code> thereby necessitating that <code>S₂</code> is not executed.
As we have already seen, we keep the rule valid by simply defining <code>wp U R ≡ true</code>
for any unreachable code <code>U</code> &#x2013;as is <code>S₂</code> when <code>S₁</code> has a return.
</p>

<p>
That is, unreachable assertions are always ‘true’:
They are never in a memory state, and so cannot even be evaluated, let alone be false!
</p>
<div class="org-src-container">
<pre class="src src-c" id="orge2289fe"><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #859900; font-weight: bold;">goto</span> <span style="color: #6c71c4; font-weight: bold;">End</span>;
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@assert my_cool_nonsense</span><span style="color: #96A7A9; font-style: italic;">: 0 == 1;    // This is unreachale but &#8216;true&#8217;.</span>

  <span style="color: #6c71c4; font-weight: bold;">End</span>:
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
<p>
Likewise with infinite loops,
</p>
<div class="org-src-container">
<pre class="src src-c" id="org9d4f329"><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #859900; font-weight: bold;">while</span>(1 &gt; 0);
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@assert my_cool_nonsense</span><span style="color: #96A7A9; font-style: italic;">: 0 == 1;    // This is unreachale but &#8216;true&#8217;.</span>
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
<p>
That is, Frama-C considers ‘partial correctness’: A specification is satisfied,
<i>provided</i> it terminates.
</p>

<p>
In addition, since imperative expressions can modify memory, considerations must be
given to the fact arguments of a function are evaluated from left to right.
For example, suppose <code>x,y</code> are imperative constructions yield integers, then
 <code>x + y</code> and <code>y + x</code> are not guaranteed to produce the same behaviour!
</p>

<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">f</span>(){ printf(<span style="color: #2aa198;">"\nf(): Hello with Four!"</span>);  <span style="color: #859900; font-weight: bold;">return</span> 4;}
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">g</span>(){ printf(<span style="color: #2aa198;">"\ng(): Hello with Three!"</span>); <span style="color: #859900; font-weight: bold;">return</span> 3;}

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">result</span>;

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">The output to the screen changes,</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">even though the *value* of result does not.</span>
  result = f() + g();
  printf(<span style="color: #2aa198;">"\n---"</span>);
  result = g() + f();

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</details>

<p>
The C language does not specify the order of evaluation of function arguments
&#x2013;albeit it is usually left-to-right&#x2013;, and it is up to the programmer to write
programs whose result does not depend on the order of evaluation.
</p>

<p>
<b>Exercise:</b> Produce a Frama-C checked variant of this example.
Remember to remove all <code>printf</code>'s!
</p>
</div>
</div>

<div id="outline-container-org6579b1d" class="outline-3">
<h3 id="org6579b1d">Passing Arguments by Value and by Reference</h3>
<div class="outline-text-3" id="text-org6579b1d">
<p>
Applying the definition of <code>wp</code> to the body of the following <code>swap</code> gives us
<code>wp swap = id</code>, thereby demonstrating that <i>this</i> <code>swap</code> does not change the
values of two variables!
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">swap</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">b</span>){ <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">c</span>; c = a; a = b; b = c; }
</pre>
</div>
<p>
The default mechanism of argument passing is that of <i>pass by value</i>:
Only values are sent to function bodies, which cannot alter the original variables.
Indeed, what should <code>swap(x+y, 2)</code> perform if it were to “alter the given variables”?
</p>

<p>
To say that two <i>distinct</i> variables share the <i>same location</i> in memory
requires us to formally introduce a notion of location that variables may reference.
Rather than introduce a new such type, C makes the convention that certain numeric
values act &#x2013;possibly dual roles&#x2013; as reference locations.
</p>

<p>
Hence we can associate variables to references which are then associated to values.
That is, a state now consists of two pieces: An <i>environment</i> mapping variables to
references and a <i>memory state</i> mapping references to values.
The key insight is that the environment may be non-injective thereby associating
distinct variables to the same reference thereby permitting them to alter the shared value.
Incidentally, the shared value can be thought of as a buffer for message passing between
the two variable agents. Neato!
</p>

<p>
In C, passing by reference is not a primitive construct, but it can be simulated.
The type of references that can be associated with a value of type <code>T</code> in memory
is written <code>T*</code> in C. Incidentally, the dereference operator is written <code>*</code> in C.
For example, in environment <code>u ↦ r₁</code> and memory state <code>r₁ ↦ r₂, r₂ ↦ 4</code> we have
that <code>u</code> has <i>value</i> <code>r₂</code> whereas <code>*u</code> has <i>value</i> <code>4</code>. That is, <code>u</code> is a reference value at location <code>r₁</code>
having contents <code>r₂</code>, which when dereferenced refer to the value contained in location <code>r₂</code>
which is 4.
</p>

<p>
The reference associated with variable <code>x</code> in a C environment is written <code>&amp;x</code>.
E.g., in environment <code>x ↦ r</code> and memory state <code>r ↦ 4</code>, the value of <code>x</code> is the integer 4
whereas the value of <code>&amp;x</code> is the reference <code>r</code>. Moreover, the value of <code>*&amp;x</code> is the integer 4.
</p>

<pre class="example">
&amp;_ : ∀{T} →  Variable T → Reference T   -- “address of”
*_ : ∀{T} → Reference T → T             -- “value of”

-- Using ‘value equality’:
Inverses:  ∀ a : Var T.  *&amp;a   ≈ a
Inverses:  ∀ r : Ref T.  &amp;(*r) ≈ r
</pre>

<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">understanding_references</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span>  <span style="color: #268bd2;">a</span> = 4;    <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">integer a refers to 4</span>
  <span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">x</span> = &amp;a;   <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">integer reference x refers to the location of a</span>

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Facts thus far</span>
  <span style="color: #96A7A9; font-style: italic;">//</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert a_is_a_number</span><span style="color: #96A7A9; font-style: italic;">: a == 4;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert x_points_to_a</span><span style="color: #96A7A9; font-style: italic;">: *x == a == 4;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert x_is_a_location</span><span style="color: #96A7A9; font-style: italic;">: x == &amp;a;</span>

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">The inverse law: a == *(&amp;a).</span>
  <span style="color: #96A7A9; font-style: italic;">//</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert x_points_to_a</span><span style="color: #96A7A9; font-style: italic;">: *x == a == 4;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert x_is_a_location</span><span style="color: #96A7A9; font-style: italic;">: x == &amp;a;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert equals_for_equals</span><span style="color: #96A7A9; font-style: italic;">: *(&amp;a) == *x == a;</span>

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">The inverse law: &amp;(*x) == x</span>
  <span style="color: #96A7A9; font-style: italic;">//</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert x_points_to_a</span><span style="color: #96A7A9; font-style: italic;">: *x == a == 4;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert x_is_a_location</span><span style="color: #96A7A9; font-style: italic;">: x == &amp;a;</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ assert equals_for_equals</span><span style="color: #96A7A9; font-style: italic;">: &amp;(*x) == &amp;a == x;</span>

}
</pre>
</div>
</details>

<p>
If <code>t</code> is an expression of type <code>T*</code> then the C language has the assignment
construct <code>*t = u</code>: The reference of <code>t</code> is now associated with the value
of <code>u</code>. The notation alludes to this executional behaviour:
The contents of <code>t</code>, i.e., <code>*t</code>, now refer to the value of <code>u</code>.
</p>

<p>
For example, <code>*&amp;x = u</code> has the same behaviour as the assignment <code>x = u</code>.
</p>

<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">x and y themselves cannot be assigned to: They're constant.</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">I.e., assignments &#8220;x = t&#8221; are forbidden, but &#8220;*x = t&#8221; are permitted.</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">This makes the compiler complain if we accidently made that assignment instead.</span>
<span style="color: #96A7A9; font-style: italic;">//</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">However, &#8220;const int* x&#8221; works in the opposite: x=t okay, but not *x=t.</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Declaration &#8220;const int* const x&#8221; prevents both types of assignments.</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">swap</span>(<span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #268bd2;">x</span>, <span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #859900; font-weight: bold;">const</span> <span style="color: #268bd2;">y</span>)
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">z</span>;
  z  = *x; <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">z gets the value referenced to by x</span>
  *x = *y; <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">the location x references now gets the value referenced by y</span>
  *y =  z; <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">the location y references now gets the value z</span>
}

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span> = 5, <span style="color: #268bd2;">y</span> = 10;
  swap(&amp;x, &amp;y);         <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Note that the function is applied to the references.</span>
  printf(<span style="color: #2aa198;">"x = %d, y = %d"</span>, x , y);
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</details>
</div>

<div id="outline-container-org18e8d55" class="outline-4">
<h4 id="org18e8d55">Dangling References: Segmentation Faults</h4>
<div class="outline-text-4" id="text-org18e8d55">
<p>
In C, we may look for references that do not exist:
C removes from memory the reference associated with a variable
when that variable is removed from the environment.
</p>

<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #b58900;">f</span>(<span style="color: #859900; font-weight: bold;">const</span> <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">p</span>)
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">n</span> = p;
  <span style="color: #859900; font-weight: bold;">return</span> &amp;n;

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">n only exists locally,</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">whence its reference is removed when it no longer exists.</span>
}

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">u</span> = f(5);
  <span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">v</span> = f(10);
  printf(<span style="color: #2aa198;">"u = %d, v = %d"</span>, *u , *v); <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Segmentation fault!</span>
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</details>

<p>
The compiler gives us
<code>warning: function returns address of local variable [-Wreturn-local-addr].</code>
We may thus turn on that warning &#x2013;and all warnings really!&#x2013; so that it becomes
an error at compile time.
</p>

<p>
Since we used a reference that is not declared in memory, C does not produce
a compile error but the runtime result is unpredictable. Execute the above
snippet to see different kinds of segmentation fault codes.
</p>
</div>
</div>
<div id="outline-container-org685d666" class="outline-4">
<h4 id="org685d666">Pointers in ACSL</h4>
<div class="outline-text-4" id="text-org685d666">
<p>
The <code>\old</code> function is a built-in logical operation of ACSL.
It can only be used in the post-condition and it denotes the value <i>before</i> execution
of the method body. If we want to access the value at a particular memory state,
we simply refer to a label at that time frame using the <code>\at</code> construct &#x2013;see below.
</p>

<div class="org-src-container">
<pre class="src src-c" id="org25821cf"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires \valid(a);</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures *a == \old(*a);</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures \at(*a, Post) == \at(*a, Pre); // Alternative way to say the same thing.</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">at_example</span>(<span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">a</span>)
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">tmp</span> = *a;
  <span style="color: #6c71c4; font-weight: bold;">AfterLine1</span>:
  *a = 23;
  <span style="color: #6c71c4; font-weight: bold;">AfterLine2</span>:
  *a = 42;
  <span style="color: #6c71c4; font-weight: bold;">AfterLine3</span>:
  *a = tmp;

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">We are now in the memory state after the fourth line.</span>
  <span style="color: #96A7A9; font-style: italic;">//</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Here are some true facts about the memory states:</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert *a == \at(*a, Pre);     // Current value of *a is same as before method.</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert \at(*a, Here) == \at(*a, Pre);     // More explicitly.</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert 42 == \at(*a, AfterLine3);</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert 23 == \at(*a, AfterLine2);</span>
}
</pre>
</div>

<p>
Besides user-defined labels, <code>\at</code> can also be used with the built-in labels:
</p>
<ul class="org-ul">
<li><code>Pre</code> : Value <i>before</i> function call.</li>
<li><code>Post</code>: Value <i>after</i> function call. &#x2013;Can only be used in the post-condition.</li>
<li><code>Here</code>: Value at the current program point. &#x2013;This' the default for stand-alone variables.</li>
</ul>

<p>
Whereas <code>\old</code> can only be used in the post-condition, <code>\at</code> can be used anywhere.
</p>

<p>
Notice that we used the built-in <code>\valid</code> to ensure that access to pointers is safe
&#x2013;i.e., pointing to a real memory location&#x2013; thereby avoiding runtime errors.
We may also write <code>\valid(p + (l .. u))</code> to express the validity of pointers
<code>p + i</code> for <i>l ≤ i ≤ u</i> &#x2013;this will be helpful when working with arrays.
Moreover, when working with constant, non-mutable, pointers, or if we wish to
be more accurate, we may use <code>\valid_read(p)</code> to express that the pointer <code>p</code> is valid for
read-access only &#x2013;no writing permitted.
</p>
</div>
</div>
</div>


<div id="outline-container-org964dedd" class="outline-3">
<h3 id="org964dedd">Side-effects: <code>assigns</code></h3>
<div class="outline-text-3" id="text-org964dedd">
<p>
Since methods may alter state, thereby producing side-effects, it becomes important
to indicate which global and local variables a method assigns to
&#x2013;that way its effects are explicit. We use the <code>assigns</code> clause to declare this.
Unless stated otherwise, WP assumes a method can modify anything in memory;
as such, the use of <code>assigns</code> becomes almost always necessary.
When a method has no side-effects, thereby not assigning to anything, we may
declare <code>assigns \nothing</code>.
</p>

<div class="org-src-container">
<pre class="src src-c" id="org28e0588"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires \valid(a) &amp;&amp; \valid(b);</span>
<span style="color: #96A7A9; font-style: italic;">  // @ assigns *a, *b;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures *a == \old(*b);</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures *b == \old(*a);</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">swap</span>(<span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">a</span>, <span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">b</span>)
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">tmp</span> = *a;
  *a = *b;
  *b = tmp;
}
</pre>
</div>

<p>
Notice that the following block fails to prove all goals
&#x2013;comment out the <code>assigns</code> clause <i>below</i> and re-check &#x2026; still no luck!
This can be fixed by un-commenting the <code>assigns</code> clause <i>above</i>.
</p>

<div class="org-src-container">
<pre class="src src-c" id="org8432786"><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">h</span> = 12; <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">new global variable!</span>

<span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assigns \nothing;  // In particular, this method does not alter &#8220;h&#8221;.</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span> = 1; <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">b</span> = 2;

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert h == 12;</span>
  swap(&amp;a, &amp;b);
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert h == 12;</span>
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
Finally it is to be noted that <code>assigns</code> do not occur within a <code>behavior</code>
&#x2013;it occurs before by declaring <i>all</i> variables that may be altered, then
each <code>behavior</code> would include a clause for the unmodified variables by indicating
their new value is equal to their <code>\old</code> one.
</p>
</div>
</div>

<div id="outline-container-orgbce560f" class="outline-3">
<h3 id="orgbce560f">Pointer Aliasing: <code>separated</code></h3>
<div class="outline-text-3" id="text-orgbce560f">
<p>
The raison d'être of pointers is to be able to have aliases for memory locations.
When the pointers refer to simple data, we may act <i>functionally</i> in that we copy
data to newly allocated memory locations. However, sometimes &#x2013;such as when we program
with linked lists&#x2013; copying large amounts of data is unreasonable and we may simply
want to alter given pointers directly. When the given pointers are <i>identical</i> then an
alteration to one of them is actually an alteration to the rest!
</p>

<p>
When we program with lists, we shall see that if we catenate two lists by altering
the first to eventually point to the second then it all works.
However, if we catenate a list with itself then the resulting alteration
is not the catenation of the list with itself but instead is an
infinite cycle of the first list! &#x2013;We'll see this later on.
</p>

<p>
Here is a simpler example,
</p>
<div class="org-src-container">
<pre class="src src-c" id="org4cbdac7"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;limits.h&gt;</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires \valid(fst) &amp;&amp; \valid_read(snd);</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ requires no_flow</span><span style="color: #96A7A9; font-style: italic;">: INT_MIN &lt;= *fst + *snd &lt;= INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">  // @ requires \separated(fst, snd);</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns *fst;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures uhOh</span><span style="color: #96A7A9; font-style: italic;">: *fst == \old(*fst) + *snd;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">increment_first_by_second</span>(<span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">fst</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #859900; font-weight: bold;">const</span> *<span style="color: #268bd2;">snd</span>)
{
  *fst += *snd;
}
</pre>
</div>

<p>
Notice since we're only assigning to <code>*fst</code>, we need not explicitly state
<code>ensures *snd == \old(*snd)</code>. However, in the event that <code>fst</code> and <code>snd</code> both point
to the same memory location, then we actually are assigning to both!
As such the final <code>ensures</code> is not necessarily true either!
</p>

<p>
We need to uncomment the <code>separated</code> declaration: The memory locations are distinct.
</p>

<p>
Notice that in the final call below, since the pre-condition to
<code>increment_first_by_second</code> fails, we have breached its contract and therefore
no longer guarenteed the behaviour it <code>ensures</code>.
Since the contract does not tells what happens when we breach it, anything is possible
and so anything is “true”!
</p>
<div class="org-src-container">
<pre class="src src-c" id="org800be1d"><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">life</span> = 42, <span style="color: #268bd2;">universe</span> = 12;

  <span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">this</span> = &amp;life;
  <span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">new</span>  = &amp;universe;

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert *this == 42  &amp;&amp; *new == 12;</span>
  increment_first_by_second(this, new);
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert *this == 42 + 12  &amp;&amp; *new == 12;   // Yay!</span>

  <span style="color: #b58900; font-style: italic;">int</span> *<span style="color: #268bd2;">that</span> = &amp;life;  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">uh-oh!</span>

  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert *this == 54  &amp;&amp; *that == 54;</span>
  increment_first_by_second(this, that);
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert *this == 54 + 54  &amp;&amp; *that == 54;   // Nope...?</span>
  <span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assert 1 == 0;                             // Notice everything is now &#8220;true&#8221;!</span>

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
We may invoke <code>\separated(p₁, …, pₙ)</code> to express the pointers <code>pᵢ</code> should refer to distinct
memory locations and therefore are non-overlapping.
</p>
</div>
</div>

<div id="outline-container-org9dabd62" class="outline-3">
<h3 id="org9dabd62">Functional Composition</h3>
<div class="outline-text-3" id="text-org9dabd62">
<p>
As a matter of abstraction, or separation of concerns, a program may be split up
into an interface of declarations &#x2013;a ‘header’ file&#x2013; and an implementation file.
Frama-C permits this approach by allowing us to use a specification of a declared
method, which it assumes to be correct, and so we need to verify its precondition
is established whenever we call it. In some sense, for proof purposes, this allows
us to ‘postulate’ a correct method and use it elsewhere &#x2013;this idea is very helpful
when we want to use an external libary's methods but do not &#x2013;or cannot&#x2013; want to prove them.
</p>

<details>
<p>

</p>

<div class="org-src-container">
<pre class="src src-c" id="org9d29656"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;limits.h&gt;</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires val &gt; INT_MIN;</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns \nothing;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures always_non_negative</span><span style="color: #96A7A9; font-style: italic;">: \result &gt;= 0;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures non_negative</span><span style="color: #96A7A9; font-style: italic;">: 0 &lt;= val ==&gt; \result == val;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures negative</span><span style="color: #96A7A9; font-style: italic;">: val &lt; 0  ==&gt; \result == -val;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span><span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">abs</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">val</span>);

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ assigns \nothing;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures UpperBound</span><span style="color: #96A7A9; font-style: italic;">: a &lt;= \result  &amp;&amp;  b &lt;= \result;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures Selection1</span><span style="color: #96A7A9; font-style: italic;">: a &lt;= b  ==&gt;  \result == b;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures Selection2</span><span style="color: #96A7A9; font-style: italic;">: b &lt;= a  ==&gt;  \result == a;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span><span style="color: #96A7A9; font-style: italic;">*/</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">max</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">b</span>);

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Uncomment this to observe proof obligations failing.</span>
<span style="color: #96A7A9; font-style: italic;">//</span>
<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">int max(int a, int b){ return 5; }</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #b58900;">@ requires inherited_from_abs</span><span style="color: #96A7A9; font-style: italic;">: a &gt; INT_MIN  &amp;&amp; b &gt; INT_MIN;</span>

<span style="color: #96A7A9; font-style: italic;">  @ assigns \nothing;</span>

<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures always_non_negative: inherited_from_abs</span><span style="color: #96A7A9; font-style: italic;">: \result &gt;= 0;</span>

<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures upper_bound: inherited_from_max</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">         \result &gt;= a &amp;&amp; \result &gt;= -a    // &#8776; result &#8805; |a|</span>
<span style="color: #96A7A9; font-style: italic;">      &amp;&amp; \result &gt;= b &amp;&amp; \result &gt;= -b;   // &#8776; result &#8805; |b|</span>

<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures selection: inherited_from_max</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">          \result == a || \result == -a</span>
<span style="color: #96A7A9; font-style: italic;">       || \result == b || \result == -b;</span>
<span style="color: #96A7A9; font-style: italic;">*/</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">abs_max</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">a</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">b</span>)
{
  <span style="color: #859900; font-weight: bold;">return</span> max(abs(a), abs(b));
}
</pre>
</div>

<p>
If we press <code>F8</code>, the frama-c gui shows green bullets for the declarations'
specifications. They have no implementation and so are assumed to be true.
Then the <code>abs_max</code> operation ‘inherits’ the preconditions and postconditions of
the methods it calls along the variables it uses.
</p>
</details>
</div>
</div>
</div>
<div id="outline-container-org021779b" class="outline-2">
<h2 id="org021779b">Records</h2>
<div class="outline-text-2" id="text-org021779b">
<p>
Thus far we have only considered built-in types, we now turn to considering
user-defined types that are more complex and are composites of simpler types
by using the <i>record</i> construct.
</p>

<ul class="org-ul">
<li>Record ≈ Tuple with named fields</li>
</ul>

<p>
A tuple <code>x = (x₀, x₁, …, xₙ)</code> is a function over the domain <code>0..n</code>, but in programming
the domain is usually of <i>named fields, labels,</i> and then it is called a <i>record</i>.
E.g., <code>{name = "Jasim", age = 27, language = "ar"}</code> is a record.
In the case that the labels <i>are</i> numbers, we obtain the notion of an <i>array</i>.
</p>

<p>
In other languages, this may be known as a <code>class</code>.
In Haskell this is the <code>data</code> keyword with ‘record syntax’,
and in Agda we may go on to use the <code>record</code> keyword.
</p>

<p>
C records are known as <i>structures</i> and they are just a list of
labels with their types. In using <code>struct</code> types, the <code>struct</code>
keyword must precede the type name in all declarations.
</p>
<div class="org-src-container">
<pre class="src src-c" id="org68d22df"><span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #b58900; font-style: italic;">Pair</span>
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">fst</span>;
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">snd</span>;
};

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Note that &#8220;struct&#8221; always precedes the type name &#8220;Pair&#8221;.</span>

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Structs are passed in by value: They are copied locally.</span>
<span style="color: #96A7A9; font-style: italic;">//</span>
<span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #96A7A9; font-style: italic;">@ assigns \nothing;</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">doesNothing</span>(<span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #b58900; font-style: italic;">Pair</span> <span style="color: #268bd2;">p</span>)
{
  p.fst = 666;
}

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">As usual, we use pointers to pass values by reference.</span>
<span style="color: #96A7A9; font-style: italic;">//</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires \valid(p);</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns (*p).fst;</span>
<span style="color: #96A7A9; font-style: italic;">*/</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">woah</span>(<span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #b58900; font-style: italic;">Pair</span>* <span style="color: #268bd2;">p</span>)
{
  (*p).fst = 313;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c" id="orgfee0c94"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{

  <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #b58900; font-style: italic;">Pair</span> <span style="color: #268bd2;">p</span>; <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">no initalisation</span>

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Composite type without a name.</span>
  <span style="color: #859900; font-weight: bold;">struct</span> {<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">one</span>; <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">two</span>;} <span style="color: #268bd2;">q</span>;

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Initialisation with declaration.</span>
  <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #b58900; font-style: italic;">Pair</span> <span style="color: #268bd2;">r</span> = {11, 13};

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Note that in C, non-initialised variables have &#8220;arbitrary&#8221; values</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">which may change according to each new compilation!</span>

  printf(<span style="color: #2aa198;">"\n p = &#10216;fst: %d, snd: %d&#10217;"</span>, p.fst, p.snd);

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Set only first field.</span>
  p.fst = 3;
  printf(<span style="color: #2aa198;">"\n p = &#10216;fst: %d, snd: %d&#10217;"</span>, p.fst, p.snd);

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Zero-out all fields.</span>
  <span style="color: #859900; font-weight: bold;">struct</span> <span style="color: #b58900; font-style: italic;">Pair</span> <span style="color: #268bd2;">s</span> = {};
  printf(<span style="color: #2aa198;">"\n s = &#10216;fst: %d, snd: %d&#10217;"</span>, s.fst, s.snd);

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Invoke functions</span>

  doesNothing(s);
  printf(<span style="color: #2aa198;">"\n s = &#10216;fst: %d, snd: %d&#10217;"</span>, s.fst, s.snd);

  woah(&amp;s);
  printf(<span style="color: #2aa198;">"\n s = &#10216;fst: %d, snd: %d&#10217;"</span>, s.fst, s.snd);

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</div>

<div id="outline-container-orgf9e6577" class="outline-3">
<h3 id="orgf9e6577">Allocation of a Record</h3>
<div class="outline-text-3" id="text-orgf9e6577">
<ul class="org-ul">
<li>Recall that a variable declaration associates the variable with a reference to
the variable in memory &#x2013;i.e., it's address&#x2013;,
moreover this reference is associated a value for the variable.</li>

<li>Record variables declared without a value are given the special default value <code>null</code>.</li>

<li>In Java, a record variable's reference is not directly associated with a record in memory!
It is usually associated with <code>null</code> or another reference.</li>
</ul>

<p>
To associate a record with a variable, we need to create memory large enough to contain the record
contents. Some languages use the keyword <code>new</code> to accomplish this task: Create a new reference
and associated it with the record variable being defined.
</p>

<p>
For example, in Java,
</p>
<pre class="example">
class Pair
{
  int fst;
  int snd;
}

Pair p = new Pair();
</pre>
<p>
The resulting environment is <code>p ↦ r</code> and the resulting memory state is
<code>r ↦ r', r' ↦ {fst = 0, snd = 0}</code>. Note that default values are used.
</p>

<ul class="org-ul">
<li>A reference that was added to memory by the construct <code>new</code> is called a <i>cell</i>.</li>
<li>The set of memory cells is called a <i>heap</i>.</li>
<li>The operation that adds a new cell to the memory state is called <i>allocation</i>.</li>
</ul>

<p>
Interestingly in C the creation of records does <i>not</i> allocate cells and so there
is no need for the <code>new</code> keyword. Indeed record variables cannot ever have the value <code>null</code>.
C directly associates a variable with a reference which has the record contents as its value.
That is, C has one less level of indirection than is found in Java.
E.g., <code>struct Pair p = {2, 3};</code> gives us environment <code>p ↦ r</code> and memory state <code>r ↦ {fst = 2, snd = 3}</code>,
whereas Java would have <code>p ↦ r′</code> in the environment and <code>r′ ↦ r</code> additionally in the memory state
That is to say, <i>records in Java correspond to references to records in C</i>
and so Java access notation <code>r.f</code> is rendered in C as <code>(*r).f</code>.
</p>

<p>
Remember that references are themselves first-class values and it is possible for a
reference to be associated to another reference.
</p>
</div>
</div>

<div id="outline-container-orgfd22e28" class="outline-3">
<h3 id="orgfd22e28">The Four Constructs of Records</h3>
<div class="outline-text-3" id="text-orgfd22e28">
<p>
Records are usually handled using four constructs:
</p>
<ul class="org-ul">
<li>Defining a record type; e.g., using <code>class</code> or <code>struct</code>.</li>
<li>Allocating a cell; e.g., using <code>new</code> or <code>malloc</code>.</li>
<li>Accessing a field; e.g., <code>myRecord.myField</code>.</li>
<li>Assigning to a field; e.g., <code>myRecord.myField = myValue</code>.</li>
</ul>

<p>
Understanding records in a language is thus tantamount to understanding
these fundamental basics. E.g., in functional languages, assignment to a field
is essentially record copying or, more efficiently, reference redirection.
Incidentally, neither Haskell nor Agda make use of the <code>new</code> keyword:
Declarations <i>must be</i> accompanied by initialisation which indicate the need
for cell allocation &#x2013;consequently there is no need for a <code>null</code> value.
The use of <code>new</code> may be used for careful efficiency optimisations,
or memory management &#x2013;which is rarely brought to the forefront in functional languages.
</p>

<p>
The act of assigning to each field of a record
is so common that they are usually placed into a so-called <i>constructor</i> method.
</p>
</div>
</div>

<div id="outline-container-org8e18de1" class="outline-3">
<h3 id="org8e18de1">Sharing, Equality, &amp; Garbage</h3>
<div class="outline-text-3" id="text-org8e18de1">
</div>
<div id="outline-container-org240fbab" class="outline-4">
<h4 id="org240fbab">Assignment</h4>
<div class="outline-text-4" id="text-org240fbab">
<p>
Suppose <code>x</code> and <code>y</code> are variables of type <code>Pair</code>, with environment and memory state:
</p>
<pre class="example">
locations  =  x ↦ r₁, y ↦ r₂
values     =  r₁ ↦ r₃, r₂ ↦ r₄, r₃ ↦ {fst = 3, snd = 5}, r₄ ↦ {fst = 7, snd = 9}
</pre>
<p>
Then assignment <code>y ≔ x</code> results in:
</p>
<pre class="example">
locations  =  x ↦ r₁, y ↦ r₂
values     =  r₁ ↦ r₃, r₂ ↦ r₃, r₃ ↦ {fst = 3, snd = 5}, r₄ ↦ {fst = 7, snd = 9}
                      -Change Here-
</pre>
<p>
That is, the value of <code>x</code> is computed which is the reference <code>r₃</code>
&#x2013;since <code>value (location x) ≈ value r₁ ≈ r₃</code>&#x2013;
and we associate this value with the location of <code>y</code>, that is, reference <code>r₂</code>.
</p>

<p>
Notice that now no variable has the value of <code>r₄</code> and so it is considered <i>garbage</i>
in our state. Moreover, nothing can get to it since values are only associated with
locations, none of which have address <code>r₄</code>. Hence there is no <i>observable</i> affect to
their absence or presence. We want to recycle the physical memory
or else we would quickly run out of memory. A <i>garbage collector</i> is an automated
system that collects and recycles such cells. Older languages like C do not
have such a system and so memory must be managed by hand.
</p>

<p>
Anyhow, henceforth <code>x</code> and <code>y</code> <b>share</b> the values of the record thereby all alterations,
through either variable, are observable by the other.
</p>

<p>
Since <code>x</code> and <code>y</code> are reference values, the assignment makes <code>x == y</code> a true statement
since they <i>share</i> the same cell. This is known as <i>physical equality</i>.
</p>

<p>
Sometimes we wish for two variables to <i>share</i> a single integer, which may
not be possible with built-in types, but can be accomplished by using <i>wrapper record types</i>:
Records that have a lone single field. This idea of `boxing up' primitive types
allows us, for example, to define functions with arguments that are passed by reference
thereby modifying their arguments; such as the <code>swap</code> function that swaps the contents of its
arguments.
</p>
</div>
</div>

<div id="outline-container-orga8d4a3b" class="outline-4">
<h4 id="orga8d4a3b">Copy</h4>
<div class="outline-text-4" id="text-orga8d4a3b">
<p>
If we instead execute <code>y.fst ≔ x.fst; y.snd ≔ x.snd</code>
Then the resulting state is:
</p>
<pre class="example">
locations  =  x ↦ r₁, y ↦ r₂
values     =  r₁ ↦ r₃, r₂ ↦ r₄, r₃ ↦ {fst = 3, snd = 5}, r₄ ↦ {fst = 3, snd = 5}
                                                                    -Change Here-
</pre>

<p>
In this case, any alteration to <code>x</code>'s values are <i>not</i> observable by <code>y</code>.
</p>

<p>
Moreover, in this case, all fields are equal and so we have <code>x</code> and <code>y</code>
are <i>structurally equal</i>. This notion is sometimes called <code>equals method</code>
and the previous is <code>equals equals (==)</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-org3a78bf7" class="outline-3">
<h3 id="org3a78bf7">Arrays</h3>
<div class="outline-text-3" id="text-org3a78bf7">
<p>
<i>Arrays</i> are essentially records whose labels are numeric <i>and</i> all labels have
the same type. The number of fields of an array is determined during allocation
of the array, and not during the declaration of its type, as is the case with records.
This trade-off makes arrays more desirable in certain contexts.
</p>

<p>
The fields are usually numbered <code>0</code> to <code>n-1</code>, where <code>n</code> is the number of fields.
</p>

<p>
Once an array is allocated, its size cannot be changed.
&#x2013;Stop &amp; think: Why not?
</p>

<ul class="org-ul">
<li>Arrays of type <code>T</code> are denoted by <code>T[]</code> in C/Java.
<ul class="org-ul">
<li>Matrices, or arrays of arrays, are denoted by <code>T[][]</code> with access
by <code>T[i][j]</code>.</li>
</ul></li>
</ul>

<p>
C arrays, like records, are not allocated.
Consequently, their size cannot be determined by allocation and so must be
  a part of their type.
</p>

<p>
C arrays of type <code>T</code> of length <code>n</code> are declared using the mixfix syntax: <code>T x[n];</code>
Each element of the array is arbitrary &#x2013;with no designated defaults&#x2013;
so it is best to initialise them. E.g., <code>int x[10] = {};</code> sets all elements of
the array to 0.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">makeFive</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span>[], <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">length</span>)
{
  <span style="color: #859900; font-weight: bold;">for</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">i</span>=0; i != length; i++)
    x[i] = 5;
}

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">x</span>[3] = {};
  printf(<span style="color: #2aa198;">"\n x = [%d, %d, %d]"</span>, x[0], x[1], x[2]);

  makeFive(x, 3);
  printf(<span style="color: #2aa198;">"\n x = [%d, %d, %d]"</span>, x[0], x[1], x[2]);

  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
However, C arrays differ from C records in that array variables are actually
references that are associated in memory with an array. Consequently, array
arguments to methods are automatically pass by reference!
</p>

<p>
Moreover this means the assignment <code>t[k] = u</code> works in a rather general sense:
<code>t</code> suffices to be any expression whose <i>value</i> is a reference associated in memory
with an array.
</p>
</div>
</div>
</div>
<div id="outline-container-orge7509ec" class="outline-2">
<h2 id="orge7509ec">Arrays &#x2013; <code>\forall, \exists</code></h2>
<div class="outline-text-2" id="text-orge7509ec">
<p>
Arrays are commonly handled using loops; let's look at some examples.
</p>

<div class="org-src-container">
<pre class="src src-c" id="org2018855"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires 0 &lt; N;</span>
<span style="color: #96A7A9; font-style: italic;">  @ requires \valid_read(array + (0 .. N - 1));  // N is the length of the array</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns \nothing;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior found_element</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  @    assumes \exists integer i; 0 &lt;= i &lt; N  &amp;&amp;  array[i] == element;</span>
<span style="color: #96A7A9; font-style: italic;">  @    ensures 0 &lt;= \result &lt; N;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior did_not_find_element</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  @    assumes \forall integer i; 0 &lt;= i &lt; N  ==&gt; array[i] != element;</span>
<span style="color: #96A7A9; font-style: italic;">  @    ensures \result == N;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  @ disjoint behaviors;</span>
<span style="color: #96A7A9; font-style: italic;">  @ complete behaviors;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">int</span> linear_search(<span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">array</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">N</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">element</span>)
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">n</span> = 0;

  <span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ loop assigns n;</span>
<span style="color: #96A7A9; font-style: italic;">    @ loop invariant 0 &lt;= n &lt;= N;</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop invariant not_found_yet</span><span style="color: #96A7A9; font-style: italic;">: \forall integer i; 0 &lt;= i &lt; n  ==&gt;  array[i] != element;</span>
<span style="color: #96A7A9; font-style: italic;">    @ loop variant N - n;</span>
<span style="color: #96A7A9; font-style: italic;">    */</span>
  <span style="color: #859900; font-weight: bold;">while</span>( n != N  &amp;&amp; array[n] != element ) n++;
  <span style="color: #859900; font-weight: bold;">return</span> n &lt; N ? n : N;
}
</pre>
</div>

<p>
Some remarks are in order.
</p>

<ul class="org-ul">
<li><code>\valid_read(array + (0 .. N - 1))</code> ensures that the memory addresses
<code>array + 0, ..., array + N-1</code> can be read &#x2013;as discussed when introducing <code>\valid</code>.</li>

<li>The loop continues as long as we have not yet found the element.
<ul class="org-ul">
<li>As such, every index thus far differs from the element sought after.</li>
<li>That is, forall index <i>i</i> in the array bounds, we have <i>array[i] ≠ element</i>.</li>
<li>This invariant is stated using the <code>forall</code> syntax.</li>
</ul></li>

<li>The variable naming <code>n, N</code> is intended to be suggestive:
When <i>n = N</i> then we have traversed the whole array.
<ul class="org-ul">
<li>We began at 0 and are working upward to <i>N</i>.</li>
<li>At each step, we traverse the array by one more item
thereby decreasing the amount of items remaining &#x2013;which is <i>N - n</i>.</li>
</ul></li>

<li>If it is <i>provable</i> that some index contains the desired element,
then in that case our program ensures the output result is a valid index.</li>

<li>The ACSL type <code>integer</code> is preferable to the C type <code>int</code> since it is not constrained by
any representation limitations and instead acts more like its pure mathematical counterpart ℤ.</li>
</ul>

<p>
It is important to note that the universal ‘∀’ uses <code>==&gt;</code> to delimit the
range from the body predicate, whereas the existential ‘∃’ uses <code>&amp;&amp;</code>
&#x2013;this observation is related to the “trading laws” for quantifiers.
</p>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>\forall type x; r(x) ==&gt; p(x)</code></td>
<td class="org-left">Every element <code>x</code> in range <code>r</code> satisfies <code>p</code></td>
</tr>

<tr>
<td class="org-left"><code>\exists type x; r(x) &amp;&amp; p(x)</code></td>
<td class="org-left">Some  element <code>x</code> in range <code>r</code> satisfies <code>p</code></td>
</tr>
</tbody>
</table>

<p>
Notice the striking difference between
the <code>\exists integer x; \false &amp;&amp; even x</code>
&#x2013;which is unprovable since false is never true!&#x2013;
and <code>\exists integer x; \false ==&gt; even x</code>
&#x2013;which can be satisfied by infinitely many <code>x</code>, since false implies anything.
</p>
<p>
Of course we could start at the end of the array and “work down” until
we find the element, or otherwise, say, return -1. Let's do so without using
a new local variable <code>n</code>.
</p>

<details>
<div class="org-src-container">
<pre class="src src-c" id="org58a35a2"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires 0 &lt; N;</span>
<span style="color: #96A7A9; font-style: italic;">  // </span><span style="color: #b58900;">@ requires Exercise</span><span style="color: #96A7A9; font-style: italic;">: read access to a[0], ..., a[N-1];</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  // @ assigns FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior found_element</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    assumes Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;  // &#8220;element &#8712; array&#8221;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    ensures Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;  // Output is valid index in array</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ behavior did_not_find_element</span><span style="color: #96A7A9; font-style: italic;">:</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    assumes Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;     // &#8220;element &#8713; array&#8221;</span>
<span style="color: #96A7A9; font-style: italic;">  @    ensures \result == -1;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  @ disjoint behaviors;</span>
<span style="color: #96A7A9; font-style: italic;">  @ complete behaviors;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">linear_search_no_local</span>(<span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">array</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">N</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">element</span>)
{
  <span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ loop assigns N;</span>
<span style="color: #96A7A9; font-style: italic;">    @ loop invariant 0 &lt;= N &lt;= \at(N, Pre);</span>
<span style="color: #96A7A9; font-style: italic;">    // </span><span style="color: #b58900;">@ loop invariant not_found_yet: Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">    // </span><span style="color: #b58900;">@ loop variant Exercise: FixMe</span><span style="color: #96A7A9; font-style: italic;">: 666;</span>
<span style="color: #96A7A9; font-style: italic;">    */</span>
  <span style="color: #859900; font-weight: bold;">while</span>( 0 != N  &amp;&amp; array[N-1] != element ) N--;
  <span style="color: #859900; font-weight: bold;">return</span> N - 1;
}
</pre>
</div>
</details>
<details>
<div class="org-src-container">
<pre class="src src-c" id="org2876036"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #b58900;">@ requires Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe; // array[0], ..., array[N-1] are accessible</span>
<span style="color: #96A7A9; font-style: italic;">  @ requires element &lt; INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns array[0 .. N-1];</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures Exercise: all_array_equals_element</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">make_constant</span>(<span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">array</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">N</span>, <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">element</span>)
{
  <span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ loop assigns N, array[0 .. \at(N,Pre)-1];</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop invariant range_on_N</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop invariant constant_so_far</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">    @ loop variant N;</span>
<span style="color: #96A7A9; font-style: italic;">    */</span>
  <span style="color: #859900; font-weight: bold;">for</span> (; 0 != N; N--) array[N-1] = element;
}
</pre>
</div>
</details>
<br>

<p>
Notice that the invariants are getting way too long &#x2013;and worse: Repetitive!
We can abstract common formulae into more general and reusable shapes by
declaring them as ACSL logical functions &#x2013;keep reading!
</p>

<p>
On an unrelated note, sometimes we try to prove a program that we just
coded incorrectly, so if things are going nowhere then maybe try a few tests
to ensure you're on the right track.
</p>
</div>
</div>
<div id="outline-container-orgeac9a1b" class="outline-2">
<h2 id="orgeac9a1b">Recursion</h2>
<div class="outline-text-2" id="text-orgeac9a1b">
<p>
The definition of <code>wp</code> for function calls is correct provided the function body
itself only contains invocations to <i>previously</i> defined functions?
</p>

<p>
What about <i>recursive function definitions</i>:
Definitions invoking the function being defined or invoking functions that invoke
functions that eventually invoke the function currently being defined?
</p>

<p>
Since invocations are delegated to the state, which handles all defined names,
we may invoke whatever function provided its name is found.
Since C requires names to be declared before use, we may have mutually recursive
functions by ‘prototyping’: Declaring the function signature, then at some point
providing the actual implementation.
</p>
<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>
<span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdbool.h&gt;</span>

<span style="color: #b58900; font-style: italic;">bool</span> <span style="color: #b58900;">odd</span>(<span style="color: #b58900; font-style: italic;">int</span>); <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">protoyping the odd function</span>

<span style="color: #b58900; font-style: italic;">bool</span> <span style="color: #b58900;">even</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">n</span>) <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">using odd here, even though it's not yet defined</span>
{
  <span style="color: #859900; font-weight: bold;">if</span> (n == 0) <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">true</span>;
  <span style="color: #859900; font-weight: bold;">else</span>        <span style="color: #859900; font-weight: bold;">return</span> odd(n - 1);
}

<span style="color: #b58900; font-style: italic;">bool</span> <span style="color: #b58900;">odd</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">n</span>)
{
  <span style="color: #859900; font-weight: bold;">if</span> (n == 0) <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #6c71c4; font-weight: bold;">false</span>;
  <span style="color: #859900; font-weight: bold;">else</span>        <span style="color: #859900; font-weight: bold;">return</span> even(n - 1);
}

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  printf(<span style="color: #2aa198;">"\n 7 is even? ... %d"</span>, even(7));
  printf(<span style="color: #2aa198;">"\n 7 is odd? ... %d"</span>, odd(7));
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>
</details>

<p>
Anyhow, e.g., <code>void f(int x){ f(x); }</code> has the definition of <code>wp f(x)</code> using the value of <code>wp f(x)</code>
and so is circular. How can this be avoided?
</p>

<p>
Note that a <i>recursive definition</i> is <b>not</b> just a definition that uses the object which it
is defining. Otherwise, the previous <code>f</code> might as well have been the definition of
the factorial function that on input <code>x</code> simply invokes itself; then again it could
have been any function!
</p>

<details>
<p>
We generally think of recursive definitions as definitions by usual ℕ-induction, however
this is not absolutely true.
E.g., the following function at <code>n</code> not only relies on
values on smaller inputs but also on values at larger inputs to compute the value at <code>n</code>!
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #268bd2; font-weight: bold;">#include</span><span style="color: #2aa198;">&lt;stdio.h&gt;</span> <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">for IO</span>

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">iterations</span> = 0;
<span style="color: #268bd2; font-weight: bold;">#define</span> <span style="color: #b58900;">RETURN</span>(<span style="color: #268bd2;">i</span>, <span style="color: #268bd2;">n</span>) { printf(<span style="color: #2aa198;">"\n **Computed value for input %d is %d**"</span>, i, n); \
                       iterations++; <span style="color: #859900; font-weight: bold;">return</span> n; }

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Uses smaller as well as larger values just to compute current value!</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">f</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">n</span>)
{
  printf(<span style="color: #2aa198;">"\n Computing value for: %d"</span>, n);

  <span style="color: #859900; font-weight: bold;">if</span> (n &lt;= 1)     RETURN(n, 1)
  <span style="color: #859900; font-weight: bold;">if</span> (n % 2 == 0) RETURN(n, 1 + f(n / 2))
  <span style="color: #859900; font-weight: bold;">else</span>            RETURN(n, 2 * f(n + 1))
}

<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">main</span>()
{
  f(12);
  printf(<span style="color: #2aa198;">"\n\n The function was invoked for a total of %d times!"</span>, iterations);
  <span style="color: #859900; font-weight: bold;">return</span> 0;
}
</pre>
</div>

<p>
Similarly the Ackermann function is a recursive function that has been proven
to be undefinable using only nested definitions by ℕ-induction.
( However, since ℕ×ℕ is well-ordered, it is a valid definition. )
</p>
</details>

<p>
We may try to remove recursive calls by replacing every recursive call with
the function body itself, which then has a new recursive call. We may continue
to expand forever by replacing recursive calls with the original function body.
The “result” will be an non-recursive program that is infinitely long.
</p>

<p>
Thus, recursive programs, like <code>while</code> loops, are a means of expressing infinite
programs and, like <code>while</code> loops, they introduce the possibility of non-termination.
</p>

<p>
As for <code>while</code> loops, we can approximate the infinitely long non-recursive program
by simply giving-up on the <code>n</code>-th expansion, not making any more recursive calls.
Essentially, we do <code>n</code> recursive calls then give-up if the program has not completed.
Hence, we again consider the limit.
</p>
</div>

<div id="outline-container-org463020a" class="outline-3">
<h3 id="org463020a">Recursive Definitions and Fixed Point Equations</h3>
<div class="outline-text-3" id="text-org463020a">
<p>
A recursive function such as the factorial function can be seen as
an equation where the unknown variable is the function currently being defined.
For example, the factorial function is the <i>unique partial function</i> <code>f</code> satisfying
the equation
</p>
<div class="org-src-container">
<pre class="src src-haskell">f  <span style="color: #b58900;">&#8776;</span> (x <span style="color: #268bd2;">&#8614;</span> <span style="color: #859900; font-weight: bold;">if</span> x <span style="color: #268bd2;">&#8776;</span> 0 <span style="color: #859900; font-weight: bold;">then</span> 1 <span style="color: #859900; font-weight: bold;">else</span> x <span style="color: #268bd2;">*</span> f(x<span style="color: #268bd2;">-</span>1))
</pre>
</div>
<p>
This equation has the form <code>f ≈ F(f)</code>, so it is a “fixed point equation”.
</p>

<p>
Since recursive functions may not terminate, the functions they describe
are partial. It can be proven that any fixed point equation <i>always</i> has
at least one solution; i.e., it defines at least one partial function on the integers.
For example, the equation <code>f ≈ (x ↦ 1 + f(x))</code> corresponding to
</p>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">loop</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">n</span>){ <span style="color: #859900; font-weight: bold;">return</span> 1 + loop(n); }
</pre>
</div>
<p>
Has one solution: The empty function, which is not defined on any input.
</p>

<p>
The set of possible solutions can be ordered by inclusion
of their graphs and so one of them is the smallest.
Incidentally, this least solution is also obtained by the aforementioned limit!
</p>

<p>
E.g., every function is a solution to the equation <code>f ≈ (x ↦ f x)</code>.
</p>
</div>
</div>

<div id="outline-container-org1414470" class="outline-3">
<h3 id="org1414470">Programming without Assignment &#x2013;the Functional Core</h3>
<div class="outline-text-3" id="text-org1414470">
<p>
Notice that the factorial function can be written without using assignments:
</p>
<details>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ axiomatic Factorial</span>
<span style="color: #96A7A9; font-style: italic;">  @ {</span>
<span style="color: #96A7A9; font-style: italic;">  @    logic integer factorial(integer n);</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    axiom fact_zero</span><span style="color: #96A7A9; font-style: italic;">:  \forall integer n;    factorial(0) == 1;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    axiom fact_succ</span><span style="color: #96A7A9; font-style: italic;">:  \forall integer n; 0 &lt;= n</span>
<span style="color: #96A7A9; font-style: italic;">  @                 ==&gt;  factorial (n + 1) == n * factorial (n);</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    axiom fact_monotone </span><span style="color: #96A7A9; font-style: italic;">: \forall integer m,n; 0 &lt;= m &lt;= n</span>
<span style="color: #96A7A9; font-style: italic;">  @          ==&gt; factorial(m) &lt;= factorial(n);</span>
<span style="color: #96A7A9; font-style: italic;">  @ }</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
</pre>
</div>
</details>
<div class="org-src-container">
<pre class="src src-c" id="orgb51617f"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #b58900;">@ requires Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns \nothing;</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@ ensures Exercise</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">fact_imp</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">n</span>)
{
  <span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">r</span> = 1;

  <span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ loop assigns i, r;</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop invariant range_on_i</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop invariant relationship_between_r_i_n</span><span style="color: #96A7A9; font-style: italic;">: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">    </span><span style="color: #b58900;">@ loop variant FixMe</span><span style="color: #96A7A9; font-style: italic;">: 666;</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
  <span style="color: #859900; font-weight: bold;">for</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">i</span> = 1; i &lt;= n; i++)
    r = r * i;

  <span style="color: #859900; font-weight: bold;">return</span> r;
}

<span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">&#8776;</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ requires 0 &lt;= n;</span>
<span style="color: #96A7A9; font-style: italic;">  @ requires factorial(n) &lt;= INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">  @ assigns \nothing;</span>
<span style="color: #96A7A9; font-style: italic;">  @ ensures \result == factorial(n);</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #b58900;">fact_functional</span>(<span style="color: #b58900; font-style: italic;">int</span> <span style="color: #268bd2;">n</span>)
{
  <span style="color: #859900; font-weight: bold;">if</span> (n == 0) <span style="color: #859900; font-weight: bold;">return</span> 1;
  <span style="color: #859900; font-weight: bold;">return</span> n * fact_functional(n - 1);
}
</pre>
</div>
<p>
( Notice that <i>¬(i ≤ n)[i ≔ 1]  ≡  n = 0</i> when considering <i>n : ℕ</i>. )
</p>

<p>
Hence if we remove assignments, then the memory state for computation is
always empty and so sequences and loops become useless. We are left with
only variable declarations, function calls, and the built-in operations.
This is the <i>functional core</i> of the language and it is surprisingly as powerful
as the imperative core. Why? Recall that a term, or statement, can be thought
of as a (partial) function of its free variables; now the functions obtained
this way using only the functional core are the same as those obtained by also
using the whole of the imperative core!
Note that omitting recursion falsifies this result.
</p>
</div>
</div>
</div>

<div id="outline-container-org87c558b" class="outline-2">
<h2 id="org87c558b">Hehner's Problem</h2>
<div class="outline-text-2" id="text-org87c558b">
<p>
We have now covered enough material to tackle the problem posed
at the very beginning &#x2014;that of <code>whatDo</code>.
</p>

<details>
<div class="org-src-container">
<pre class="src src-c" id="org689a488"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@  requires \valid(x) &amp;&amp; \valid(y);</span>
<span style="color: #96A7A9; font-style: italic;">     requires 0 &lt;= *x &lt; 31;</span>
<span style="color: #96A7A9; font-style: italic;">     requires Exercise: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;">     assigns *x, *y;</span>
<span style="color: #96A7A9; font-style: italic;">     ensures Exercise: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">whatDo</span>(<span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">x</span>, <span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">y</span>)
{
  <span style="color: #859900; font-weight: bold;">if</span> (*x == 0)
    {
      *y = 1; *x = 3;
    }
  <span style="color: #859900; font-weight: bold;">else</span>
    {
      *x -= 1; *y = 7;
      whatDo(x, y);
      *y *= 2; *x = 5;
    }
}
</pre>
</div>
</details>

<p>
Running a few test inputs, it can be seen that this program
sets <code>y</code> to be the power of <code>x</code>. Further testing may reveal interesting
issues when <code>x</code> and <code>y</code> refer to the same memory location!
</p>

<details>
<pre class="example">
⟨x = 0, y = 0⟩ ↦ ⟨x = 3, y = 1⟩
⟨x = 1, y = 2⟩ ↦ ⟨x = 5, y = 2⟩
⟨x = 3, y = 4⟩ ↦ ⟨x = 5, y = 8⟩
⟨x = 5, y = 6⟩ ↦ ⟨x = 5, y = 32⟩
⟨x = 7, y = 8⟩ ↦ ⟨x = 5, y = 128⟩
⟨x = 0, y = 99⟩ ↦ ⟨x = 3, y = 1⟩

x == y  ⇒  Segmentation Fault
</pre>
</details>

<p>
With this guidance in hand, we aim to axiomatise the power function:
</p>
<div class="org-src-container">
<pre class="src src-c" id="org5878607"><span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@ axiomatic Pow</span>
<span style="color: #96A7A9; font-style: italic;">  @ {</span>
<span style="color: #96A7A9; font-style: italic;">  @    logic integer pow(integer b, integer n);</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    axiom pow_zero</span><span style="color: #96A7A9; font-style: italic;">:  \forall integer b;        pow(b, 0) == 1;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    axiom pow_one</span><span style="color: #96A7A9; font-style: italic;">:  \forall integer b;        pow(b, 1) == b;</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    axiom pow_homomorphism</span><span style="color: #96A7A9; font-style: italic;">:  \forall integer b, m, n;</span>
<span style="color: #96A7A9; font-style: italic;">  @                 pow(b, m + n) == pow(b, m) * pow(b, n);</span>
<span style="color: #96A7A9; font-style: italic;">  @</span>
<span style="color: #96A7A9; font-style: italic;">  </span><span style="color: #b58900;">@    axiom pow_monotone </span><span style="color: #96A7A9; font-style: italic;">: \forall integer b,m,n; b &gt;= 0  &amp;&amp;  0 &lt;= m &lt;= n</span>
<span style="color: #96A7A9; font-style: italic;">  @          ==&gt; pow(b,m) &lt;= pow(b,n);</span>
<span style="color: #96A7A9; font-style: italic;">  @ }</span>
<span style="color: #96A7A9; font-style: italic;">  */</span>
</pre>
</div>

<p>
Notice that there are infinitely many solutions <code>f</code> to the equations
</p>
<ul class="org-ul">
<li><code>pow_zero</code>: <i>f(0) = 1</i></li>
<li><code>pow_homomorphism</code>: <i>f(m + n) = f(m) * f(n)</i></li>
</ul>

<p>
Which ones? Since every natural number is of the form <i>1 + 1 + ⋯ + 0</i>
the second requirement yields \\ <i>f(n) = f (1 + 1 + ⋯ + 0) = f 1 * f 1 * ⋯ f 1 * f 0;</i>
which by the first requirement simplifies to <i>f(n) = (f 1)ⁿ</i>.
Hence for any choice of number <i>f(1) : ℕ</i>, we obtain a function <i>f</i>
that satisfies these definitions. If we want <i>f</i> to be the <i>n</i> product of a number
<i>b</i> then we need to insist <i>f 1 = b</i> &#x2013;which is just <code>pow_one</code>!
</p>

<p>
From the axioms, we obtain some useful lemmas.
</p>
<div class="org-src-container">
<pre class="src src-c" id="orge11fc1c"><span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ lemma pow_succ</span><span style="color: #96A7A9; font-style: italic;">:  \forall integer b, n; n &gt;= 0  ==&gt;     pow(b, n + 1) == pow(b, n) * b;</span>
<span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ lemma powNonNeg </span><span style="color: #96A7A9; font-style: italic;">: \forall integer b,n; b &gt;= 0 ==&gt; n &gt;= 0 ==&gt; pow(b,n) &gt;= 0;</span>
<span style="color: #96A7A9; font-style: italic;">//</span><span style="color: #b58900;">@ lemma pow2bound </span><span style="color: #96A7A9; font-style: italic;">: \forall integer n; 0 &lt;= n &lt; 31 ==&gt; pow(2, n) &lt; INT_MAX;</span>
<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #b58900;">@ lemma powPredT </span><span style="color: #96A7A9; font-style: italic;">: \forall integer b,n,m;  b &gt;= 0  &amp;&amp;  n &gt; 0</span>
<span style="color: #96A7A9; font-style: italic;">                                &amp;&amp;  pow(b, n) &lt;= m  ==&gt;  b * pow(b, n-1) &lt;= m;</span><span style="color: #96A7A9; font-style: italic;"> */</span>
</pre>
</div>

<p>
With this setup, the reader should now be able to solve the <code>FixMe</code>'s in <code>whatDo</code>
&#x2013;which I've renamed to “hehner”, after the fellow who showed it as an example
in his excellent specifications and correctness text, <a href="http://www.cs.toronto.edu/~hehner/aPToP/">A Practical Theory of Programming</a>.
</p>
<div class="org-src-container">
<pre class="src src-c" id="orgdd6fdcc"><span style="color: #268bd2; font-weight: bold;">#include</span> <span style="color: #2aa198;">"Prelude.c"</span>

<span style="color: #96A7A9; font-style: italic;">/*</span><span style="color: #96A7A9; font-style: italic;">@  requires \valid(x) &amp;&amp; \valid(y);</span>
<span style="color: #96A7A9; font-style: italic;">     requires 0 &lt;= *x &lt; 31;</span>
<span style="color: #96A7A9; font-style: italic;">     requires Exercise: FixMe;      // Assuming \false, gives us anything!</span>
<span style="color: #96A7A9; font-style: italic;">     assigns *x, *y;</span>
<span style="color: #96A7A9; font-style: italic;">     ensures Exercise: FixMe;</span>
<span style="color: #96A7A9; font-style: italic;"> */</span>
<span style="color: #b58900; font-style: italic;">void</span> <span style="color: #b58900;">hehner</span>(<span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">x</span>, <span style="color: #b58900; font-style: italic;">int</span>* <span style="color: #268bd2;">y</span>)
{
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">Introduce a local for reasoning, to avoid having to write \at(*x, Pre).</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">ghost const int X = *x;</span>

  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert given: 0 &lt;= X &lt; 31;</span>
  <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert taking_powers_with_monotonicity: 1 &lt;= pow(2,X) &lt;= INT_MAX;</span>
  <span style="color: #859900; font-weight: bold;">if</span> (*x == 0)
    {
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert condition: X == 0;</span>
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert taking_powers: pow(2,X) == 1;</span>
      *y = 1; *x = 3;
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert *y == pow(2,X);</span>
    }
  <span style="color: #859900; font-weight: bold;">else</span>
    {
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert condition: 0 &lt; X &lt; 31;</span>
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert pow_with_monotonicity: 1 &lt; pow(2, X) &lt;= INT_MAX;</span>
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert factoring: 2 * pow(2, X-1) &lt;= INT_MAX;</span>

      *x -= 1; *y = 7;
      hehner(x, y);

      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert function_ensures: *y == pow(2, X - 1);</span>
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert pow(2, X) == 2 * pow(2, X - 1);</span>
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert     pow(2, X    ) &#8804; INT_MAX;</span>
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert 2 * pow(2, X - 1) &#8804; INT_MAX;</span>
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert y2_no_overflow: *y * 2 &#8804; INT_MAX;</span>

      *y *= 2; *x = 5;

      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert our_goal: *y == pow(2, X);</span>
      <span style="color: #96A7A9; font-style: italic;">// </span><span style="color: #96A7A9; font-style: italic;">assert incidentally: *y &lt;= INT_MAX;</span>
    }
}
</pre>
</div>

<p>
I've left the <code>assert</code>'s since they may make the program proof more comprehensible
to the reader &#x2013;yet notice that I did not use <code>@</code> and so they are not visible,
nor necessary, to Frama-C.
</p>
</div>
</div>

<div id="outline-container-org7b68c84" class="outline-2">
<h2 id="org7b68c84">Advanced Data Structures</h2>
<div class="outline-text-2" id="text-org7b68c84">
<p>
This is what I have so far, yet I look forward to including material
utilising linked lists as well as making more of the Curry-Howard Correspondence.
</p>

<p>
Anyhow, I hope you've enjoyed yourself and hopefully learned something neat! Byebye!
</p>
</div>
</div>

<div id="outline-container-org5ed5e4a" class="outline-2">
<h2 id="org5ed5e4a">The Underlying Elisp</h2>
<div class="outline-text-2" id="text-org5ed5e4a">
<p>
The following utilities are loaded when this file is opened.
After the first time the file <code>InteractiveWayToC.el</code> is created and this section
may be deleted, or <code>COMMENT</code>-ed, as it is loaded in the <code>footer</code> section at the end of this file.
</p>

<ol class="org-ol">
<li>Make some changes, look at them with <code>f7</code>.
<ul class="org-ul">
<li>Or execute with <code>f6</code> if there is a <code>main</code> method.</li>
</ul></li>
<li>Check your progress with <code>f9</code>, within Emacs.</li>
<li>If confused, open the Frama-C gui with <code>f8</code>.</li>
</ol>

<p>
Note: There is a 10 second time limit on the proof search.
</p>

<p>
Every source block is in ‘focus’ when the variables <code>NAME</code> and <code>NAMECode</code> refer to it.
</p>
<details>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">setq</span> Language <span style="color: #2aa198;">"c"</span> LanguageExtension <span style="color: #2aa198;">"c"</span>)
(<span style="color: #859900; font-weight: bold;">setq</span> NAMEEXT (<span style="color: #b58900;">buffer-name</span>) NAME (<span style="color: #b58900;">file-name-sans-extension</span> NAMEEXT))
(<span style="color: #859900; font-weight: bold;">setq</span> NAMECode (<span style="color: #b58900;">concat</span> NAME <span style="color: #2aa198;">"."</span> LanguageExtension))
</pre>
</div>
</details>

<p>
We explicitly change focus using <code>[not-]currently-working-with</code> methods.
</p>
<details>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">buffer-name-sans-extension</span> () <span style="color: #35a69c; font-style: italic;">""</span>
  (<span style="color: #b58900;">file-name-sans-extension</span> (<span style="color: #b58900;">buffer-name</span>))
)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">currently-working-with</span> (<span style="color: #b58900; font-style: italic;">&amp;optional</span> name)
  <span style="color: #35a69c; font-style: italic;">"Provide the name (without extension) of the source block's resulting file.</span>
<span style="color: #35a69c; font-style: italic;">   The name is then tied to the &#8220;NAMECode&#8221; global variable utilised</span>
<span style="color: #35a69c; font-style: italic;">   by the &#8220;show-code&#8221; method, &lt;f7&gt;, and the &#8220;interpret&#8221; command's global variable &#8220;NAME&#8221;.</span>

<span style="color: #35a69c; font-style: italic;">   If no argument is provided, we use &#8220;&#10218;BufferName&#10219;.c&#8221; as default file name.</span>
<span style="color: #35a69c; font-style: italic;">  "</span>
  (<span style="color: #859900; font-weight: bold;">unless</span> name (<span style="color: #859900; font-weight: bold;">setq</span> name (buffer-name-sans-extension)))
  (<span style="color: #859900; font-weight: bold;">setq</span> NAME name)
  (<span style="color: #859900; font-weight: bold;">setq</span> NAMECode (<span style="color: #b58900;">concat</span> name <span style="color: #2aa198;">".c"</span>))
)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">not-currently-working-with</span> (<span style="color: #b58900; font-style: italic;">&amp;optional</span> name)
  <span style="color: #35a69c; font-style: italic;">"When &#8220;:tangle fn&#8221; has &#8220;fn&#8221; being the empty string, the tangle does not transpire.</span>
<span style="color: #35a69c; font-style: italic;">   As such, it is as if we are not actually generating the source block.</span>

<span style="color: #35a69c; font-style: italic;">   This operation only returns the empty string and does not alter any existing state.</span>
<span style="color: #35a69c; font-style: italic;">   If we alter state, then earlier invocations to (currently-working-with) are rendered</span>
<span style="color: #35a69c; font-style: italic;">   useless!</span>
<span style="color: #35a69c; font-style: italic;">  "</span>

  <span style="color: #2aa198;">""</span>   <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Our return value.</span>
)
</pre>
</div>
</details>

<p>
Notice that the <code>InteractiveWayToC.el</code> methods &#x2013;&lt;F6&gt; to &lt;F9&gt;&#x2013; target the
source block(s) with (<code>currently-working-with name)</code> where <code>name</code> is the most
recent name. Note that the <code>name</code> component need not be unique: Blocks having
the same one write to the same file.
</p>

<p>
In a new line enter <code>&lt;s</code> then at the end press <code>TAB</code> to obtain a nice hello-world
template. Some code will be generated for you &#x2013;free of charge&#x2013;, edit it as you like.
</p>
<details>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">make-variable-buffer-local</span> '<span style="color: #268bd2;">org-structure-template-alist</span>)
(<span style="color: #859900; font-weight: bold;">setq</span> TEMPLATE
  (<span style="color: #b58900;">concat</span>
   <span style="color: #2aa198;">"#+NAME: ???? -- goal of this code block"</span>
   <span style="color: #2aa198;">"\n#+BEGIN_SRC "</span> Language <span style="color: #2aa198;">" :tangle (currently-working-with \"HelloWorld\") \n"</span>
   <span style="color: #2aa198;">"#include&lt;stdio.h&gt; // for IO"</span>
   <span style="color: #2aa198;">"\nint main() \n{\n  printf(\"--Hello, World!--\");\n  return 0; \n}"</span>
   <span style="color: #2aa198;">"\n#+END_SRC"</span>))
(<span style="color: #b58900;">add-to-list</span> '<span style="color: #268bd2;">org-structure-template-alist</span> `(<span style="color: #2aa198;">"s"</span> ,TEMPLATE))
</pre>
</div>
</details>

<p>
Then to see the code generated by this file press <code>M-x</code> then enter <code>show-code</code> then enter;
alternatively, press <code>C-x C-e</code> after the final parenthesis: (show-code).
</p>

<p>
My definition of <code>(show-code)</code> begins with closing the code buffer if it exists,
then continue by extracting the most recent code and displaying it below the current buffer.
The definition of <code>(interpret)</code> is nearly the same except we switch to an output buffer,
and create it if it doesn't exist.
Note that our interpretation command is essentially the following command line invocation:
<code>NAME=myfilename ; gcc $NAME.c -o $NAME.exe ; ./$NAME.exe</code>
</p>

<details>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">show-code</span> () <span style="color: #35a69c; font-style: italic;">"Show focused source blocks in a new buffer."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #859900; font-weight: bold;">ignore-errors</span> (<span style="color: #b58900;">kill-buffer</span> NAMECode))
  (<span style="color: #b58900;">save-buffer</span>)
  (<span style="color: #b58900;">org-babel-tangle</span>)
  (<span style="color: #b58900;">split-window-below</span>)
  (<span style="color: #b58900;">find-file</span> NAMECode)
  (<span style="color: #b58900;">other-window</span> 1))

<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Since there are many generated files, let's mention the name</span>
<span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">of the program file currently being executed, or proven.</span>
<span style="color: #96A7A9; font-style: italic;">;;</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">insert-focused-name</span> ()
   <span style="color: #35a69c; font-style: italic;">"Insert the name of the focused source blocks at the beginning of the buffer."</span>
  (<span style="color: #b58900;">beginning-of-buffer</span>)
  (<span style="color: #b58900;">insert</span> <span style="color: #2aa198;">"================\n&#10218; "</span> NAME <span style="color: #2aa198;">".c &#10219;\n================\n\n"</span>))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">interpret</span> () <span style="color: #35a69c; font-style: italic;">"Execute focused source blocks in a new buffer."</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #b58900;">save-buffer</span>)
  (<span style="color: #b58900;">org-babel-tangle</span>)
  (<span style="color: #b58900;">switch-to-buffer-other-window</span> <span style="color: #2aa198;">"*Shell Command Output*"</span>)
  (<span style="color: #b58900;">shell-command</span>
    (<span style="color: #b58900;">concat</span> <span style="color: #2aa198;">"cd "</span> <span style="color: #268bd2;">default-directory</span> <span style="color: #2aa198;">"; NAME="</span> NAME <span style="color: #2aa198;">" ; gcc $NAME.c -o $NAME.exe ; ./$NAME.exe"</span>))
  (insert-focused-name)
  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Go back to the literate buffer.</span>
  (<span style="color: #b58900;">other-window</span> 1))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">frama-c</span> () <span style="color: #35a69c; font-style: italic;">""</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #b58900;">save-buffer</span>)
  (<span style="color: #b58900;">org-babel-tangle</span>)
  (<span style="color: #b58900;">shell-command</span> (<span style="color: #b58900;">concat</span> <span style="color: #2aa198;">"frama-c-gui "</span> NAMECode <span style="color: #2aa198;">" -wp -rte &amp;"</span>)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">try</span> (this that) <span style="color: #35a69c; font-style: italic;">""</span>
  (<span style="color: #859900; font-weight: bold;">condition-case</span> nil (<span style="color: #b58900;">eval</span> this) (<span style="color: #b58900;">error</span> (<span style="color: #b58900;">eval</span> that))))
</pre>
</div>
</details>

<p>
The <code>frama-c-no-gui</code> command tries to find where an error happens by placing the cursor
near an unproven assertion. It does so by looking for the phrase <code>false</code> in the shell output
buffer after the <code>frama-c</code> program is invoked. If it cannot find it, you are placed at
the end of the buffer and, ideally but not necessarily, should see all goals have passed.
</p>

<details>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">frama-c-no-gui</span> () <span style="color: #35a69c; font-style: italic;">""</span>
  (<span style="color: #859900; font-weight: bold;">interactive</span>)
  (<span style="color: #b58900;">org-babel-tangle</span>)
  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Avoid generating proof goal statements --for now.</span>
  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">(shell-command (concat "frama-c " NAMECode " -wp -wp-msg-key=print-generated -rte"))</span>
  (<span style="color: #b58900;">shell-command</span> (<span style="color: #b58900;">concat</span> <span style="color: #2aa198;">"frama-c "</span> NAMECode <span style="color: #2aa198;">" -wp -wp-timeout 10 -rte"</span>))

  (<span style="color: #b58900;">switch-to-buffer-other-window</span> <span style="color: #2aa198;">"*Shell Command Output*"</span>)
  (insert-focused-name)
  (<span style="color: #b58900;">hl-line-mode</span>)

  (<span style="color: #859900; font-weight: bold;">setq</span> frama-c-state (<span style="color: #859900; font-weight: bold;">catch</span> '<span style="color: #6c71c4; font-weight: bold;">state</span>   <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Global variable indicating current state</span>
  (<span style="color: #859900; font-weight: bold;">dolist</span> (elem '(<span style="color: #2aa198;">"Exercise"</span> <span style="color: #2aa198;">"unknown"</span> <span style="color: #2aa198;">"user error"</span> <span style="color: #2aa198;">"false"</span> <span style="color: #2aa198;">"Timeout"</span> <span style="color: #2aa198;">"Proved goals"</span>))
    (<span style="color: #b58900;">beginning-of-buffer</span>)
    (try '(<span style="color: #859900; font-weight: bold;">and</span> (<span style="color: #b58900;">search-forward</span> elem) (<span style="color: #859900; font-weight: bold;">throw</span> '<span style="color: #6c71c4; font-weight: bold;">state</span> elem)) 'nil)
  )))

  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">global variable about status</span>
  (<span style="color: #859900; font-weight: bold;">setq</span> frama-c-status (<span style="color: #b58900;">format</span> <span style="color: #2aa198;">"Frama-C: %d&#65130; of proof complete!"</span> (frama-c-progress)))

  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Use the red colour of failure.</span>
  (<span style="color: #b58900;">set-face-background</span> '<span style="color: #556b72; background-color: #FDF6E3;">hl-line</span> <span style="color: #2aa198;">"pink"</span>)

  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Or did we succeed?</span>
  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">We might have halted a &#8220;false&#8221; *constant* even though all goals pass.</span>
  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">&#10216; This is not an issue when proofs are not being generated. &#10217;</span>
  (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #b58900;">equal</span> frama-c-state <span style="color: #2aa198;">"Exercise"</span>)
        (<span style="color: #859900; font-weight: bold;">setq</span> frama-c-status (<span style="color: #b58900;">concat</span> frama-c-status <span style="color: #2aa198;">" &#10218;There are holes!&#10219;"</span>))
        (<span style="color: #859900; font-weight: bold;">when</span> (<span style="color: #859900; font-weight: bold;">or</span> (<span style="color: #b58900;">equal</span> frama-c-state <span style="color: #2aa198;">"Proved goals"</span>)
                  (<span style="color: #b58900;">eq</span> (frama-c-progress) 100))
              (<span style="color: #b58900;">set-face-background</span> '<span style="color: #556b72; background-color: #FDF6E3;">hl-line</span> <span style="color: #2aa198;">"pale green"</span>)
              (try '(<span style="color: #b58900;">search-forward</span> <span style="color: #2aa198;">"Proved goals"</span>) <span style="color: #268bd2;">t</span>)))
  (<span style="color: #b58900;">message</span> frama-c-status)
  (<span style="color: #b58900;">minimize-window</span>) <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">Make current buffer roughly 3 lines in height.</span>
)
</pre>
</div>
</details>

<p>
Where the <code>frama-c-progress</code> command yields the percentage denoting the number of goals proven.
</p>
<details>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #b58900;">frama-c-progress</span> () <span style="color: #35a69c; font-style: italic;">""</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ( (here (<span style="color: #b58900;">point</span>)) )
  (<span style="color: #b58900;">beginning-of-buffer</span>)
  (try '(<span style="color: #b58900;">search-forward</span> <span style="color: #2aa198;">"Proved goals:"</span>) 0)
  <span style="color: #96A7A9; font-style: italic;">;; </span><span style="color: #96A7A9; font-style: italic;">(kill-line)</span>
    (<span style="color: #b58900;">copy-region-as-kill</span> (<span style="color: #b58900;">point</span>) (<span style="color: #b58900;">point-at-eol</span>))
    (<span style="color: #b58900;">goto-char</span> here)
    (<span style="color: #b58900;">*</span> 100 (<span style="color: #b58900;">string-to-number</span> (<span style="color: #b58900;">calc-eval</span> (<span style="color: #b58900;">current-kill</span> 0))))
  ))
</pre>
</div>
</details>

<p>
Finally,
</p>
<details>
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span style="color: #b58900;">local-set-key</span> (<span style="color: #b58900;">kbd</span> <span style="color: #2aa198;">"&lt;f6&gt;"</span>) 'interpret)
(<span style="color: #b58900;">local-set-key</span> (<span style="color: #b58900;">kbd</span> <span style="color: #2aa198;">"&lt;f7&gt;"</span>) 'show-code)
(<span style="color: #b58900;">local-set-key</span> (<span style="color: #b58900;">kbd</span> <span style="color: #2aa198;">"&lt;f8&gt;"</span>) 'frama-c)
(<span style="color: #b58900;">local-set-key</span> (<span style="color: #b58900;">kbd</span> <span style="color: #2aa198;">"&lt;f9&gt;"</span>) 'frama-c-no-gui)
</pre>
</div>
</details>

<p>
It is to be noted: I only know enough Elisp to get by.
</p>

<p>
Again: Hope you had fun!
</p>
</div>
</div>
<div class="taglist"><a href="https://alhassy.github.io/tags.html">Tags</a>: <a href="https://alhassy.github.io/tag-program-proving.html">program-proving</a> <a href="https://alhassy.github.io/tag-c.html">c</a> <a href="https://alhassy.github.io/tag-emacs.html">emacs</a> <a href="https://alhassy.github.io/tag-frama-c.html">frama-c</a> </div><div id="archive">
<a href="https://alhassy.github.io/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"><div id="archive">
  <a href="https://alhassy.github.io/archive.html">Other posts</a>
</div>
<center><a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/88x31.png" /></a><br /><span xmlns:dct="https://purl.org/dc/terms/" href="https://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">Life and Computing Science</span> by <a xmlns:cc="https://creativecommons.org/ns#" href="https://alhassy.github.io/" property="cc:attributionName" rel="cc:attributionURL">Musa Al-hassy</a> is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.</center>

<div id="archive"><a href="archive.html">Other posts</a></div>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
              /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
              var disqus_shortname = 'life-and-computing-science';
              /* * * DON'T EDIT BELOW THIS LINE * * */
              (function() {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                  })();
              </script>
              <noscript>Please enable JavaScript to view the
                  <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a></div>
</body>
</html>
